<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" >
	
<div class="row page-titles">
	<div class="col-12 align-self-center p-l-0 centerX">
		<h3 class="text-themecolor m-b-0 m-t-0 text-uppercase" th:text="${_header_}" ></h3>
	</div>
</div>

<div class="row">
	<div class="col-12">
		<form id="f-einvoice_mtt-crud" name="f-einvoice_mtt-crud" method="post" enctype="multipart/form-data">
			<div class="card">
				<div class="card-body">
					<div class="row text-danger m-b-10 fw-500 col-12" th:if="${messageError != null}">
						[[${messageError}]]
						<div class="col-12 p-0"><hr class="m-t-5 m-b-5"></div>
					</div>
					<div class="form-group row m-b-6" th:classappend="${messageError != null? 'none-pointer-event': ''}" >
						<div class="col-12 has-min-height-grid-prd m-b-15">
							<div id="grid"></div>
						</div>
				
					</div>
					<div class="row"><div class="col-12"><hr style="margin: 0 0 10px 0" /></div></div>
					<div class="form-group row m-b-6">
						<div class="col-6">
							<button type="button" data-action="back" title="Quay lại" 
								class="btn btn-sm btn-outline-secondary"><i class="mdi mdi-chevron-left"></i> <span class="d-none d-md-inline">Quay lại</span></button>
						</div>
						<div class="col-6 text-right">
							<button type="button" data-action="accept" class="btnadd btns btns-import__ses-1" title="Lưu thông tin" th:if="${null == messageError && ('CREATE' == _action_ || 'EDIT' == _action_ || 'COPY' == _action_)}" >
								<i class="mdi mdi-check-all"></i>
								<span class="d-none d-md-inline">Lưu thông tin</span>
							</button>
						
						</div>
					</div>
				</div>
			</div>
			<input type="hidden" name="_id" th:value="${_id}" >
		</form>
		<script type="text/javascript">
		transactionMain = '[[${transaction}]]';
		var rowsTMP = [];
		var vIsEdit = [[${_isedit_}]];
		_gridSub01 = $('#f-einvoice_mtt-crud').find('#grid');
		</script>
		
		<script type="text/javascript" th:if="${_action_ == 'CREATE' && false}"></script>
		<script type="text/javascript" th:if="${null == DSHHDVu}">
		$.each(new Array(5),
			function(n){
				rowsTMP.push({});
			}
		);
		</script>
		<script type="text/javascript" th:if="${null != DSHHDVu}">
		var strJson = '[[${DSHHDVu}]]';
		rowsTMP = [];
		try{
// 			var parser = new DOMParser;
// 			var dom = parser.parseFromString('<!doctype html><body>' + strJson, 'text/html');
// 			var decodedString = dom.body.textContent;
			
// 			rowsTMP = JSON.parse(decodedString);
			rowsTMP = decodeBase64UTF8ToObj(strJson);
		}catch(err){}
		</script>
	<!-- 	 <script th:src="@{/static/function/einvoice/einvoice-crud.js(v=1.37) }"></script>  -->
	<script type="text/javascript">
	/* for(var i=1; i<=lt; i++){
	$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(i))
	console.log(dblVATAmount);
} */
	</script>
	
		<script type="text/javascript" th:if="${null != userconfig_usd}">
		var usd_ = '[[${userconfig_usd}]]';
		
	</script>
		<script type="text/javascript" th:if="${null != userconfig_vnd}">
		var vnd_ = '[[${userconfig_vnd}]]';
	</script> 
	
	<script type="text/javascript">
	$(function(){
		if(vIsEdit){
			initInputNumber('#f-einvoice_mtt-crud .text-number');
			dateInputFormat($('#f-einvoice_mtt-crud').find('#ngay-lap'));
		}
		
		_gridSub01.kendoGrid({
			dataSource: {
				data: rowsTMP,
				pageSize: 999999,
				serverPaging: false,
				serverSorting: false,
	           	serverFiltering: false
			},
			selectable: !vIsEdit, scrollable: true, 
			sortable: false,
			filterable: false, resizable: true,
			serverSorting: false,
			pageable: {
				refresh: false,
				pageSizes: false,
				numeric: false,
				previousNext: false
			},
			dataBinding: function () {
	            record = (this.dataSource.page() - 1) * this.dataSource.pageSize();
	        },
			columns: [
				{field: 'STT', title: 'STT', width: '80px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">STT</a>',
	  				attributes: {'class': 'table-cell', style: 'text-align: right;'}, sortable: false, 
	  				headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
//	  				, template: '<input type="text" name="STT" value="' + '#: ++record #' + '" class="input-grid k-input form-control form-control-sm text-right input-grid-number" style="border: none;" >',
	  				, template: '#= window.setTemplateForGrid("STT", data) #'
	  				
	  			},

				{field: 'MSHDon', title: '', width: '130px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mẫu số, ký hiệu hóa đơn</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},

				},
				{field: 'SHDon', title: '', width: '70px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Số hóa đơn</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},

				},			
				{field: 'NLap', title: '', width: '80px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày hóa đơn</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},

				},
				{field: 'MaCQT', title: '', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã cơ quan thuế</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},

				},
				{field: 'TTTToan', title: '', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng tiền thanh toán</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},		
				},

		
				{field: 'Status', title: '', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Trạng thái cơ quan thuế</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
				},
			],
			dataBound: function(e) {
	        	
				initInputNumber('#f-einvoice_mtt-crud #grid .input-grid-number');	
				autoCompleteProducts(_gridSub01.find('tbody[role="rowgroup"]').find('tr[data-uid]').find('input[name="ProductName"]'), function(e){
				
					var $tr = _gridSub01.find('tbody[role="rowgroup"]').find('tr:eq(' + rowSelect + ')');
					$tr.find('input[name="ProductCode"]').val(e.Code);
					$tr.find('input[name="Unit"]').val(e.Unit);
					$tr.find('input[name="Price"]').val(e.Price);
					$tr.find('select[name="VATRate"]').val(e.VatRate);
					$tr.find('input[name="Quantity"]').trigger('keyup');
				});

				/*ACTION IN GRID*/
				_gridSub01.find('tbody[role="rowgroup"]').find('tr[data-uid]').undelegate('i[data-sub-action]', 'click');
				_gridSub01.find('tbody[role="rowgroup"]').find('tr[data-uid]').delegate('i[data-sub-action]', 'click', function(e){
					event.preventDefault();/*event.stopPropagation();*/
					
					var $obj = $(this);
					var $tr = $obj.closest('tr');
					var subAction = $obj.attr('data-sub-action');

					var indexRow = $tr.index();
					switch (subAction) {
					case 'delete':
						alertConfirm('Bạn có muốn xóa dòng ' + (indexRow + 1) + ' không?',
							function(e){
								var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
								if(indexRow < objDataJson.length && indexRow > -1){
									objDataJson.splice(indexRow, 1);
									_gridSub01.data("kendoGrid").dataSource.data(objDataJson);	
									setSTTinGrid();
									calcSTTInGrid();
								}
								calcTotalAmount();
							},
							function(e){}
						)
						break;
					default:
						break;
					}
				});
				
				_gridSub01.find('tbody[role="rowgroup"]').undelegate('input[type="checkbox"][name="chkSTT"]', 'click');
				_gridSub01.find('tbody[role="rowgroup"]').delegate('input[type="checkbox"][name="chkSTT"]', 'click', function(e){
					setSTTinGrid();
					calcAmountInGrid($(this));
				});
				
				_gridSub01.find('tbody[role="rowgroup"]').undelegate('.input-grid-number, .input-grid-vatrate, .input-grid-feature, select[name="VATRate"], select[name="Feature"], input[name="ProductName"], input[name="SLo"], input[name="HanSD"], input[name="ProductCode"], input[name="Unit"]', 'change');
				_gridSub01.find('tbody[role="rowgroup"]').delegate('.input-grid-number, .input-grid-vatrate, .input-grid-feature, select[name="VATRate"], select[name="Feature"], input[name="ProductName"], input[name="SLo"], input[name="HanSD"], input[name="ProductCode"], input[name="Unit"]', 'change', function(e){
					calcAmountInGrid($(this));
					calcTotalAmount();
				});
				
				_gridSub01.find('tbody[role="rowgroup"]').undelegate('.input-grid-number, .input-grid-vatrate, .input-grid-feature', 'keyup');
				_gridSub01.find('tbody[role="rowgroup"]').delegate('.input-grid-number, .input-grid-vatrate, .input-grid-feature', 'keyup', function(e){
					var code = e.keyCode || e.which;
//					console.log(code)
					//9: Tab
					//16: Shift Tab
					if(code == 9 || code == 16) return;
					calcAmountInGrid($(this));
					calcTotalAmount();
				});
				/*END - ACTION IN GRID*/
				
			}
	        
		});
		
		setReadonlyTGia();
		$('#f-einvoice_mtt-crud').find('#loai-tien-tt').change(function(e){
			event.preventDefault();/*event.stopPropagation();*/
			$('#f-einvoice_mtt-crud').find('#ty-gia').val('1');
			setReadonlyTGia();
			calcTienQuyDoi();
		});
		
		$('#f-einvoice_mtt-crud').undelegate('#ty-gia, #tong-tien-da-co-thue', 'keyup');
		$('#f-einvoice_mtt-crud').delegate('#ty-gia, #tong-tien-da-co-thue', 'keyup', function(e){
			var code = e.keyCode || e.which;
//			console.log(code)
			//9: Tab
			//16: Shift Tab
			if(code == 9 || code == 16) return;
			calcTienQuyDoi();
		});
		

		$('#f-einvoice_mtt-crud').find('button[data-action]').click(function (event) {
			event.preventDefault();/*event.stopPropagation();*/
			var dataAction = $(this).data('action');
			
			var $obj = $(this);
			var objDataSend = null;
			
			switch (dataAction) {
			case 'add-to-grid':
				var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
				objDataJson.push({});
				_gridSub01.data("kendoGrid").dataSource.data(objDataJson);
				break;
			case 'back':
				$('#divMainContent').show();
				$('#divSubContent').hide(function(){$(this).empty();});
				try{
					if($('#f-einvoice_mtt').find('#grid').length > 0)
						$('#f-einvoice_mtt').find('#grid').data("kendoGrid").dataSource.read();
				}catch(err){}
				break;
		
			case 'accept':
				objDataSend = getDataToSave();
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/' + transactionMain + '/check-data-save',
					data: objDataSend,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res.errorCode == 0) {
							var responseData = res.responseData;
							
							var confirmText = responseData['CONFIRM'];
							tokenTransaction = responseData['TOKEN'];
							
							objDataSend['tokenTransaction'] = tokenTransaction;
							alertConfirm(confirmText,
								function(e){
									$.ajax({
										type: "POST",
										datatype: "json",
										url: ROOT_PATH + '/main/' + transactionMain + '/save-data',
										data: objDataSend,
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
											if(res) {
												if(res.errorCode == 0) {
													$('#f-einvoice_mtt-crud').find('button[data-action="back"]').trigger('click');
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});
								},
								function(e){}
							);
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
						}
					},
					error:function (xhr, ajaxOptions, thrownError){
						$obj.prop('disabled', false);
						alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
			            hideLoading();
			        }
				});
				break;
			case 'kh-refresh':
				$('#f-einvoice_mtt-crud').find('#kh-mst,#kh-makhachhang,#kh-ho-ten-nguoi-mua,#kh-ten-don-vi').val('');
				$('#f-einvoice_mtt-crud').find('#kh-dia-chi,#kh-email,#kh-emailcc,#kh-so-dt,#kh-so-tk,#kh-tk-tai-ngan-hang').val('');
				break;
			case 'kh-check-mst':
				
				var dataMST = {};				
				dataMST['mst'] = $('#f-einvoice_mtt-crud').find('#kh-mst').val();
				var mst = dataMST['mst'];			
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/einvoice_check_mst/check-mst',
					data: dataMST,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res) {
							if(res.errorCode == 0) {
								
								if(mst.startsWith('CN') || mst.length < 10)
									mst = '';
								var responseData = res.responseData;								
								$('#f-einvoice_mtt-crud').find('#kh-mst').val(mst);
								$('#f-einvoice_mtt-crud').find('#kh-makhachhang').val(responseData['ma_kh']);
								$('#f-einvoice_mtt-crud').find('#kh-ten-don-vi').val(responseData['tendv']);
								$('#f-einvoice_mtt-crud').find('#kh-ho-ten-nguoi-mua').val(responseData['hvtnmh']);
								$('#f-einvoice_mtt-crud').find('#kh-dia-chi').val(responseData['dchi']);
								$('#f-einvoice_mtt-crud').find('#kh-email').val(responseData['email']);
								$('#f-einvoice_mtt-crud').find('#kh-emailcc').val(responseData['emailcc']);
								$('#f-einvoice_mtt-crud').find('#kh-so-dt').val(responseData['sdt']);
								$('#f-einvoice_mtt-crud').find('#kh-so-tk').val(responseData['stk']);
								$('#f-einvoice_mtt-crud').find('#kh-tk-tai-ngan-hang').val(responseData['tnh']);
							}else{
								alertDLSuccess("Không tìm thấy khách hàng", function(){});
								$('#f-einvoice_mtt-crud').find('#kh-makhachhang,#kh-ho-ten-nguoi-mua,#kh-ten-don-vi').val('');
								$('#f-einvoice_mtt-crud').find('#kh-dia-chi,#kh-email,#kh-emailcc,#kh-so-dt,#kh-so-tk,#kh-tk-tai-ngan-hang').val('');
							}
						}else{
							alertDLSuccess('unknown error!!!', function(){});
							hideLoading();
						}
					},
					error:function (xhr, ajaxOptions, thrownError){
						alertDLSuccess("Không tìm thấy khách hàng", function(){});
			            hideLoading();
			        }
				});
				break;	
				
				case 'kh-add':				
				var dataMST = {};				
				dataMST['mst'] = $('#f-einvoice_mtt-crud').find('#kh-mst').val();	
				dataMST['kh-makhachhang'] = $('#f-einvoice_mtt-crud').find('#kh-makhachhang').val();
				dataMST['kh-ho-ten-nguoi-mua'] = $('#f-einvoice_mtt-crud').find('#kh-ho-ten-nguoi-mua').val();
				dataMST['kh-ten-don-vi'] = $('#f-einvoice_mtt-crud').find('#kh-ten-don-vi').val();
				dataMST['kh-dia-chi'] = $('#f-einvoice_mtt-crud').find('#kh-dia-chi').val();
				dataMST['kh-email'] = $('#f-einvoice_mtt-crud').find('#kh-email').val();
				dataMST['kh-cancuoccongdan'] = $('#f-einvoice_mtt-crud').find('#kh-cancuoccongdan').val();
				dataMST['kh-so-dt'] = $('#f-einvoice_mtt-crud').find('#kh-so-dt').val();
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/einvoice_save_nmua/save-nmua',
					data: dataMST,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res) {
							if(res.errorCode == 0) {
								alertDLSuccess("Cập nhật thành công", function(){});	 						
							}else{
								alertDLSuccess("Không thành công", function(){});								
							}
						}else{
							alertDLSuccess('unknown error!!!', function(){});
							hideLoading();
						}
					},
					error:function (xhr, ajaxOptions, thrownError){
						alertDLSuccess("Không thành công", function(){});
			            hideLoading();
			        }
				});
				break;	
			case 'kh_search':
				objDataSend = {};
				showPopupWithURLAndData(ROOT_PATH + '/common/show-search-customer', objDataSend, false, function(e){
					if('object' ==jQuery.type(e)){
						var mst = e['TaxCode'] == null? '': e['TaxCode'];
						if(mst.startsWith('CN') || mst.length < 10)
							mst = '';
						$('#f-einvoice_mtt-crud').find('#kh-mst').val(mst);
						$('#f-einvoice_mtt-crud').find('#kh-makhachhang').val(e['CustomerCode'] == null? '': e['CustomerCode']);
						$('#f-einvoice_mtt-crud').find('#kh-ho-ten-nguoi-mua').val(e['CustomerName'] == null? '': e['CustomerName']);
						$('#f-einvoice_mtt-crud').find('#kh-ten-don-vi').val(e['CompanyName'] == null? '': e['CompanyName']);
						$('#f-einvoice_mtt-crud').find('#kh-dia-chi').val(e['Address'] == null? '': e['Address']);
						$('#f-einvoice_mtt-crud').find('#kh-email').val(e['Email'] == null? '': e['Email']);
						$('#f-einvoice_mtt-crud').find('#kh-emailcc').val(e['EmailCC'] == null? '': e['EmailCC']);
						$('#f-einvoice_mtt-crud').find('#kh-so-dt').val(e['Phone'] == null? '': e['Phone']);
						$('#f-einvoice_mtt-crud').find('#kh-so-tk').val(e['AccountNumber'] == null? '': e['AccountNumber']);
						$('#f-einvoice_mtt-crud').find('#kh-tk-tai-ngan-hang').val(e['AccountBankName'] == null? '': e['AccountBankName']);
					}
				});
				break;
			case 'kh_searchol':
				var dataMST = {};				
				dataMST['mst'] = $('#f-einvoice_mtt-crud').find('#kh-mst').val();	
		       // objDataSend =$('#f-einvoice_mtt-crud').find('#kh-mst').val();
		        $.ajax({
		          type: "POST",
		          datatype: "json",
		      	url: ROOT_PATH + '/main/einvoice_online_mst/online-mst',
				data: dataMST,
		          beforeSend: function(req) {
		            initAjaxJsonRequest(req);
		                showLoading();
		          },
		          success:function(res) {
		      
		            hideLoading();
		            if(res) {		           
		              if(res.errorCode == 0) {
		            	var responseData = res.responseData;	  
		                $('#f-einvoice_mtt-crud').find('#kh-ten-don-vi').val(res.responseData['ten_cong_ty']);
		                $('#f-einvoice_mtt-crud').find('#kh-dia-chi').val(res.responseData['dia_chi']);
		               /*  $('#f-einvoice_mtt-crud').find('#kh-ho-ten-nguoi-mua').val(res.responseData['ChuSoHuu']); */
		              }else{
		            		$('#f-einvoice_mtt-crud').find('#kh-makhachhang,#kh-ho-ten-nguoi-mua,#kh-ten-don-vi').val('');
		    				$('#f-einvoice_mtt-crud').find('#kh-dia-chi,#kh-email,#kh-emailcc,#kh-so-dt,#kh-so-tk,#kh-tk-tai-ngan-hang').val('');
		                alertDLSuccess("Không tìm thấy thông tin khách hàng!!!");
		              }
		            }else{
		            	$('#f-einvoice_mtt-crud').find('#kh-makhachhang,#kh-ho-ten-nguoi-mua,#kh-ten-don-vi').val('');
						$('#f-einvoice_mtt-crud').find('#kh-dia-chi,#kh-email,#kh-emailcc,#kh-so-dt,#kh-so-tk,#kh-tk-tai-ngan-hang').val('');
		              alertDLSuccess('unknown error!!!');
		              hideLoading();
		            }
		          },
		          error:function (xhr, ajaxOptions, thrownError){
		            alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		                  hideLoading();
		              }
		        });
		        break;
				
			default:
				break;
			}
		});
		
	});

	function setTemplateForGrid(key, data){
		if(!vIsEdit) return data[key] == null? '': data[key];
		
		var text = '';
		if('func' == key){
			text = '<div>';
			text += '<i class="mdi mdi-close-box fs-25 text-black c-pointer" data-sub-action="delete"></i>';
			text += '</div>';
			return text;
		}
		
		var isReadonlyOrDisabled = false;
		var feature = data['Feature'];
		
		var _valTmp = '';
		text = '<div class="form-row m-l-1 m-r-1">';
		switch (key) {
		case 'Quantity':
		case 'Price':
		case 'Total':
		case 'VATAmount':
		case 'Amount':
			text = '<input type="text" name="' + key + '" value="' + (null == data[key]? '': data[key]) + '" class="input-grid k-input form-control form-control-sm text-right input-grid-number" ' + (('2' == feature)? ' readonly="readonly" ': '') + ' >';	// || '4' == feature
			break;
		case 'VATRate':
			_valTmp = null == data[key]? '': data[key];
			if('' == _valTmp) _valTmp = '10';
			var objVAT1 = {'0': ' ','1': '0%', '5': '5%', '7': '10%x70%', '8': '8%', '10': '10%', '-1': 'KCT', '-2': 'KKKNT'};
	
			text += '<select class="input-grid form-control form-control-sm input-grid-vatrate"  name="' + key + '" style="height: 100%;" ' + (('2' == feature)? ' disabled="disabled" ': '') + '>';	/*|| '4' == feature*/
			$.each(objVAT1, function(k, v){
				text += '<option value="' + k + '" ' + (k == _valTmp? 'selected="selected" ': '') + '>' + v + '</option>';
			});
			text += '</select>';
			break;
		case 'Feature':
			_valTmp = null == data[key]? '': data[key];
			if('' == _valTmp) _valTmp = '';
			
			text += '<select class="input-grid form-control form-control-sm input-grid-feature" name="' + key + '" style="height: 100%;" >';
			$.each(objFeature, function(k, v){
				text += '<option value="' + k + '" ' + (k == _valTmp? 'selected="selected" ': '') + ' >' + v + '</option>';
			});
			text += '</select>';
			break;
		case 'STT':
			text += '<div class="input-group">';
			text += '	<div class="input-group-prepend">';		
			text += '		<label class="custom-control custom-checkbox">';
			text += '			<input type="checkbox" name="chkSTT" class="custom-control-input" ' + (null != data[key] && '' != data[key]? 'checked="checked"': '') + ' >';
			text += '			<span class="custom-control-label">&nbsp;</span>';
			text += '		</label>';		
			text += '	</div>';
			text += '	<input type="text" name="' + key + '" value="' + (null == data[key]? '': data[key]) + '" class="input-grid k-input form-control form-control-sm text-right" style="border: none;" >';
			text += '</div>';
			break;
		default:
			text = '<input type="text" name="' + key + '" value="' + (null == data[key]? '': data[key]) + '" class="input-grid k-input form-control form-control-sm" >';
			break;
		}
		text += '</div>';
		return text;
	}

	function calcAmountInGrid($obj){
		
		var $tr = $obj.closest('tr');
		var _name = $obj.prop('name');
		var _val = '';
		var _numeral = null;
		var loai_tien_tt = $('#f-einvoice_mtt-crud').find('#loai-tien-tt').val();
		
		var dblQuantity = 0;
		var dblPrice = 0;
		var dblTotal = 0;
		var dblVATRate = 0;
		var dblVATAmount = 0;
		var dblAmount = 0;
		var VND_ = parseInt(vnd_, 10);
	
		var USD_ = parseInt(usd_, 10);
		;
		switch (_name) {
		case 'chkSTT':
//			if('' == _val){
//				$tr.find('input[type="checkbox"][name="chkSTT"]').prop('checked', false);
//			}else{
//				$tr.find('input[type="checkbox"][name="chkSTT"]').prop('checked', true);
//			}
			break;
		case 'Quantity':
		case 'Price':
			_numeral = numeral($tr.find('input[name="Quantity"]').val());
			dblQuantity = _numeral == null? 0: _numeral.value();
			_numeral = numeral($tr.find('input[name="Price"]').val());
			dblPrice = _numeral == null? 0: _numeral.value();
			dblTotal = dblQuantity * dblPrice;
	
	
			if(loai_tien_tt=="VND"){		
				$tr.find('input[name="Total"]').val(dblTotal.toFixed(4))
				FormatCurrency($tr.find('input[name="Total"]')[0], loai_tien_tt);
							
				_numeral = numeral($tr.find('select[name="VATRate"]').val());
				dblVATRate = _numeral == null? 0: _numeral.value();
				if(dblVATRate < 0) dblVATRate = 0;
				if(dblVATRate == 1) dblVATRate = 0;			
				dblVATAmount = dblTotal * dblVATRate / 100;
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(2))
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(1))
				FormatCurrency($tr.find('input[name="VATAmount"]')[0], loai_tien_tt);
				break;
				}
			if(loai_tien_tt=="USD"){		
				$tr.find('input[name="Total"]').val(dblTotal.toFixed(USD_))	
					FormatCurrency($tr.find('input[name="Total"]')[0], loai_tien_tt);
				_numeral = numeral($tr.find('select[name="VATRate"]').val());
				dblVATRate = _numeral == null? 0: _numeral.value();
				if(dblVATRate < 0) dblVATRate = 0;
				if(dblVATRate == 1) dblVATRate = 0;		
				dblVATAmount = dblTotal * dblVATRate / 100;
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(USD_))
				break;
				}
	case 'Total':
//			$tr.find('input[name="Quantity"],input[name="Price"]').val('');
			
			_numeral = numeral($tr.find('input[name="Total"]').val());
			dblTotal = _numeral == null? 0: _numeral.value();
			
			_numeral = numeral($tr.find('select[name="VATRate"]').val());
			dblVATRate = _numeral == null? 0: _numeral.value();
			if(dblVATRate < 0) dblVATRate = 0;
			if(dblVATRate == 1) dblVATRate = 0;
			dblVATAmount = dblTotal * dblVATRate / 100;
//			$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(4));
			if(loai_tien_tt=="VND"){	
			
			/* 	$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(2))
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(1))
				FormatCurrency($tr.find('input[name="VATAmount"]')[0], loai_tien_tt);	 */
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(USD_))
				break;
			}
			if(loai_tien_tt=="USD"){	
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(VND_))
				break;
			}

	
		
		case 'VATRate':
			_numeral = numeral($tr.find('input[name="Total"]').val());
			
			dblTotal = _numeral == null? 0: _numeral.value();
			
			_numeral = numeral($tr.find('select[name="VATRate"]').val());
			dblVATRate = _numeral == null? 0: _numeral.value();
			if(dblVATRate < 0) dblVATRate = 0;
			if(dblVATRate == 1) dblVATRate = 0
			dblVATAmount = dblTotal * dblVATRate / 100;
//			$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(4));
			if(loai_tien_tt=="VND"){	
				//$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(2))
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(1))
				//FormatCurrency($tr.find('input[name="VATAmount"]')[0], loai_tien_tt);	
				break;
			}
			if(loai_tien_tt=="USD"){	
				$tr.find('input[name="VATAmount"]').val(dblVATAmount.toFixed(USD_))
				break;
			}


		case 'VATAmount':
			_numeral = numeral($tr.find('input[name="Total"]').val());
			dblTotal = _numeral == null? 0: _numeral.value();
			
			_numeral = numeral($tr.find('input[name="VATAmount"]').val());
			dblVATAmount = _numeral == null? 0: _numeral.value();
			break;
		case 'Feature':
			$tr.find('input[name="Unit"], input[name="Quantity"], input[name="Price"], input[name="Total"], input[name="VATRate"], input[name="VATAmount"], input[name="Amount"]').prop('readonly', false);
			$tr.find('select[name="VATRate"]').prop('disabled', false);
			$tr.find('select[name="VATRate"]').val('0');
			_val = $obj.val();
			switch (_val) {
			case '1':
				$tr.find('input[name="VATAmount"], input[name="Amount"]').val('');
				break;
			case '2':
				$tr.find('input[name="Price"]').val('');
				$tr.find('input[name="Total"], select[name="VATRate"], input[name="VATAmount"]').val('');
				
				$tr.find('input[name="Price"], input[name="Total"], input[name="VATAmount"], input[name="Amount"]').prop('readonly', true);
				$tr.find('select[name="VATRate"]').prop('disabled', true);
				break;
			case '4':
				$tr.find('input[name="Unit"], input[name="Quantity"], input[name="Price"]').val('');
				$tr.find('input[name="Total"], select[name="VATRate"], input[name="VATAmount"]').val('');
				$tr.find('select[name="VATRate"]').val('0');
//				$tr.find('input[name="Unit"], input[name="Quantity"], input[name="Price"], input[name="Total"], input[name="VATRate"], input[name="VATAmount"], input[name="Amount"]').prop('readonly', true);
//				$tr.find('select[name="VATRate"]').prop('disabled', true);
				
				break;
			default:
				break;
			}
			break;
		case 'ProductName':
			_val = $obj.val();
			if('' == _val){
				$tr.find('input[type="checkbox"][name="chkSTT"]').prop('checked', false);
			}else{
				$tr.find('input[type="checkbox"][name="chkSTT"]').prop('checked', true);
			}
			setSTTinGrid();
			break;
		default:
			break;
		}
		
		_numeral = numeral($tr.find('input[name="Total"]').val());
		dblTotal = _numeral == null? 0: _numeral.value();
		_numeral = numeral($tr.find('input[name="VATAmount"]').val());
		dblVATAmount = _numeral == null? 0: _numeral.value();
		
		dblAmount = dblTotal + dblVATAmount;
		$tr.find('input[name="Amount"]').val(dblAmount.toFixed(4))
		FormatCurrency($tr.find('input[name="Amount"]')[0], loai_tien_tt);
		
		/*LAY THONG TIN UPDATE LAI DATASOURCE*/
		var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
		try{
			var indexRow = $tr.index();
			var rowData = objDataJson[indexRow];
			
			rowData['STT'] = $tr.find('input[name="STT"]').val();
			rowData['ProductName'] = $tr.find('input[name="ProductName"]').val();
			rowData['ProductCode'] = $tr.find('input[name="ProductCode"]').val();		
			rowData['Unit'] = $tr.find('input[name="Unit"]').val();
			rowData['Quantity'] = $tr.find('input[name="Quantity"]').val();
			rowData['Price'] = $tr.find('input[name="Price"]').val();
			rowData['Total'] = $tr.find('input[name="Total"]').val();
			rowData['VATRate'] = $tr.find('select[name="VATRate"]').val();
			rowData['VATAmount'] = $tr.find('input[name="VATAmount"]').val();
			rowData['Amount'] = $tr.find('input[name="Amount"]').val();
			rowData['Feature'] = $tr.find('select[name="Feature"]').val();
			
			_gridSub01.data("kendoGrid").dataSource.data()[indexRow] = rowData;
		}catch(err){
			console.log(err);
		}
	}

	function setSTTinGrid(){
		var $tr = null;
		var stt = 0;
		_gridSub01.find('table[role="grid"]').find('tbody[role="rowgroup"]').find('tr').each(function(i, v) {
			$tr = $(this);
			if($tr.find('input[type="checkbox"][name="chkSTT"]').prop('checked')
				&& $tr.find('input[type="text"][name="ProductName"]').val() != ''
			){
				$tr.find('input[type="text"][name="STT"]').val(++stt);
			}else{
				$tr.find('input[type="text"][name="STT"]').val('');
			}
		});
	}

	function calcTotalAmount(){
		var loai_tien_tt = $('#f-einvoice_mtt-crud').find('#loai-tien-tt').val();
		var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
		
		/*TINH TIEN TRUOC THUE - TIEN THUE - TONG TIEN SAU THUE*/
		var sumAmount = 0;
		var sumAmountVAT = 0;
		var sumAmountAfterTax = 0;
		var tmp = '';
		var tmp2 = '';
		
//		var VND_ = parseInt(vnd_, 10);
		var USD_ = parseInt(usd_, 10);
		jQuery.each(objDataJson, function(index, item) {
			tmp = item['ProductName'] == null? '': item['ProductName'].trim();
			if('' != tmp){
				_val = item['Feature'] == null? '': item['Feature'].trim();
				_numeral = numeral(item['Total']);
				if(_val == '3'){ //CK
					sumAmount -= _numeral.value() == null? 0: _numeral.value();
				}else{
					sumAmount += _numeral.value() == null? 0: _numeral.value();
				}
				
				switch (_val) {
				case '4':		//GHI CHU - KHONG XU LY TIEN
					break;
				case '3':		//CK: TRU TIEN THUE VA TONG TIEN
					_numeral = numeral(item['VATAmount']);
					sumAmountVAT -= _numeral.value() == null? 0: _numeral.value();
					_numeral = numeral(item['Amount']);
					sumAmountAfterTax -= _numeral.value() == null? 0: _numeral.value();
					break;
				case '2':		//KM: CHI CONG TONG TIEN
					break;
				default:
					_numeral = numeral(item['VATAmount']);
					sumAmountVAT += _numeral.value() == null? 0: _numeral.value();
					_numeral = numeral(item['Amount']);
					sumAmountAfterTax += _numeral.value() == null? 0: _numeral.value();
					break;
				}
			}
		});
		
		if(loai_tien_tt=="VND"){
			$('#f-einvoice_mtt-crud').find('#tong-tien-truoc-thue').val(sumAmount.toFixed(4))
			FormatCurrency($('#f-einvoice_mtt-crud').find('#tong-tien-truoc-thue')[0], loai_tien_tt);
			$('#f-einvoice_mtt-crud').find('#tong-tien-thue-gtgt').val(sumAmountVAT.toFixed(1))
			FormatCurrency($('#f-einvoice_mtt-crud').find('#tong-tien-thue-gtgt')[0], loai_tien_tt);
			$('#f-einvoice_mtt-crud').find('#tong-tien-da-co-thue').val(sumAmountAfterTax.toFixed(4))
			FormatCurrency($('#f-einvoice_mtt-crud').find('#tong-tien-da-co-thue')[0], loai_tien_tt);
			
			$('#f-einvoice_mtt-crud').find('#tien-bang-chu').val(readMoneyInWords(Math.abs(sumAmountAfterTax.toFixed(4)), loai_tien_tt));
			
			calcTienQuyDoi();
		}
		if(loai_tien_tt=="USD"){
			$('#f-einvoice_mtt-crud').find('#tong-tien-truoc-thue').val(sumAmount.toFixed(USD_))
		
			$('#f-einvoice_mtt-crud').find('#tong-tien-thue-gtgt').val(sumAmountVAT.toFixed(USD_))
		
			$('#f-einvoice_mtt-crud').find('#tong-tien-da-co-thue').val(sumAmountAfterTax.toFixed(USD_))
			
			$('#f-einvoice_mtt-crud').find('#tien-bang-chu').val(readMoneyInWords(Math.abs(sumAmountAfterTax.toFixed(4)), loai_tien_tt));
			
			calcTienQuyDoi();
		}	
	}

	function getDataToSave(){
		var dataPost = {};
		
		dataPost['_id'] = $('#f-einvoice_mtt-crud').find('input[name="_id"]').val();
		dataPost['mau-so-hdon'] = $('#f-einvoice_mtt-crud').find('#mau-so-hdon').val();	
		
		dataPost['loai-hd'] = $('#f-einvoice_mtt-crud').find('#loai-hd').val();		
		dataPost['loai-hd-text'] = $('#f-einvoice_mtt-crud').find('#loai-hd').find('option:selected').text();
		
		dataPost['ten-loai-hd'] = $('#f-einvoice_mtt-crud').find('#ten-loai-hd').val();
		dataPost['hinh-thuc-thanh-toan'] = $('#f-einvoice_mtt-crud').find('#hinh-thuc-thanh-toan').val();
		dataPost['hinh-thuc-thanh-toan-text'] = $('#f-einvoice_mtt-crud').find('#hinh-thuc-thanh-toan').find('option:selected').text();
		dataPost['ngay-lap'] = $('#f-einvoice_mtt-crud').find('#ngay-lap').val();
		dataPost['_id_tt_dc'] = $('#f-einvoice_mtt-crud').find('input[name="_id_tt_dc"]').length == 0? '': $('#f-einvoice_mtt-crud').find('input[name="_id_tt_dc"]').val();
		dataPost['ma-hd'] = $('#f-einvoice_mtt-crud').find('#ma-hd').val();
		
		dataPost['kh-mst'] = $('#f-einvoice_mtt-crud').find('#kh-mst').val();
		dataPost['kh-makhachhang'] = $('#f-einvoice_mtt-crud').find('#kh-makhachhang').val();
		
		dataPost['kh-cancuoccongdan'] = $('#f-einvoice_mtt-crud').find('#kh-cancuoccongdan').val();
		
		dataPost['kh-ho-ten-nguoi-mua'] = $('#f-einvoice_mtt-crud').find('#kh-ho-ten-nguoi-mua').val();
		dataPost['kh-ten-don-vi'] = $('#f-einvoice_mtt-crud').find('#kh-ten-don-vi').val();
		dataPost['kh-dia-chi'] = $('#f-einvoice_mtt-crud').find('#kh-dia-chi').val();
		dataPost['kh-email'] = $('#f-einvoice_mtt-crud').find('#kh-email').val();
	
		dataPost['kh-so-dt'] = $('#f-einvoice_mtt-crud').find('#kh-so-dt').val();
		dataPost['kh-so-tk'] = $('#f-einvoice_mtt-crud').find('#kh-so-tk').val();
		dataPost['kh-tk-tai-ngan-hang'] = $('#f-einvoice_mtt-crud').find('#kh-tk-tai-ngan-hang').val();
		
		dataPost['tong-tien-truoc-thue'] = $('#f-einvoice_mtt-crud').find('#tong-tien-truoc-thue').val();
		dataPost['loai-tien-tt'] = $('#f-einvoice_mtt-crud').find('#loai-tien-tt').val();
		dataPost['ty-gia'] = $('#f-einvoice_mtt-crud').find('#ty-gia').val();
		dataPost['tong-tien-thue-gtgt'] = $('#f-einvoice_mtt-crud').find('#tong-tien-thue-gtgt').val();
		dataPost['tong-tien-da-co-thue'] = $('#f-einvoice_mtt-crud').find('#tong-tien-da-co-thue').val();
		dataPost['tong-tien-quy-doi'] = $('#f-einvoice_mtt-crud').find('#tong-tien-quy-doi').val();
		
		dataPost['tien-bang-chu'] = $('#f-einvoice_mtt-crud').find('#tien-bang-chu').val();

		var arrRows = [];
		var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
		jQuery.each(objDataJson, function(index, item) {
			tmp = item['ProductName'] == null? '': item['ProductName'].trim();
			if('' != tmp){
				arrRows.push(item);
			}
		});
		dataPost['ds-san-pham'] = encodeObjJsonBase64UTF8(arrRows);
		
//		var arrRows = [];
//		var obj = null;
//		var $tr = null;
//		_gridSub01.find('table[role="grid"]').find('tbody[role="rowgroup"]').find('tr').each(function(i, v) {
//			$tr = $(v);
//		    obj = {};
//		    obj['STT'] = $tr.find('input[name="STT"]').val();
//		    obj['ProductName'] = $tr.find('input[name="ProductName"]').val();
//		    obj['Unit'] = $tr.find('input[name="Unit"]').val();
//		    obj['Quantity'] = $tr.find('input[name="Quantity"]').val();
//		    obj['Price'] = $tr.find('input[name="Price"]').val();
//		    obj['Total'] = $tr.find('input[name="Total"]').val();
//		    obj['VATRate'] = $tr.find('select[name="VATRate"]').val();
//		    obj['VATAmount'] = $tr.find('input[name="VATAmount"]').val();
//		    obj['Amount'] = $tr.find('input[name="Amount"]').val();
//		    obj['Feature'] = $tr.find('select[name="Feature"]').val();
//		    arrRows.push(obj)
//		});	
//		dataPost['ds-san-pham'] = encodeObjJsonBase64UTF8(arrRows);
		
		return dataPost;
	}

	function setReadonlyTGia(){
		
		
		$('#f-einvoice_mtt-crud').find('#ty-gia').prop('readonly', true);
		$('#f-einvoice_mtt-crud').find('div.quidoingoaite').addClass('d-none');
		$('#f-einvoice_mtt-crud').find('#tong-tien-quy-doi').prop('readonly', true);
		
		var isAccept = $('#f-einvoice_mtt-crud').find('button[data-action="accept"]').length > 0;
		var loaiTien = $('#f-einvoice_mtt-crud').find('#loai-tien-tt').val();
		if(loaiTien == '') loaiTien = 'VND';
		
		if(isAccept && loaiTien != 'VND'){
			$('#f-einvoice_mtt-crud').find('#ty-gia').prop('readonly', false);
			$('#f-einvoice_mtt-crud').find('#tong-tien-quy-doi').prop('readonly', false);
		}
		if(loaiTien != 'VND'){
			$('#f-einvoice_mtt-crud').find('div.quidoingoaite').removeClass('d-none');
		}
			
	}

	function calcSTTInGrid(){
		var $tr = null;
		_gridSub01.find('table[role="grid"]').find('tbody[role="rowgroup"]').find('tr').each(function(i, v) {
			$tr = $(this);
			/*LAY THONG TIN UPDATE LAI DATASOURCE*/
			var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
			try{
				var indexRow = $tr.index();
				var rowData = objDataJson[indexRow];
				
				rowData['STT'] = $tr.find('input[name="STT"]').val();
				rowData['ProductName'] = $tr.find('input[name="ProductName"]').val();
				rowData['ProductCode'] = $tr.find('input[name="ProductCode"]').val();
				rowData['Unit'] = $tr.find('input[name="Unit"]').val();
				rowData['Quantity'] = $tr.find('input[name="Quantity"]').val();
				rowData['Price'] = $tr.find('input[name="Price"]').val();
				rowData['Total'] = $tr.find('input[name="Total"]').val();
				rowData['Amount'] = $tr.find('input[name="Amount"]').val();
				rowData['Feature'] = $tr.find('select[name="Feature"]').val();
				
				_gridSub01.data("kendoGrid").dataSource.data()[indexRow] = rowData;
			}catch(err){
				console.log(err);
			}
			});
		
	}
	function calcTienQuyDoi(){
		var sumAmountAfterTax = 0;
		var tyGia = 0;
		var tienQuiDoi = 0;
		var $numeral = null;
		
		$numeral = numeral($('#f-einvoice_mtt-crud').find('#ty-gia').val());
		tyGia = $numeral.value() == null? 1: $numeral.value();
		$numeral = numeral($('#f-einvoice_mtt-crud').find('#tong-tien-da-co-thue').val());
		sumAmountAfterTax = $numeral.value() == null? 0: $numeral.value();
		
		tienQuiDoi = tyGia * sumAmountAfterTax;
		$('#f-einvoice_mtt-crud').find('#tong-tien-quy-doi').val(tienQuiDoi.toFixed(4))
		FormatCurrency($('#f-einvoice_mtt-crud').find('#tong-tien-quy-doi')[0], 'VND');
	}
	</script>
	</div>
</div>

</html>