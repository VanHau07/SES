<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout/layout-main}">
<body>
	<th:block layout:fragment="content">
		<div class="row page-titles">
		<style>
				.text-red{
				color: red;
				}

		</style>
			<div class="col-md-12 col-12 align-self-center p-l-0">
				<h3 class="text-themecolor m-b-0 m-t-0 text-uppercase">Dữ liệu hóa đơn điện tử từ máy tính tiền gửi cơ quan thuế</h3>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<form id="f-einvoice_mtt" name="f-einvoice_mtt" method="post" enctype="multipart/form-data" >
					<div class="card">
						<div class="card-body">
						<div class="row">
						<div class="col-12 col-sm-6 col-md-3">
						<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<select class="form-control form-control-sm c-f__textbox" id="mau-so-hdon" name="mau-so-hdon" >
									
													<option value=""></option>
													<th:block th:if="${map_mausokyhieu != null}">
														<option th:each="entry : ${map_mausokyhieu.entrySet()}"
															th:value="${entry.key}" th:utext="${entry.value}" > </option>
													</th:block>
												</select>
												<fieldset aria-hidden="true" class="c-f__set">
													<legend class="c-f__legend"><label>Mẫu hóa đơn</label></legend>
												</fieldset>
											</div>
										</div>
									</div></div>
						<div class="col-12 col-sm-6 col-md-3">
						<div class="row">
										<div class="col-12">
											<div class="custom-field m-b-16">
												<div class="c-f__wrapper">
													<select class=" form-control form-control-sm c-f__textbox" id="send-cqt-status" name="send-cqt-status" tabindex="-1" aria-hidden="true" >
														<option value=""></option>
														<th:block th:if="${map_sendCQT_status != null}">
															<option th:each="entry : ${map_sendCQT_status.entrySet()}"
																th:value="${entry.key}" th:utext="${entry.value}" > </option>
														</th:block>
													</select>
													<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Trạng thái gửi thuế</label></legend></fieldset>
												</div>
											</div>
										</div>
									</div>
						</div>
						<div class="col-12 col-sm-6 col-md-3">
						<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox" type="text" id="date" name="date" th:value="${Date}" autocomplete="off" />
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Ngày hóa đơn</label></legend></fieldset>
											</div>
										</div>
									</div>
						</div>
						<div class="col-12 col-sm-6 col-md-3">
						<div class="row">
									      
									      <div class="col-12 m-b-16">
									         <button
									            class="btns btns-search_auto__ses hover-up__ses w-100p"
									            data-action="search"
									            title="Tìm kiếm"
									            type="button"
									            id="seach_cqt"
									            >
									         <i class="mdi mdi-file-find"></i
									            ><span class="d-none d-md-inline">Tìm kiếm</span>
									         </button>
									      </div>
									   </div>
						</div>
					<!-- 	<div class="col-12 col-sm-6 col-md-2">
						<div class="row">
									      <div class="col-12 m-b-16">
									         <button
									            class="btns btns-search_auto__ses hover-up__ses w-100p"
									            data-action="deletesearch"
									            title="Xóa Tìm kiếm"
									            type="button"
									            >
									         <i class="mdi mdi-delete"> </i
									            ><span class="d-none d-md-inline"
									            >Xóa tìm kiếm</span
									            >
									         </button>
									      </div>
									      
									   </div>
						</div> -->
						</div>
							
							
							<div class="row"><div class="col-12"><hr style="margin: 0 0 10px 0" /></div></div>
							<div class="col-12">
							<div class="row mT-0">
								                         		
                            		<div class="col-12 col-sm-12 text-right p-r-0 p-l-0">
                            			<div class="button-group text-right">																
										   
										
										</div>
                            			
                            		</div>
                            	</div>
                        
						    </div>
							<div class="col-12">
								<div class="row mT-0 align-items-center">
									<div class="col-12 col-sm-12 col-md-6 p-l-0 p-r-0 m-b-5" >
			                          <div class="font-weight-bold" >
			                            SỐ LƯỢNG PHÁT HÀNH HÓA ĐƠN TRONG NGÀY <span id="NgayTimKiem"></span>
			                          </div>
			                          <div>
			                            Phát hành: <span id = "PhatHanh"></span>,
			                            <span class="text-success">Đã gửi thuế: <span id = "HopLe"></span>,
			                            <span class="text-danger">Lỗi từ CQT: <span id = "KhongHopLe"></span>,
			                            <span>Chưa gửi thuế: <span id = "ChuaGui"></span> 
			                          </div>
			                        </div>
                            		<div class="col-12 col-sm-12 col-md-6 text-right p-r-0 p-l-0">
                            			<div class="button-group text-right">                            		
                            				
                           			
                            				<button type="button" title="Gửi dữ liệu" data-action="einvoice_mtt_list-send" class="btns ctiet_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|einvoice_mtt_list-send|')}" >
                            					<i class="mdi mdi-arrow-up"> </i><span class="d-none d-md-inline">Gửi dữ liệu</span>
                            				</button>
                            				<button type="button" title="Gửi tất cả dữ liệu" data-action="einvoice_mtt_list-sendAll" class="btns tdoi_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|einvoice_mtt_list-sendAll|')}"  >
                            					<i class="mdi mdi-arrow-up-bold"> </i><span class="d-none d-md-inline">Gửi tất cả dữ liệu</span>
                            				</button>                            			                      
                            			
                            			</div>
                            		</div>
                            	</div>
                            </div>
                            
                            <div class="form-group row m-b-5 m-t-7" >
	           					<div class="col-12 has-min-height-grid">
	           						<div id="grid" ></div>
	           					</div>
	           				</div>
							
						</div>
					</div>
                      
                      
				</form>
			
			
			<script type="text/javascript">
			
			$(document).ready(function(){
				var dataDate = {};				
				dataDate['date'] = $('#f-einvoice_mtt').find('#date').val();
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/einvoice_mtt_list/list_einvoice_mtt_send',
					data: dataDate,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res) {
							if(res.errorCode == 0) {															
								var responseData = res.responseData;	
								
								 $("#NgayTimKiem").html(responseData['NgayTimKiem']);
								 $("#PhatHanh").html(responseData['PhatHanh']);
								 $("#HopLe").html(responseData['HopLe']);
								 $("#KhongHopLe").html(responseData['KhongHopLe']);
								 $("#ChuaGui").html(responseData['ChuaGui']);
								/* $('#f-einvoice_mtt').find('#NgayTimKiem').val(responseData['NgayTimKiem']);
								$('#f-einvoice_mtt').find('#PhatHanh').val(responseData['PhatHanh']);
								$('#f-einvoice_mtt').find('#HopLe').val(responseData['HopLe']);
								$('#f-einvoice_mtt').find('#KhongHopLe').val(responseData['KhongHopLe']);
								$('#f-einvoice_mtt').find('#ChuaGui').val(responseData['ChuaGui']); */
							
							}else{		
								 $("#NgayTimKiem").html("0");
								 $("#PhatHanh").html("0");
								 $("#HopLe").html("0");
								 $("#KhongHopLe").html("0");
								 $("#ChuaGui").html("0");
								
							/* 	$('#f-einvoice_mtt').find('#NgayTimKiem').val("0");
								$('#f-einvoice_mtt').find('#PhatHanh,#HopLe,#KhongHopLe,#ChuaGui').val('0'); */
								
							}
						}else{					
							hideLoading();
						}
					},
					error:function (xhr, ajaxOptions, thrownError){						
			            hideLoading();
			        }
				});
				
				});
			</script>
			
			
				
			<script type="text/javascript">
			
			 var input = document.getElementById('seach_cqt');
			    input.onclick = function(){
			  		   
				var dataDate = {};				
				dataDate['date'] = $('#f-einvoice_mtt').find('#date').val();
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/einvoice_mtt_list/list_einvoice_mtt_send',
					data: dataDate,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res) {
							if(res.errorCode == 0) {															
								var responseData = res.responseData;
								
								 $("#NgayTimKiem").html(responseData['NgayTimKiem']);
								 $("#PhatHanh").html(responseData['PhatHanh']);
								 $("#HopLe").html(responseData['HopLe']);
								 $("#KhongHopLe").html(responseData['KhongHopLe']);
								 $("#ChuaGui").html(responseData['ChuaGui']);
								 
							/* 	$('#f-einvoice_mtt').find('#NgayTimKiem').val(responseData['NgayTimKiem']);
								$('#f-einvoice_mtt').find('#PhatHanh').val(responseData['PhatHanh']);
								$('#f-einvoice_mtt').find('#HopLe').val(responseData['HopLe']);
								$('#f-einvoice_mtt').find('#KhongHopLe').val(responseData['KhongHopLe']);
								$('#f-einvoice_mtt').find('#ChuaGui').val(responseData['ChuaGui']); */
							
							}else{		
								 $("#NgayTimKiem").html("0");
								 $("#PhatHanh").html("0");
								 $("#HopLe").html("0");
								 $("#KhongHopLe").html("0");
								 $("#ChuaGui").html("0");
								
				/* 				$('#f-einvoice_mtt').find('#NgayTimKiem').val("0");
								$('#f-einvoice_mtt').find('#PhatHanh,#HopLe,#KhongHopLe,#ChuaGui').val('0'); */
								
							}
						}else{					
							hideLoading();
						}
					},
					error:function (xhr, ajaxOptions, thrownError){						
			            hideLoading();
			        }
				});
				
			    };
			</script>
			
				<script type="text/javascript">
				_gridMain = $('#f-einvoice_mtt').find('#grid');
				</script>
			<!--   <script th:src="@{/static/function/einvoice/einvoices.js(v=1.55) }"></script>  -->
				<script>


				$(function(){
	/* 				dateInputFormat($('#f-einvoice_mtt').find('#from-date')); */
					dateInputFormat($('#f-einvoice_mtt').find('#date'));
					var  timeoutID;
					var  timeoutID2;
					_gridMain.kendoGrid({
						dataSource: new kendo.data.DataSource({
							transport: {
								read: {
									type: 'POST',
									url: ROOT_PATH + '/main/einvoice_mtt_list/search',
				                    dataType: 'json',
				                    data: function(){return getDataSearch();},
				                    beforeSend: function(req){
				                    	initAjaxJsonGridRequest(req);
				                	},
								}
							},
							requestEnd: function (e) {
				               	if (e.type === "read" && e.response) {
				               		if(e.response.errorCode == 0){
				               		}else{
				               			notificationDLSuccess(createObjectError(e.response).html(), function(){});
				               		}
				               	}
				           	},
				            schema: {
								data: "rows",
				                total: "total",
				                model: {
									fields: {
									}
								}
							},
							pageSize: KENDOUI_PAGESIZE_NO_SCROLL_Y,
							serverPaging: true,
							serverSorting: true,
				           	serverFiltering: true,
				           	change: function(e) {
				            },
						}),
						selectable: true, scrollable: true, 
				 		sortable: {mode: "single", allowUnsort: true},
						sortable: true,
//				 		filterable: { mode: "row"},
						filterable: false, resizable: true,
						serverSorting: false,
//						height: kendoGridHeight,
						pageable: {
							refresh: true,
							pageSizes: true,
							buttonCount: KENDOUI_BUTTONCOUNT,
							messages: {
								itemsPerPage: kendoGridMessages.itemsPerPage,
								previous: kendoGridMessages.previous,
								next: kendoGridMessages.next,
								refresh: kendoGridMessages.refresh,
								last: kendoGridMessages.last,
								first: kendoGridMessages.first,
								empty: kendoGridMessages.empty,
								display: kendoGridMessages.display
							},
							pageSizes: KENDOUI_PAGESIZES,
							numeric: true
						},
						dataBinding: function () {
				            record = (this.dataSource.page() - 1) * this.dataSource.pageSize();
				        },
				        columns: [
				        	{field: 'STT', width: '60px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">STT</a>',
				  				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				  				headerAttributes: {'class': 'table-header-cell text-center'}, template: "#= ++record #",
				  			},
				  			{field: 'isCheck', title: '', width: '60px', encoded: false
								, headerTemplate: '<label class="custom-control custom-checkbox p-l-30 m-b-0"><input type="checkbox" class="custom-control-input Check-All" data-check-all ><span class="custom-control-label"></span></label>'
								, attributes: {'class': 'table-cell', style: 'text-align: center;'}, sortable: false
								, headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
								, template: '<label class="custom-control custom-checkbox p-l-30 m-b-3"><input type="checkbox" class="custom-control-input Check-Item" data-check-item ><span class="custom-control-label"></span></label>'
							},
				  			{field: 'func', title: '', width: '50px', encoded: false
				  				, headerTemplate: '&nbsp;'
								, attributes: {'class': 'table-cell', style: 'text-align: left;'}, sortable: false
								, headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
//								, template: '<i title="In hóa đơn" class="mdi mdi-file-pdf-outline fs-25 text-danger c-pointer"></i>'
								, template: '#= window.setTemplateForGridMAIN("func", data) #'
							},
							{field: 'StatusDesc', width: '140px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Trạng thái hóa đơn</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
								template: '#= window.setTemplateForGridMAIN("StatusDesc", data) #'
							},
							{field: 'SignStatusDesc', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Trạng thái ký HĐ</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},	
							{field: 'EInvoiceNumber', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Số hóa đơn</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'MauSoHD', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mẫu số HĐ</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'NLap', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày phát hành</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'MCCQT', width: '220px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã CQT</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'TgTTTBSo', width: '140px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng tiền thanh toán</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'SendCQTStatus', width: '140px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Trạng thái gửi thuế</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							/* {field: 'TaxCode', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã số thuế</a>',
								attributes: {'class': 'table-cell text-left'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'CompanyName', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tên đơn vị</a>',
								attributes: {'class': 'table-cell text-left'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							}, */
						
						/* 	{field: 'TgTTTBSo', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng cộng</a>',
								attributes: {'class': 'table-cell text-right'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'TgTCThue', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng tiền</a>',
								attributes: {'class': 'table-cell text-right'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'TgTThue', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tiền thuế</a>',
								attributes: {'class': 'table-cell text-right'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							}, */

						
/* 							{field: 'CQTMTLoi', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Lỗi từ CQT</a>',
								attributes: {'class': 'table-cell text-left'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
								 */
											
/* 																				
						
							{field: 'MaHD', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã HĐ</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							}, */
						/* 	{field: 'HVTNMHang', width: '200px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Người mua hàng</a>',
								attributes: {'class': 'table-cell text-left'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'MTDiep', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã thông điệp</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},	
							{field: 'MTDTChieu', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã tham chiếu</a>',
								attributes: {'class': 'table-cell text-center'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},	
							{field: 'UserCreated', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Người lập</a>',
								attributes: {'class': 'table-cell text-left text-nowrap'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'SendCQT_Date', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày gửi mã hóa đơn</a>',
								attributes: {'class': 'table-cell text-left text-nowrap'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							},
							{field: 'CQT_Date', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày cấp mã hóa đơn</a>',
								attributes: {'class': 'table-cell text-left text-nowrap'}, sortable: false, 
								headerAttributes: {'class': 'table-header-cell text-center'},
							}, */
				    	],
						dataBound: function(e) {
//							_gridMain.find('div table tbody tr td').each(function(idx, obj){
//								$(obj).attr('title', $(obj).html())
//							});
							
							$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt_list-send"], button[data-action="einvoice_mtt-edit"],button[data-action="einvoice_mtt-copy"], button[data-action="einvoice_mtt-sign"], button[data-action="einvoice_mtt-cre-dc-tt"]').prop('disabled', true);
							
							_gridMain.find('tbody[role="rowgroup"]').find('tr').undelegate('i[data-sub-action]', 'click');
							_gridMain.find('tbody[role="rowgroup"]').find('tr').delegate('i[data-sub-action]', 'click', function(e){
								e.preventDefault();/*e.stopPropagation();*/
								
								var $obj = $(this);
								var $tr = $obj.closest('tr');
								var subAction = $obj.attr('data-sub-action');
								
								var indexRow = $tr.index();
								var rowData = null;
								var objData = {};
								var objURL = {};
								
								switch (subAction) {
								case 'send-email':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									objData['_id'] = rowData['_id'];
									showPopupWithURLAndData(ROOT_PATH + '/main/einvoice_mtt-send-mail/init', objData, false, function(e){
									});
									break;
								case 'print':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									window.open(ROOT_PATH + '/common/print-einvoice_mtt/' + rowData['_id'],'_blank');
									break;
								
								case 'print-convert':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									window.open(ROOT_PATH + '/common/print-einvoice_mtt-convert/' + rowData['_id'],'_blank');
									break;
								case 'refresh':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									objData['_id'] = rowData['_id'];
									$.ajax({
										type: "POST",
										datatype: "json",
										url: ROOT_PATH + '/main/einvoice_mtt/refresh-status-cqt',
										data: objData,
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
//									
											if(res) {
												if(res.errorCode == 0) {
													_gridMain.data("kendoGrid").dataSource.read();
												/* 	objURL['check'] = ROOT_PATH + '/main/einvoice_mtt-send-emailauto/check-data-send';
													objURL['exec'] = ROOT_PATH + '/main/einvoice_mtt-send-emailauto/send-mail';
													rowData = _gridMain.data("kendoGrid").dataItem($tr);
													objData['_id'] = rowData['_id'];
													$.ajax({
														type: "POST",
														datatype: "json",
														url: objURL['check'],
														data: objData,
														beforeSend: function(req) {
															initAjaxJsonRequest(req);
												        	showLoading();
														},
														success:function(res) {
															hideLoading();
															if(res) {
																if(res.errorCode == 0) {
																	var responseData = res.responseData;
																	tokenTransaction = responseData['TOKEN'];
																	
																	objData['tokenTransaction'] = tokenTransaction;

																			$.ajax({
																				type: "POST",
																				datatype: "json",
																				url: objURL['exec'],
																				data: objData,
																				beforeSend: function(req) {
																					initAjaxJsonRequest(req);
																		        	showLoading();
																				},
																				success:function(res) {
																					hideLoading();
																					if(res) {
																						if(res.errorCode == 0) {
																							_gridMain.data("kendoGrid").dataSource.read();
																						}else{
																							alertDLSuccess(createObjectError(res).html(), function(){});
																						}
																					}else{
																						alertDLSuccess('unknown error!!!', function(){});
																						hideLoading();
																					}
																				},
																				error:function (xhr, ajaxOptions, thrownError){
																					alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
																		            hideLoading();
																		        }
																			});
																	
																		
																
																}else{
																	alertDLSuccess(createObjectError(res).html(), function(){});
																}
															}else{
																alertDLSuccess('unknown error!!!', function(){});
																hideLoading();
															}
														},
														error:function (xhr, ajaxOptions, thrownError){
															alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
												            hideLoading();
												        }
													}); */
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});					
									break;
								case 'history':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									objData['_id'] = rowData['_id'];
									$('#divSubContent').show();$('#divMainContent').hide();
									submitFormRenderArea(ROOT_PATH + '/main/einvoice_mtt-history/history', objData, $('#divSubContent'));
									break;
								case 'change':
									rowData = _gridMain.data("kendoGrid").dataItem($tr);
									objData['_id'] = rowData['_id'];
									$('#divSubContent').show();$('#divMainContent').hide();
									submitFormRenderArea(ROOT_PATH + '/main/einvoice_mtt-change/change', objData, $('#divSubContent'));
									break;
								case 'delete':							
								case 'send-cqt':          
					                  if('delete' == subAction){
					                    objURL['check'] = ROOT_PATH + '/main/einvoice_mtt-del/check-data';
					                    objURL['exec'] = ROOT_PATH + '/main/einvoice-del/exec-data';
					                  }else{
					                    objURL['check'] = ROOT_PATH + '/main/einvoice_mtt-send-cqt/check-data';
					                    objURL['exec'] = ROOT_PATH + '/main/einvoice_mtt-send-cqt/exec-data';
					                  }
					                  
					                  rowData = _gridMain.data("kendoGrid").dataItem($tr);
					                  objData['_id'] = rowData['_id'];
					                  $.ajax({
					                    type: "POST",
					                    datatype: "json",
					                    url: objURL['check'],
					                    data: objData,
					                    beforeSend: function(req) {
					                      initAjaxJsonRequest(req);
					                          showLoading();
					                    },
					                    success:function(res) {
					                      hideLoading();
					                      if(res) {
					                        if(res.errorCode == 0) {
					                          var responseData = res.responseData;
					                          
					                          var confirmText = responseData['CONFIRM'];
					                          tokenTransaction = responseData['TOKEN'];
					                          
					                          objData['tokenTransaction'] = tokenTransaction;
					                          
					                          alertConfirm(confirmText,
					                            function(e){
					                              $.ajax({
					                                type: "POST",
					                                datatype: "json",
					                                url: objURL['exec'],
					                                data: objData,
					                                beforeSend: function(req) {
					                                  initAjaxJsonRequest(req);
					                                      showLoading();
					                                },
					                                success:function(res) {
					                                  hideLoading();
					                                  if(res) {
					                                    if(res.errorCode == 0) {
					                                      _gridMain.data("kendoGrid").dataSource.read();
					                                    }else{
					                                      alertDLSuccess(createObjectError(res).html(), function(){});
					                                    }
					                                  }else{
					                                    alertDLSuccess('unknown error!!!', function(){});
					                                    hideLoading();
					                                  }
					                                },
					                                error:function (xhr, ajaxOptions, thrownError){
					                                  alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
					                                        hideLoading();
					                                    }
					                              });
					                            },
					                            function(e){}
					                          );
					                        }else{
					                          alertDLSuccess(createObjectError(res).html(), function(){});
					                        }
					                      }else{
					                        alertDLSuccess('unknown error!!!', function(){});
					                        hideLoading();
					                      }
					                    },
					                    error:function (xhr, ajaxOptions, thrownError){
					                      alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
					                            hideLoading();
					                        }
					                  });
					                  break;
							
								default:
									break;
								}
							});
							
						}
					});
					
					
					_gridMain.find('table[role="grid"]').find('thead').undelegate('input[type="checkbox"][data-check-all]', 'click');
					_gridMain.find('table[role="grid"]').find('thead').delegate('input[type="checkbox"][data-check-all]', 'click', function(e){
						var _obj = this;
						
						_gridMain.find('table[role="grid"] tbody input[type="checkbox"][data-check-item]').prop('checked', $(_obj).prop('checked'));
						if ($(_obj).prop('checked')) {
							_gridMain.find(' tbody tr').addClass("k-state-selected");
						}else{
							_gridMain.find(' tbody tr').removeClass("k-state-selected");
						}
						
						isDisabledEditDel();
					});
								
					
					
					
					
					
					_gridMain.find('table[role="grid"]').find('tbody').undelegate('tr', 'click');
					_gridMain.find('table[role="grid"]').find('tbody').delegate('tr', 'click', function(e){
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-detail"]').prop('disabled', false);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-copy"]').prop('disabled', false);	
						var $tr = $(this).closest("tr");

						var rowData = _gridMain.data("kendoGrid").dataItem($tr);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt_list-send"]').prop('disabled', 'PROCESSING' == rowData['EInvoiceStatus']? false: true);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt_list-send"]').prop('disabled', 'PENDING' == rowData['EInvoiceStatus']? false: true);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-sign"]').prop('disabled', 'NOSIGN' == rowData['SignStatusCode']? false: true);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-edit"]').prop('disabled', 'NOSIGN' == rowData['SignStatusCode']? false: true);
						$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-signAll"]').prop('disabled', 'NOSIGN' == rowData['SignStatusCode']? false: true);
							
						
						//LAY MA CQT
						if('PENDING' == rowData['EInvoiceStatus'] && 'SIGNED' == rowData['SignStatusCode']){						  
					          	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-send-cqt"]').prop('disabled', false);
							}else{
						    	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-send-cqt"]').prop('disabled', true);
							}
						//LAY MA CQT
						if('PROCESSING' == rowData['EInvoiceStatus'] && 'SIGNED' == rowData['SignStatusCode']){						  
					          	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-refreshAll"]').prop('disabled', false);
							}else{
						    	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-refreshAll"]').prop('disabled', true);
							}
						
						if('Đã phát hành' == rowData['StatusDesc'] || 'Đã thay thế' == rowData['StatusDesc'] || 'Đã điều chỉnh' == rowData['StatusDesc'] || 'Đã xóa bỏ' == rowData['StatusDesc']){
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfAll"]').prop('disabled', false);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfCD"]').prop('disabled', false);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-xml"]').prop('disabled', false);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-sendMailAll"]').prop('disabled', false);
				              
				            }else{
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfAll"]').prop('disabled', true);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfCD"]').prop('disabled', true);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-xml"]').prop('disabled', false);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-sendMailAll"]').prop('disabled', true);
				            }		
						
						if('Đã xóa bỏ' == rowData['StatusDesc']){
						    $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfAll"]').prop('disabled', true);
						    $("#f-einvoice_mtt").find('button[data-action="einvoice-pdfCD"]').prop('disabled', true);
				              $("#f-einvoice_mtt").find('button[data-action="einvoice-xml"]').prop('disabled', true);
				          	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-edit"]').prop('disabled', true);
				          	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-sign"]').prop('disabled', true);
				          	$("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-delete"]').prop('disabled', true);
						}
						if('2' == rowData['HDSS_TCTBao'] || '3' == rowData['HDSS_TCTBao']){
				              $("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-cre-dc-tt"]').prop('disabled', false);
				            }else{
				              $("#f-einvoice_mtt").find('button[data-action="einvoice_mtt-cre-dc-tt"]').prop('disabled', true);
				            }
				            
				          });
					
					
		
					
					
					
					_gridMain.find('table[role="grid"]').find('thead').undelegate('input[type="checkbox"][data-check-all]', 'click');
					_gridMain.find('table[role="grid"]').find('thead').delegate('input[type="checkbox"][data-check-all]', 'click', function(e){
						var _obj = this;
						
						_gridMain.find('table[role="grid"] tbody input[type="checkbox"][data-check-item]').prop('checked', $(_obj).prop('checked'));
						if ($(_obj).prop('checked')) {
							_gridMain.find(' tbody tr').addClass("k-state-selected");
						}else{
							_gridMain.find(' tbody tr').removeClass("k-state-selected");
						}
						
						disableEnabledAllButton();
					});
	
					_gridMain.find('table[role="grid"]').find('tbody').undelegate('input[type="checkbox"][data-check-item]', 'click');
					_gridMain.find('table[role="grid"]').find('tbody').delegate('input[type="checkbox"][data-check-item]', 'click', function(e){
						var checked = $(this).prop('checked');
						if(checked){
							$(this).closest("tr").addClass("k-state-selected");
						}else{
							$(this).closest("tr").removeClass("k-state-selected");
						}
						_gridMain.find('table[role="grid"]').find('thead input[type="checkbox"]').prop('checked', _gridMain.find(' tbody tr input[type="checkbox"]:not(:checked)').length == 0);
						disableEnabledAllButton();
					});
	
					_gridMain.find('table[role="grid"]').find('tbody').undelegate('tr td:not(:eq(1))', 'click');
					_gridMain.find('table[role="grid"]').find('tbody').delegate('tr td:not(:eq(1))', 'click', function(e){
						var _obj = $(this).closest("tr");
						
						var _oldChecked = $(_obj).find('input[type=checkbox][data-check-item]').prop('checked');
						$(_obj).find('input[type=checkbox][data-check-item]').prop('checked', !_oldChecked);
						if(!_oldChecked){
							$(this).closest("tr").addClass("k-state-selected");
						}else{
							$(this).closest("tr").removeClass("k-state-selected");
						}
						_gridMain.find('table[role="grid"]').find('thead input[type="checkbox"]').prop('checked', _gridMain.find(' tbody tr input[type="checkbox"]:not(:checked)').length == 0);
						disableEnabledAllButton();
					});
					
					$("#f-einvoice_mtt").undelegate('a.download-plugin', 'click');
					$("#f-einvoice_mtt").delegate('a.download-plugin', 'click', function(event){
						event.preventDefault();/*event.stopPropagation();*/
						
						window.open(ROOT_PATH + '/main/common/download-plugin', '_blank');
					});
					
					$("#f-einvoice_mtt").find('button[data-action]').click(function (event) {
						event.preventDefault();/*event.stopPropagation();*/
						var dataAction = $(this).data('action');
						var $obj = $(this);
						var objData = {};
						///////////////////////////////////
						var tokenSignApproveWithToken = '';
							var rowsSign = null;
							var serialNumber = '';
							var checkSignStatus = false;
							var signDate = '';
						//////////////////////////////
						var rowData = null;
						var actionCheck = '|einvoice_mtt-edit|einvoice_mtt-copy|einvoice_mtt-delete|einvoice_mtt-delete_|einvoice-pdfAll|einvoice-pdfCD|einvoice-xml|einvoice-signAll|einvoice_mtt-sign|einvoice-detail|einvoice-refreshAll|einvoice_mtt-send-cqt|';
						var checkRows = _gridMain.find(' tbody tr input[type="checkbox"]:checked');
						var ids = null;
						var idx = -1;
						if(actionCheck.indexOf('|' + dataAction + '|') != -1 && 0 == checkRows.length){
							alertDLSuccess('<span class="required">Vui lòng chọn dòng dữ liệu để thực hiện.</span>', function(){});
							return;
						}
						var entityGrid = _gridMain.data("kendoGrid");
						var selectedItem = entityGrid.dataItem(entityGrid.select());
						if(actionCheck.indexOf('|' + dataAction + '|') != -1 && selectedItem == null){
							alertDLSuccess('<span class="required">Vui lòng chọn dòng dữ liệu để thực hiện.</span>', function(){});
							return;
						}
					
						switch (dataAction) {
						case 'einvoice-signAll':
							ids = [];
							objData = {};
							checkRows
									.each(function(i, v) {
										idx = $(
												checkRows[i]
														.closest("tr"))
												.index();
										rowData = _gridMain
												.data(
														"kendoGrid")
												.dataItem(
														_gridMain
																.find(
																		' tbody tr')
																.eq(
																		idx));
										ids
												.push(rowData['_id']);
									});
							/*CHECK THONG TIN HD*/
							objData = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							dsID = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							$
									.ajax({
										type : "POST",
										datatype : "json",
										url : ROOT_PATH
												+ '/main/einvoice-signAll/check-data-signAll',
										data : objData,
										beforeSend : function(
												req) {
											initAjaxJsonRequest(req);
											showLoading();
										},
										success : function(
												res) {
											if (res) {
												if (res.errorCode == 0) {
													var responseData = res.responseData;
													var token = responseData.Token;
													var time = responseData.Time;
													var numbers = responseData.Numbers;
													var formIssueInvoiceID = responseData.FormIssueInvoiceID;
													var taxCode = responseData.TaxCode;
													var shd = responseData.SHD;
													objData = {
														_token : encodeObjJsonBase64UTF8(tokenTransaction)
													};
													objData['tokenTransaction'] = tokenTransaction;

													var urlOrigin = window.location.origin;
													var urlPathname = window.location.pathname;
													var url = urlOrigin;
													var link = taxCode
															+ ","
															+ time
															+ ","
															+ token;

													url += ROOT_PATH
															+ '/InvoiceUtility/downloadFileForSignMulti/'
															+ link;

													getCert(function(e) {
														if (null == e) {
															alertDLSuccess(
																	'Lấy chữ ký số không thành công.',
																	function myFunction() {
																		  timeout = setTimeout(ckserro, 0);
																		}
																
																	);
															
																
															
															hideLoading();
															$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
															/*Get Certificate*/
														}
													
														
														checkToken(function(e) {
															if (e) {
																showLoading();
																
																serialNumber = serialNumber['Seri'];
																var postEnc = new FormData();
																postEnc.append('SerialNumber',serialNumber);
																postEnc.append('UrlDecode',base64.encode(base64._utf8_encode(url)));

																var xhrSignMulti = new XMLHttpRequest();
																xhrSignMulti.onreadystatechange = function() {
																	if (this.readyState == 4) {
																		hideLoading();
																		if (this.status == 200) {
																			var blob = new Blob(
																					[ this.response ],
																					{
																						type : "application/zip"
																					});
																			var formData = new FormData();
																			formData
																					.append(
																							_csrf_name,
																							_csrf_value);
																			formData
																					.append(
																							"Numbers",
																							base64
																									.encode(base64
																											._utf8_encode(JSON
																													.stringify(numbers))));
																			formData
																					.append(
																							"FormIssueInvoiceID",
																							formIssueInvoiceID);
																			formData
																					.append(
																							"zipFile",
																							blob);
																			formData
																					.append(
																							"Certificate",
																							base64Cert
																									.replace(
																											/\+/g,
																											"@"));
																			sendSignMulti(formData);
																		} else if (this.status == 401) {
																		
																			alertDLSuccess(
																					'<span class="text-error">Lỗi trong quá trình ký tập tin.<span>',
																					function myFunction() {
																						  timeout = setTimeout(ckserro, 0);
																						}
																				
																					);
																		} else {
																			alertDLSuccess(
																					'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<br>Quý khách vui lòng cập nhật lại plugin ký số.<span>',
																					function myFunction() {
																						  timeout = setTimeout(ckserro, 0);
																						}
																				
																					);
																		
																		}

																	}
																}
																xhrSignMulti
																		.open(
																				'POST',
																				urlPluginSign
																						+ signMultiXML,
																				true);
																xhrSignMulti.timeout = 5 * 60 * 1000;
																xhrSignMulti.responseType = 'blob'; //or arraybuffer
																xhrSignMulti
																		.send(postEnc);
															}
														});
													});
												} else {
													hideLoading();
													alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
															function myFunction() {
																  timeout = setTimeout(ckserro, 0);
																}
														
															);
												}
											} else {
												alertDLSuccess(
														'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
														function myFunction() {
															  timeout = setTimeout(ckserro, 0);
															}
													
														);
												hideLoading();
											}
										},
										error : function(
												xhr,
												ajaxOptions,
												thrownError) {
											alertDLSuccess(
													'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
													function myFunction() {
														  timeout = setTimeout(ckserro, 0);
														}
												
													);
											hideLoading();
										}

									});
							function ckserro() {
								window.open(ROOT_PATH + '/main/hdsduser/init','_blank');
							}
							
							function checkToken(cb) {
								serialNumber = '';
								$
										.ajax({
											type : "POST",
											datatype : "json",
											url : ROOT_PATH
													+ '/main/common/check-cert',
											data : {
											'cert' : base64Cert
											},
										
											beforeSend : function(
													req) {
												initAjaxJsonRequest(req);
												showLoading();
											},
											success : function(
													res) {
												hideLoading();
												if (res) {
													if (res.errorCode == 0) {
														serialNumber = res.responseData;
														cb(serialNumber)
													
													} else {
														alertDLSuccess(
																'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																function myFunction() {
																	  timeout = setTimeout(ckserro, 0);
																	}
															
																);
													}
												} else {
													alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
															function myFunction() {
																  timeout = setTimeout(ckserro, 0);
																}
														
															);
													hideLoading();
												}
											},
											error : function(
													xhr,
													ajaxOptions,
													thrownError) {
												alertDLSuccess(
														'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
														function myFunction() {
															  timeout = setTimeout(ckserro, 0);
															}
													
														);
												hideLoading();
											}
										});
							}

							function sendSignMulti(formData) {
								$
										.ajax({
											url : ROOT_PATH
													+ '/main/einvoice-signAll/signFileAll',
											type : 'POST',
											data : formData,
											async : false,
											cache : false,
											contentType : false,
											enctype : 'multipart/form-data',
											processData : false,
											dataType : 'json',
											beforeSend : function(
													req) {
												initAjaxJsonRequest(req);
												showLoading();
											},
											success : function(
													res,
													textStatus,
													xhr) {
												hideLoading();
												if (res) {
													if (res.errorCode == 0) {
														$(
																'#f-einvoice_mtt')
																.find(
																		"#grid")
																.data(
																		"kendoGrid").dataSource
																.read();
														hideLoading();
														/* timeoutID = setTimeout(
																callsend_cqtAll,
																1000); */
													} else {
														alertDLSuccess(
																'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																function myFunction() {
																	  timeout = setTimeout(ckserro, 0);
																	}
															
																);
													}
												} else {
													alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
															function myFunction() {
																  timeout = setTimeout(ckserro, 0);
																}
														
															);
													hideLoading();
												}
											},
											error : function(
													xhr,
													ajaxOptions,
													thrownError) {
												alertDLSuccess(
														'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
														function myFunction() {
															  timeout = setTimeout(ckserro, 0);
															}
													
														);
												hideLoading();
											}
										});
							}

							function callsend_cqtAll() {
								var objURL = {};
								objURL['check'] = ROOT_PATH
										+ '/main/einvoice-send-cqtAll/check-dataAll';
								objURL['exec'] = ROOT_PATH
										+ '/main/einvoice-send-cqtAll/exec-dataAll';

								$
										.ajax({
											type : "POST",
											datatype : "json",
											url : objURL['check'],
											data : dsID,
											beforeSend : function(
													req) {
												initAjaxJsonRequest(req);
												showLoading();
											},
											success : function(
													res) {
												hideLoading();
												if (res) {
													if (res.errorCode == 0) {
														var responseData = res.responseData;
														tokenTransaction = responseData['TOKEN'];
														dsID['tokenTransaction'] = tokenTransaction;
														$
																.ajax({
																	type : "POST",
																	datatype : "json",
																	url : objURL['exec'],
																	data : dsID,
																	beforeSend : function(
																			req) {
																		initAjaxJsonRequest(req);
																		showLoading();
																	},
																	success : function(
																			res) {
																		hideLoading();
																		if (res) {
																			if (res.errorCode == 0) {
																				_gridMain
																						.data("kendoGrid").dataSource
																						.read();
																			} else {
																				alertDLSuccess(
																						'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																						function myFunction() {
																							  timeout = setTimeout(ckserro, 0);
																							}
																					
																						);
																			}
																		} else {
																			alertDLSuccess(
																					'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																					function myFunction() {
																						  timeout = setTimeout(ckserro, 0);
																						}
																				
																					);
																			hideLoading();
																		}
																	},
																	error : function(
																			xhr,
																			ajaxOptions,
																			thrownError) {
																		alertDLSuccess(
																				'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																				function myFunction() {
																					  timeout = setTimeout(ckserro, 0);
																					}
																			
																				);
																		hideLoading();
																	}
																});

													} else {
														alertDLSuccess(
																'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																function myFunction() {
																	  timeout = setTimeout(ckserro, 0);
																	}
															
																);
													}
												} else {
													alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
															function myFunction() {
																  timeout = setTimeout(ckserro, 0);
																}
														
															);
													hideLoading();
												}
											},
											error : function(
													xhr,
													ajaxOptions,
													thrownError) {
												alertDLSuccess(
														'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
														function myFunction() {
															  timeout = setTimeout(ckserro, 0);
															}
													
														);
												hideLoading();
											}
										});
							}

							break;
						case 'einvoice-import':
							showPopupWithURLAndData(ROOT_PATH + '/main/einvoice-import/init', objData, true, function(e){
							});
							break;
						case 'einvoice-import-auto':
				              showPopupWithURLAndData(ROOT_PATH + '/main/einvoice-import-auto/init', objData, true, function(e){
				              });
				              break;
						case 'einvoice-delete_':
							ids = [];
							checkRows.each(function(i, v) {
							    idx = $(checkRows[i].closest("tr")).index();
							    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							    ids.push(rowData['_id']);
							});
							objData['_id'] = rowData['_id'];	
							$.ajax({
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoices/delete_HD',
								data: objData,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											_gridMain.data("kendoGrid").dataSource.read();
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							});	
							break;
						case 'einvoice_mtt-delete':
							ids = [];
							checkRows.each(function(i, v) {
							    idx = $(checkRows[i].closest("tr")).index();
							    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							    ids.push(rowData['_id']);
							});
							
							objData = {_token: encodeObjJsonBase64UTF8(ids)};
							$.ajax({
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoice_mtt-deleteAll/check-data-save',
								data: objData,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											objData = {};	
											var responseData = res.responseData;
											
											var confirmText = responseData['CONFIRM'];
											tokenTransaction = responseData['TOKEN'];
											objData = {_token: encodeObjJsonBase64UTF8(ids)};
											objData['tokenTransaction'] = tokenTransaction;
											
											alertConfirm(confirmText,
												function(e){
													$.ajax({
														type: "POST",
														datatype: "json",
														url: ROOT_PATH + '/main/einvoice_mtt-deleteAll/save-data',
														data: objData,
														beforeSend: function(req) {
															initAjaxJsonRequest(req);
												        	showLoading();
														},
														success:function(res) {
															hideLoading();
															if(res) {
																if(res.errorCode == 0) {
																	if($('#f-einvoice_mtt').find('#grid').length > 0){
																		_gridMain.data("kendoGrid").dataSource.read();
																	}
																}else{
																	alertDLSuccess(createObjectError(res).html(), function(){});
																}
															}else{
																alertDLSuccess('unknown error!!!', function(){});
																hideLoading();
															}
														},
														error:function (xhr, ajaxOptions, thrownError){
															alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
												            hideLoading();
												        }
													});
												},
												function(e){}
											);
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							});
							break;
				
						case 'einvoice_mtt-sign':
							objDataSend = {};
							idx = $(checkRows[0].closest("tr")).index();
							rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							objDataSend['_id'] = rowData['_id'];
							$.ajax({
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoice_mtt-sign/check-data-sign',
								data: objDataSend,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									if(res) {
										if(res.errorCode == 0) {
											var responseData = res.responseData;
											
											tokenTransaction = responseData['TOKEN'];
											objDataSend['tokenTransaction'] = tokenTransaction;
											
																			
										   $.ajax({
		        
								          url: "http://localhost:11284/getCert",
								          type: 'POST',
								          cors: true ,
									          secure: true,
								          headers: {
								            'Access-Control-Allow-Origin': '*',
								            'Access-Control-Allow-Headers': '*',
								            'Access-Control-Allow-Private-Network': true
								          },
								          beforeSend: function(req) {
								            initAjaxJsonRequest(req);
								                showLoading();
								          },
								          success:function(res) {
								            hideLoading();
								            if(res != null) {
								            	var cert = res;           	
								             		$.ajax({
													type: "POST",
													url: ROOT_PATH + '/main/common/check-cert',
													data: {'cert':cert},
													beforeSend: function(req) {
														initAjaxJsonRequest(req);
											        	showLoading();
													},
													success:function(res) {
														hideLoading();
														if(res) {
															if(res.errorCode == 0) {
																
														 	var responseData = res.responseData;
															/* var check = responseData['check'];
																console.log(check)
																if(check==="300"){
																
																	alertDLSuccess(
																			'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																			function myFunction() {
																				  timeout = setTimeout(ckserro, 0);
																				}
																		
																			);
														
																}else{ */
																	
																serialNumber = responseData['Seri'];
																//LAY NOI DUNG FILE XML
																jQuery.ajax({
																	url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
															        cache:false,
															        xhr:function(){// Seems like the only way to get access to the xhr object
															            var xhr = new XMLHttpRequest();
															            xhr.responseType= 'blob'
															            return xhr;
															        },
															        success:function(data, textStatus, xhr) {
//															        	hideLoading();
																    	if(xhr.status == 200){
																    		var blob = new Blob([data], { type: 'octet/stream' });
																    		var postEnc = new FormData();
																    		postEnc.append('SerialNumber', serialNumber);
																    		postEnc.append('xmlFile', blob);
													    				
																    		var xhrSign = new XMLHttpRequest();
																    		xhrSign.onreadystatechange = function(e) {
																    			if(4 == this.readyState) {
																    				if(this.status == 200){	
																    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
																    					blob = new Blob( [this.response], { type : "octet/stream" } );
																    					showLoading();
																    				
																    					formData = new FormData();
																						formData.append("XMLFileSigned", blob);
																						formData.append('certificate', base64Cert.replace(/\+/g, "@"));
																					
																						
																						xhrSign = new XMLHttpRequest();
																						xhrSign.upload.addEventListener('progress', function(e) {
																							
																						});
																						if(xhrSign.upload) {
																							
																						};
																						xhrSign.onreadystatechange = function(e) {
																							if(4 == this.readyState && this.status == 200) {
																								var res = xhrSign.response;
																								if(res){
																									if(res.errorCode == 0) { 
																										hideLoading();
																									     _gridMain.data("kendoGrid").dataSource.read();
																								//			  timeoutID = setTimeout(callsend_cqt, 1000);
														
																									}else{
																										alertDLSuccess(
																												'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																												function myFunction() {
																													  timeout = setTimeout(ckserro, 0);
																													}
																											
																												);
																				            			hideLoading();
																				            			$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
																				            		}
																								}else{
																									alertDLSuccess(
																											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																											function myFunction() {
																												  timeout = setTimeout(ckserro, 0);
																												}
																										
																											);
																									hideLoading();
																									 
																				            	}
																							}
																						}
																						xhrSign.onerror = function() {
																							
																						}
																						xhrSign.ontimeout = function() {
																							
																						}
																						
																						var urlPost = ROOT_PATH + '/main/einvoice_mtt-sign/signFile';
																						xhrSign.open("POST", urlPost, true);
																						xhrSign.responseType = 'json';
																						xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																						xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																						
																						xhrSign.setRequestHeader('Cache-Control', 'no-cache');
																					
																						xhrSign.send(formData);
																    				}else{
																						hideLoading();
																						alertDLSuccess(
																								'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																								function myFunction() {
																									  timeout = setTimeout(ckserro, 0);
																									}
																							
																								);
																					}
																    			}
																    		}
																    		xhrSign.open('POST', urlPluginSign + signXML, true);
																			xhrSign.timeout = 5 * 60 * 1000;
																			xhrSign.responseType = 'blob';	//or arraybuffer
																			xhrSign.send(postEnc);
																    	}else{
																    		
																    		hideLoading();
																    		alertDLSuccess(
																					'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																					function myFunction() {
																						  timeout = setTimeout(ckserro, 0);
																						}
																				
																					);
																		}
																    
															        },
															        error:function(){
															        	
															        }
																});
																/* } */
															}else{
																alertDLSuccess(createObjectError(res).html(), function(){});
																
															}
														}else{
															alertDLSuccess(
																	'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																	function myFunction() {
																		  timeout = setTimeout(ckserro, 0);
																		}
																
																	);
															hideLoading();
															
														}
														
													
													},
													error:function (xhr, ajaxOptions, thrownError){
														alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
											            hideLoading();
											            
											        }
												});										
		            }else{
		            	alertDLSuccess(
								'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
								function myFunction() {
									  timeout = setTimeout(ckserro, 0);
									}
							
								);
													hideLoading();
													$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
													return;
		            }
		          },
		          error:function (xhr, ajaxOptions, thrownError){
		        	  alertDLSuccess(
								'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
								function myFunction() {
									  timeout = setTimeout(ckserro, 0);
									}
							
								);
						hideLoading();
						$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
						return;
		          }
		        });
										
										
										
										
										}else{
											 $("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
											hideLoading();
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										
										alertDLSuccess(
												'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
												function myFunction() {
													  timeout = setTimeout(ckserro, 0);
													}
											
												);
										hideLoading();
									}
									function ckserro() {
										window.open(ROOT_PATH + '/main/hdsduser/init','_blank');
									}
									function callsend_cqt() {
										var objURL = {};
										  objURL['check'] = ROOT_PATH + '/main/einvoice-send-cqt/check-data';
						                    objURL['exec'] = ROOT_PATH + '/main/einvoice-send-cqt/exec-data';
						               
						                  $.ajax({
						                    type: "POST",
						                    datatype: "json",
						                    url: objURL['check'],
						                    data: objDataSend,
						                    beforeSend: function(req) {
						                      initAjaxJsonRequest(req);
						                          showLoading();
						                    },
						                    success:function(res) {
						                      hideLoading();
						                      if(res) {
						                        if(res.errorCode == 0) {
						                          var responseData = res.responseData;
						                          tokenTransaction = responseData['TOKEN'];
						                          objDataSend['tokenTransaction'] = tokenTransaction;         
						                              $.ajax({
						                                type: "POST",
						                                datatype: "json",
						                                url: objURL['exec'],
						                                data: objDataSend,
						                                beforeSend: function(req) {
						                                  initAjaxJsonRequest(req);
						                                      showLoading();
						                                },
						                                success:function(res) {
						                                  hideLoading();
						                                  if(res) {
						                                    if(res.errorCode == 0) {
						                                     _gridMain.data("kendoGrid").dataSource.read();
																										 	
														 timeoutID2 = setTimeout(callrefesh_cqt, 2000);
															
						                                    }else{
						                                      alertDLSuccess(createObjectError(res).html(), function(){});
						                                    }
						                                  }else{
						                                	  alertDLSuccess(
																		'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																		function myFunction() {
																			  timeout = setTimeout(ckserro, 0);
																			}
																	
																		);
						                                    hideLoading();
						                                  }
						                                },
						                                error:function (xhr, ajaxOptions, thrownError){
						                                  alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						                                        hideLoading();
						                                    }
						                              });
						                          
						                        }else{
						                          alertDLSuccess(createObjectError(res).html(), function(){});
						                        }
						                      }else{
						                    	  alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
															function myFunction() {
																  timeout = setTimeout(ckserro, 0);
																}
														
															);
						                        hideLoading();
						                      }
						                    },
						                    error:function (xhr, ajaxOptions, thrownError){
						                      alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						                            hideLoading();
						                        }
						                  });		
										}

									
									
									function callrefesh_cqt() {
									
										$.ajax({
											type: "POST",
											datatype: "json",
											url: ROOT_PATH + '/main/einvoice_mtt/refresh-status-cqt',
											data: objDataSend,
											beforeSend: function(req) {
												initAjaxJsonRequest(req);
									        	showLoading();
											},
											success:function(res) {
												hideLoading();						
												if(res) {
													if(res.errorCode == 0) {
														var objURL1 = {};
														objURL1['check'] = ROOT_PATH + '/main/einvoice-send-emailauto/check-data-send';
														objURL1['exec'] = ROOT_PATH + '/main/einvoice-send-emailauto/send-mail';
													
														$.ajax({
															type: "POST",
															datatype: "json",
															url: objURL1['check'],
															data: objDataSend,
															beforeSend: function(req) {
																initAjaxJsonRequest(req);
													        	showLoading();
															},
															success:function(res) {
																hideLoading();
																if(res) {
																	if(res.errorCode == 0) {
																		var responseData = res.responseData;
																		tokenTransaction = responseData['TOKEN'];
																		
																		objDataSend['tokenTransaction'] = tokenTransaction;

																				$.ajax({
																					type: "POST",
																					datatype: "json",
																					url: objURL1['exec'],
																					data: objDataSend,
																					beforeSend: function(req) {
																						initAjaxJsonRequest(req);
																			        	showLoading();
																					},
																					success:function(res) {
																						hideLoading();
																						if(res) {
																							if(res.errorCode == 0) {
																								_gridMain.data("kendoGrid").dataSource.read();
																							}else{
																								alertDLSuccess(createObjectError(res).html(), function(){});
																							}
																						}else{
																							alertDLSuccess('unknown error!!!', function(){});
																							hideLoading();
																						}
																					},
																					error:function (xhr, ajaxOptions, thrownError){
																						alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
																			            hideLoading();
																			        }
																				});
																		
																			
																	
																	}else{
																		alertDLSuccess(createObjectError(res).html(), function(){});
																	}
																}else{
																	alertDLSuccess('unknown error!!!', function(){});
																	hideLoading();
																}
															},
															error:function (xhr, ajaxOptions, thrownError){
																alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
													            hideLoading();
													        }
														});
													}else{
														alertDLSuccess(createObjectError(res).html(), function(){});
													}
												}else{
													alertDLSuccess('unknown error!!!', function(){});
													hideLoading();
												}
											},
											error:function (xhr, ajaxOptions, thrownError){
												alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
									            hideLoading();
									        }
										});		
										}	
									
										function clearAlert() {
										  clearTimeout(timeoutID);
										}
										function clearAlert() {
											  clearTimeout(timeoutID2);
											}
				
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						    
						        }
								
							});
						
							break;
						case 'einvoice_mtt-edit':
						case 'einvoice_mtt-copy':
						case 'einvoice_mtt-detail':
					
							objData = {};
							idx = $(checkRows[0].closest("tr")).index();
							rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							objData['_id'] = rowData['_id'];
							$('#divSubContent').show();$('#divMainContent').hide();
							submitFormRenderArea(ROOT_PATH + '/main/' + dataAction + '/init', objData, $('#divSubContent'));
							break;
							
						
						case 'einvoice_mtt-cre-dc-tt':
							objData = {};
							idx = $(checkRows[0].closest("tr")).index();
							rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							objData['_id'] = rowData['_id'];
							$('#divSubContent').show();$('#divMainContent').hide();
							submitFormRenderArea(ROOT_PATH + '/main/einvoice_mtt-cre/init-dc-tt', objData, $('#divSubContent'));
							break;
						case 'einvoice_mtt-cre':
							$('#divSubContent').show();$('#divMainContent').hide();
							submitFormRenderArea(ROOT_PATH + '/main/' + dataAction + '/init', objData, $('#divSubContent'));
							break;
						case 'search':
							_gridMain.data("kendoGrid").dataSource.page(1);
							
							
							
							
							break;
						case 'deletesearch':
							$('#f-einvoice_mtt').find('#mau-so-hdon,#so-hoa-don,#status,#sign-status,#nban-mst,#nban-ten').val('');
							_gridMain.data("kendoGrid").dataSource.page(1);
							break;
						
						case 'einvoice-pdfAll':
							var objData = null;
							var ids = null;
							ids = [];
							checkRows.each(function(i, v) {
							    idx = $(checkRows[i].closest("tr")).index();
							    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							    ids.push(rowData['_id']);
							});	
							objData =  encodeObjJsonBase64UTF8(ids);
							window.open(ROOT_PATH + '/common/print-einvoiceAll/' + objData,'_blank');
							break;
						case 'einvoice-pdfCD':
							var objData = null;
							var ids = null;
							ids = [];
							checkRows.each(function(i, v) {
							    idx = $(checkRows[i].closest("tr")).index();
							    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							    ids.push(rowData['_id']);
							});	
							objData =  encodeObjJsonBase64UTF8(ids);
							window.open(ROOT_PATH + '/common/print-einvoiceCD/' + objData,'_blank');
							break;
						case 'einvoice-xml':
							var objData = null;
							var ids = null;
							ids = [];
							checkRows.each(function(i, v) {
							    idx = $(checkRows[i].closest("tr")).index();
							    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
							    ids.push(rowData['_id']);
							});	
							objData =  encodeObjJsonBase64UTF8(ids);
							window.open(ROOT_PATH + '/common/einvoiceXml/' + objData,'_blank');
						break;
						case 'einvoice_mtt_list-send':									
							ids = [];
							objData = {};
							checkRows
									.each(function(i, v) {
										idx = $(checkRows[i].closest("tr")).index();
										rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
										ids.push(rowData['_id']);
									});
							/*CHECK THONG TIN HD*/
							objData = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							dsID = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
					
							$.ajax({	
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoice_mtt_list/send_list_cqt',
								data: objData,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											
											var responseData = res.responseData;
											
											var id_send = responseData['ID'];
												
											 _gridMain.data("kendoGrid").dataSource.read();
										 	 timeoutID = setTimeout(callSignMTT(id_send), 1000);								
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
									
				                    
				                      ///hàm ký hóa đơn máy tính tiền
				                      
				                      
				       function callSignMTT(id_send) {	
						objDataSend = {};							
						objDataSend['_id'] = id_send;
						$.ajax({
							type: "POST",
							datatype: "json",
							url: ROOT_PATH + '/main/einvoice_mtt-sign/check-data-signAll-mtt',
							data: objDataSend,
							beforeSend: function(req) {
								initAjaxJsonRequest(req);
					        	showLoading();
							},
							success:function(res) {
								if(res) {
									if(res.errorCode == 0) {
										var responseData = res.responseData;
										
										tokenTransaction = responseData['TOKEN'];
										objDataSend['tokenTransaction'] = tokenTransaction;
										
										var id_einvoice = responseData['ID'];							
																		
									   $.ajax({
	        
							          url: "http://localhost:11284/getCert",
							          type: 'POST',
							          cors: true ,
								          secure: true,
							          headers: {
							            'Access-Control-Allow-Origin': '*',
							            'Access-Control-Allow-Headers': '*',
							            'Access-Control-Allow-Private-Network': true
							          },
							          beforeSend: function(req) {
							            initAjaxJsonRequest(req);
							                showLoading();
							          },
							          success:function(res) {
							            hideLoading();
							            if(res != null) {
							            	var cert = res;           	
							             		$.ajax({
												type: "POST",
												url: ROOT_PATH + '/main/common/check-cert',
												data: {'cert':cert},
												beforeSend: function(req) {
													initAjaxJsonRequest(req);
										        	showLoading();
												},
												success:function(res) {
													hideLoading();
													if(res) {
														if(res.errorCode == 0) {																
													 	var responseData = res.responseData;														
															serialNumber = responseData['Seri'];
															//LAY NOI DUNG FILE XML
															jQuery.ajax({
																url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
														        cache:false,
														        xhr:function(){// Seems like the only way to get access to the xhr object
														            var xhr = new XMLHttpRequest();
														            xhr.responseType= 'blob'
														            return xhr;
														        },
														        success:function(data, textStatus, xhr) {
//														        	hideLoading();
															    	if(xhr.status == 200){
															    		var blob = new Blob([data], { type: 'octet/stream' });
															    		var postEnc = new FormData();
															    		postEnc.append('SerialNumber', serialNumber);
															    		postEnc.append('xmlFile', blob);
												    				
															    		var xhrSign = new XMLHttpRequest();
															    		xhrSign.onreadystatechange = function(e) {
															    			if(4 == this.readyState) {
															    				if(this.status == 200){	
															    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
															    					blob = new Blob( [this.response], { type : "octet/stream" } );
															    					showLoading();
															    				
															    					formData = new FormData();
																					formData.append("XMLFileSigned", blob);
																					formData.append('certificate', base64Cert.replace(/\+/g, "@"));
																				
																					
																					xhrSign = new XMLHttpRequest();
																					xhrSign.upload.addEventListener('progress', function(e) {
																						
																					});
																					if(xhrSign.upload) {
																						
																					};
																					xhrSign.onreadystatechange = function(e) {
																						if(4 == this.readyState && this.status == 200) {
																							var res = xhrSign.response;
																							if(res){
																								if(res.errorCode == 0) { 
																									hideLoading();
																								     _gridMain.data("kendoGrid").dataSource.read();
																								     
																								     console.log("I'm Here!!!")
																										//  timeoutID = setTimeout(callsend_cqt, 1000);
													
																								}else{
																									alertDLSuccess(
																											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																									
																										
																											);
																			            			hideLoading();
																			            			$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
																			            		}
																							}else{
																								alertDLSuccess(
																										'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																									
																									
																										);
																								hideLoading();
																								 
																			            	}
																						}
																					}
																					xhrSign.onerror = function() {
																						
																					}
																					xhrSign.ontimeout = function() {
																						
																					}
																				
																					
																					var urlPost = ROOT_PATH + '/main/einvoice_mtt-sign/signAllFileMTT/'+ id_einvoice;
																					xhrSign.open("POST", urlPost, true);
																					xhrSign.responseType = 'json';
																					xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																					xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																					
																					xhrSign.setRequestHeader('Cache-Control', 'no-cache');
																				
																					xhrSign.send(formData);
															    				}else{
																					hideLoading();
																					alertDLSuccess(
																							'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																						
																						
																							);
																				}
															    			}
															    		}
															    		xhrSign.open('POST', urlPluginSign + signXMLMTT, true);
																		xhrSign.timeout = 5 * 60 * 1000;
																		xhrSign.responseType = 'blob';	//or arraybuffer
																		xhrSign.send(postEnc);
															    	}else{
															    		
															    		hideLoading();
															    		alertDLSuccess(
																				'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																			
																			
																				);
																	}
															    
														        },
														        error:function(){
														        	
														        }
															});
															/* } */
														}else{
															alertDLSuccess(createObjectError(res).html(), function(){});
															
														}
													}else{
														alertDLSuccess(
																'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
														
															
																);
														hideLoading();
														
													}
													
												
												},
												error:function (xhr, ajaxOptions, thrownError){
													alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
										            hideLoading();
										            
										        }
											});										
	            }else{
	            	alertDLSuccess(
							'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
					
						
							);
												hideLoading();
												$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
												return;
	            }
	          },
	          error:function (xhr, ajaxOptions, thrownError){
	        	  alertDLSuccess(
							'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',				
						
							);
					hideLoading();
					$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
					return;
	          }
	        });
									
									
									
									
									}else{
										 $("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
										hideLoading();
										alertDLSuccess(createObjectError(res).html(), function(){});
									}
								}else{
									
									alertDLSuccess(
											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn. Vui lòng kiểm tra lại!!!<span>',																					
											);
									hideLoading();
								}
								
			

									function clearAlert() {
									  clearTimeout(timeoutID);
									}
									function clearAlert() {
										  clearTimeout(timeoutID2);
										}
			
							},
							error:function (xhr, ajaxOptions, thrownError){
								alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
					            hideLoading();
					    
					        }
							
						});
					
		} 
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
								
								
							});		
						break;
						
						case 'einvoice_mtt_list-sendAll':														
							var dataDate = {};				
							dataDate['date'] = $('#f-einvoice_mtt').find('#date').val();
																		
							$.ajax({	
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoice_mtt_list/einvoice_mtt_list-sendAll',
								data: dataDate,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											
											var responseData = res.responseData;											
											var id_send = responseData['ID'];
											
											 _gridMain.data("kendoGrid").dataSource.read();	
											 timeoutID = setTimeout(callSignMTT(id_send), 1000);			 
											 
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
									
							           ///hàm ký hóa đơn máy tính tiền
				                      
				                      
								       function callSignMTT(id_send) {	
										objDataSend = {};							
										objDataSend['_id'] = id_send;
										$.ajax({
											type: "POST",
											datatype: "json",
											url: ROOT_PATH + '/main/einvoice_mtt-sign/check-data-signAll-mtt',
											data: objDataSend,
											beforeSend: function(req) {
												initAjaxJsonRequest(req);
									        	showLoading();
											},
											success:function(res) {
												if(res) {
													if(res.errorCode == 0) {
														var responseData = res.responseData;
														
														tokenTransaction = responseData['TOKEN'];
														objDataSend['tokenTransaction'] = tokenTransaction;
														
														var id_einvoice = responseData['ID'];							
																						
													   $.ajax({
					        
											          url: "http://localhost:11284/getCert",
											          type: 'POST',
											          cors: true ,
												          secure: true,
											          headers: {
											            'Access-Control-Allow-Origin': '*',
											            'Access-Control-Allow-Headers': '*',
											            'Access-Control-Allow-Private-Network': true
											          },
											          beforeSend: function(req) {
											            initAjaxJsonRequest(req);
											                showLoading();
											          },
											          success:function(res) {
											            hideLoading();
											            if(res != null) {
											            	var cert = res;           	
											             		$.ajax({
																type: "POST",
																url: ROOT_PATH + '/main/common/check-cert',
																data: {'cert':cert},
																beforeSend: function(req) {
																	initAjaxJsonRequest(req);
														        	showLoading();
																},
																success:function(res) {
																	hideLoading();
																	if(res) {
																		if(res.errorCode == 0) {																
																	 	var responseData = res.responseData;														
																			serialNumber = responseData['Seri'];
																			//LAY NOI DUNG FILE XML
																			jQuery.ajax({
																				url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
																		        cache:false,
																		        xhr:function(){// Seems like the only way to get access to the xhr object
																		            var xhr = new XMLHttpRequest();
																		            xhr.responseType= 'blob'
																		            return xhr;
																		        },
																		        success:function(data, textStatus, xhr) {
//																		        	hideLoading();
																			    	if(xhr.status == 200){
																			    		var blob = new Blob([data], { type: 'octet/stream' });
																			    		var postEnc = new FormData();
																			    		postEnc.append('SerialNumber', serialNumber);
																			    		postEnc.append('xmlFile', blob);
																    				
																			    		var xhrSign = new XMLHttpRequest();
																			    		xhrSign.onreadystatechange = function(e) {
																			    			if(4 == this.readyState) {
																			    				if(this.status == 200){	
																			    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
																			    					blob = new Blob( [this.response], { type : "octet/stream" } );
																			    					showLoading();
																			    				
																			    					formData = new FormData();
																									formData.append("XMLFileSigned", blob);
																									formData.append('certificate', base64Cert.replace(/\+/g, "@"));
																								
																									
																									xhrSign = new XMLHttpRequest();
																									xhrSign.upload.addEventListener('progress', function(e) {
																										
																									});
																									if(xhrSign.upload) {
																										
																									};
																									xhrSign.onreadystatechange = function(e) {
																										if(4 == this.readyState && this.status == 200) {
																											var res = xhrSign.response;
																											if(res){
																												if(res.errorCode == 0) { 
																													hideLoading();
																												     _gridMain.data("kendoGrid").dataSource.read();
																													//	  timeoutID = setTimeout(callsend_cqt, 1000);
																													console.log("I am here!!!")
																	
																												}else{
																													alertDLSuccess(
																															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																													
																														
																															);
																							            			hideLoading();
																							            			$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
																							            		}
																											}else{
																												alertDLSuccess(
																														'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																													
																													
																														);
																												hideLoading();
																												 
																							            	}
																										}
																									}
																									xhrSign.onerror = function() {
																										
																									}
																									xhrSign.ontimeout = function() {
																										
																									}
																								
																									
																									var urlPost = ROOT_PATH + '/main/einvoice_mtt-sign/signAllFileMTT/'+ id_einvoice;
																									xhrSign.open("POST", urlPost, true);
																									xhrSign.responseType = 'json';
																									xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																									xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																									
																									xhrSign.setRequestHeader('Cache-Control', 'no-cache');
																								
																									xhrSign.send(formData);
																			    				}else{
																									hideLoading();
																									alertDLSuccess(
																											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																										
																										
																											);
																								}
																			    			}
																			    		}
																			    		xhrSign.open('POST', urlPluginSign + signXMLMTT, true);
																						xhrSign.timeout = 5 * 60 * 1000;
																						xhrSign.responseType = 'blob';	//or arraybuffer
																						xhrSign.send(postEnc);
																			    	}else{
																			    		
																			    		hideLoading();
																			    		alertDLSuccess(
																								'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																							
																							
																								);
																					}
																			    
																		        },
																		        error:function(){
																		        	
																		        }
																			});
																			/* } */
																		}else{
																			alertDLSuccess(createObjectError(res).html(), function(){});
																			
																		}
																	}else{
																		alertDLSuccess(
																				'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
																		
																			
																				);
																		hideLoading();
																		
																	}
																	
																
																},
																error:function (xhr, ajaxOptions, thrownError){
																	alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
														            hideLoading();
														            
														        }
															});										
					            }else{
					            	alertDLSuccess(
											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',
									
										
											);
																hideLoading();
																$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
																return;
					            }
					          },
					          error:function (xhr, ajaxOptions, thrownError){
					        	  alertDLSuccess(
											'<span class="text-error">Lỗi khi thực hiện ký hóa đơn.<span>',				
										
											);
									hideLoading();
									$("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
									return;
					          }
					        });
													
													
													
													
													}else{
														 $("#f-einvoice_mtt").find('#grid').find(".k-pager-refresh").trigger('click');
														hideLoading();
														alertDLSuccess(createObjectError(res).html(), function(){});
													}
												}else{
													
													alertDLSuccess(
															'<span class="text-error">Lỗi khi thực hiện ký hóa đơn. Vui lòng kiểm tra lại!!!<span>',																					
															);
													hideLoading();
												}
												
							

													function clearAlert() {
													  clearTimeout(timeoutID);
													}
													function clearAlert() {
														  clearTimeout(timeoutID2);
														}
							
											},
											error:function (xhr, ajaxOptions, thrownError){
												alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
									            hideLoading();
									    
									        }
											
										});
									
						} 
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							});		
						break;
						case 'einvoice_mtt-send-cqt':									
							ids = [];
							objData = {};
							checkRows
									.each(function(i, v) {
										idx = $(
												checkRows[i]
														.closest("tr"))
												.index();
										rowData = _gridMain
												.data(
														"kendoGrid")
												.dataItem(
														_gridMain
																.find(
																		' tbody tr')
																.eq(
																		idx));
										ids
												.push(rowData['_id']);
									});
							/*CHECK THONG TIN HD*/
							objData = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							dsID = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							
							var objURL = {};
							objURL['check'] = ROOT_PATH
									+ '/main/einvoice_mtt-send-cqtAll/check-dataAll';
							objURL['exec'] = ROOT_PATH
									+ '/main/einvoice_mtt-send-cqtAll/exec-dataAll';

							$
									.ajax({
										type : "POST",
										datatype : "json",
										url : objURL['check'],
										data : dsID,
										beforeSend : function(
												req) {
											initAjaxJsonRequest(req);
											showLoading();
										},
										success : function(
												res) {
											hideLoading();
											if (res) {
												if (res.errorCode == 0) {
													var responseData = res.responseData;
													tokenTransaction = responseData['TOKEN'];
													dsID['tokenTransaction'] = tokenTransaction;
													$
															.ajax({
																type : "POST",
																datatype : "json",
																url : objURL['exec'],
																data : dsID,
																beforeSend : function(
																		req) {
																	initAjaxJsonRequest(req);
																	showLoading();
																},
																success : function(
																		res) {
																	hideLoading();
																	if (res) {
																		if (res.errorCode == 0) {
																			_gridMain
																					.data("kendoGrid").dataSource
																					.read();
																		} else {
																			alertDLSuccess(
																					createObjectError(
																							res)
																							.html(),
																					function() {
																					});
																		}
																	} else {
																		alertDLSuccess(
																				'unknown error!!!',
																				function() {
																				});
																		hideLoading();
																	}
																},
																error : function(
																		xhr,
																		ajaxOptions,
																		thrownError) {
																	alertDLSuccess(
																			xhr.status
																					+ " - "
																					+ xhr.responseText,
																			function() {
																			});
																	hideLoading();
																}
															});

												} else {
													alertDLSuccess(
															createObjectError(
																	res)
																	.html(),
															function() {
															});
												}
											} else {
												alertDLSuccess(
														'unknown error!!!',
														function() {
														});
												hideLoading();
											}
										},
										error : function(
												xhr,
												ajaxOptions,
												thrownError) {
											alertDLSuccess(
													xhr.status
															+ " - "
															+ xhr.responseText,
													function() {
													});
											hideLoading();
										}
									});
						break;
						case 'einvoice-refreshAll':									
							ids = [];
							objData = {};
							checkRows
									.each(function(i, v) {
										idx = $(
												checkRows[i]
														.closest("tr"))
												.index();
										rowData = _gridMain
												.data(
														"kendoGrid")
												.dataItem(
														_gridMain
																.find(
																		' tbody tr')
																.eq(
																		idx));
										ids
												.push(rowData['_id']);
									});
							/*CHECK THONG TIN HD*/
							objData = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							dsID = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
					
							$.ajax({	
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/einvoices/refreshAll-status-cqt',
								data: objData,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											 _gridMain.data("kendoGrid").dataSource.read();
											 
										/* 		var responseData = res.responseData;
												
												var idSendMail = responseData['IDSendMail'];
										
												var objURL = {};	
											objURL['check'] = ROOT_PATH + '/main/einvoice-sendAll-emailauto/check-data-sendAll';
											objURL['exec'] = ROOT_PATH + '/main/einvoice-sendAll-emailauto/send-mailAll';
											objData = {
													_token : idSendMail
												};
											
											$.ajax({
												type: "POST",
												datatype: "json",
												url: objURL['check'],
												data: objData,
												beforeSend: function(req) {
													initAjaxJsonRequest(req);
										        	showLoading();
												},
												success:function(res) {
													hideLoading();
													if(res) {
														if(res.errorCode == 0) {
															var responseData = res.responseData;
															tokenTransaction = responseData['TOKEN'];
															
															objData['tokenTransaction'] = tokenTransaction;

																	$.ajax({
																		type: "POST",
																		datatype: "json",
																		url: objURL['exec'],
																		data: objData,
																		beforeSend: function(req) {
																			initAjaxJsonRequest(req);
																        	showLoading();
																		},
																		success:function(res) {
																			hideLoading();
																			if(res) {
																				if(res.errorCode == 0) {
																					_gridMain.data("kendoGrid").dataSource.read();
																				}else{
																					alertDLSuccess(createObjectError(res).html(), function(){});
																				}
																			}else{
																				alertDLSuccess('unknown error!!!', function(){});
																				hideLoading();
																			}
																		},
																		error:function (xhr, ajaxOptions, thrownError){
																			alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
																            hideLoading();
																        }
																	});
															
																
														
														}else{
															alertDLSuccess(createObjectError(res).html(), function(){});
														}
													}else{
														alertDLSuccess('unknown error!!!', function(){});
														hideLoading();
													}
												},
												error:function (xhr, ajaxOptions, thrownError){
													alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
										            hideLoading();
										        }
											});  */
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							});		
						break;
						
						
						case 'einvoice-sendMailAll':									
							ids = [];
							objData = {};
							checkRows
									.each(function(i, v) {
										idx = $(
												checkRows[i]
														.closest("tr"))
												.index();
										rowData = _gridMain
												.data(
														"kendoGrid")
												.dataItem(
														_gridMain
																.find(
																		' tbody tr')
																.eq(
																		idx));
										ids
												.push(rowData['_id']);
									});
							/*CHECK THONG TIN HD*/
							objData = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
							dsID = {
								_token : encodeObjJsonBase64UTF8(ids)
							};
						
							var objURL = {};	
							objURL['check'] = ROOT_PATH + '/main/einvoice-sendAll-emailauto/check-data-sendAll';
							objURL['exec'] = ROOT_PATH + '/main/einvoice-sendAll-emailauto/send-mailAll';
							
							$.ajax({
								type: "POST",
								datatype: "json",
								url: objURL['check'],
								data: objData,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
									if(res) {
										if(res.errorCode == 0) {
											var responseData = res.responseData;
											tokenTransaction = responseData['TOKEN'];
											
											objData['tokenTransaction'] = tokenTransaction;

													$.ajax({
														type: "POST",
														datatype: "json",
														url: objURL['exec'],
														data: objData,
														beforeSend: function(req) {
															initAjaxJsonRequest(req);
												        	showLoading();
														},
														success:function(res) {
															hideLoading();
															if(res) {
																if(res.errorCode == 0) {
																	_gridMain.data("kendoGrid").dataSource.read();
																}else{
																	alertDLSuccess(createObjectError(res).html(), function(){});
																}
															}else{
																alertDLSuccess('unknown error!!!', function(){});
																hideLoading();
															}
														},
														error:function (xhr, ajaxOptions, thrownError){
															alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
												            hideLoading();
												        }
													});
											
												
										
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							}); 		
						break;
						default:
							break;
						}
					});

				});

				
		    
				
				function getDataSearch(){
					var dataPost = {};
					
					dataPost['mau-so-hdon'] = $('#f-einvoice_mtt #mau-so-hdon').val() == null? '': $('#f-einvoice_mtt #mau-so-hdon').val();
					dataPost['so-hoa-don'] = $('#f-einvoice_mtt #so-hoa-don').val() == null? '': $('#f-einvoice_mtt #so-hoa-don').val();
					
					dataPost['date'] = $('#f-einvoice_mtt #date').val() == null? '': $('#f-einvoice_mtt #date').val();
					dataPost['status'] = $('#f-einvoice_mtt #status').val() == null? '': $('#f-einvoice_mtt #status').val();
					dataPost['send-cqt-status'] = $('#f-einvoice_mtt #send-cqt-status').val() == null? '': $('#f-einvoice_mtt #send-cqt-status').val();
					dataPost['nban-mst'] = $('#f-einvoice_mtt #nban-mst').val() == null? '': $('#f-einvoice_mtt #nban-mst').val();
					dataPost['nban-ten'] = $('#f-einvoice_mtt #nban-ten').val() == null? '': $('#f-einvoice_mtt #nban-ten').val();
					
					return dataPost;
				}

				function disableEnabledAllButton(){
			
					var checkRows = _gridMain.find(' tbody tr input[type="checkbox"]:checked');
					$("#f-einvoice_mtt").find('button[data-action="einvoice-pdfAll"]').prop('disabled', checkRows.length == 0);
					$('#f-einvoice_mtt').find('button[data-action="einvoice_mtt-delete"]').prop('disabled', checkRows.length == 0);
					$('#f-einvoice_mtt').find('button[data-action="einvoice-delete_"]').prop('disabled', checkRows.length == 0);
				}

				function setTemplateForGridMAIN(key, data){
					var signStatusCode = data['SignStatusCode'];
					var eInvoiceStatus = data['EInvoiceStatus'];
					var MCCQT = data['MCCQT'] == null? '': data['MCCQT'];
					var text = '';
				
					switch (key) {
					case 'func':
						
							text += '<i title="Xem hóa đơn pdf" class="mdi mdi-file-pdf fs-25 text-red c-pointer" data-sub-action="print" ></i>';												
						break;
					case 'StatusDesc':
						if('DELETED' == data['EInvoiceStatus']){
							text = '<div style="background: red;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						
						else if('XOABO' == data['EInvoiceStatus']){
							text = '<div style="background: red;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						else if('REPLACED' == data['EInvoiceStatus']){
							text = '<div style="background: #FFFF66;border-radius: 10px;color: black;">' + data['StatusDesc'] + '</div>';
						}
						else if('ADJUSTED' == data['EInvoiceStatus']){
							text = '<div style="background: #CC99CC;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						else if('COMPLETE' == data['EInvoiceStatus']){
							text = '<div style="background: #85DE77;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						else if('CREATED' == data['EInvoiceStatus']){
							text = '<div style="background: #669966;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						else if('PROCESSING' == data['EInvoiceStatus']){
							text = '<div style="background: #000099;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						else if('PENDING' == data['EInvoiceStatus']){
							text = '<div style="background: #0033FF;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						/* else if('PENDING' == data['EInvoiceStatus'] && 'SIGNED' == data['SignStatusCode']){
							text = '<div style="background: #0033FF;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						} */
						else if('ERROR_CQT' == data['EInvoiceStatus']){
							text = '<div style="background: #666666;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
						}
						
						else{
							text = data['StatusDesc'];
						}
						break;

					default:
						break;
					}
					
					return text;
				}
			

				</script>
			</div>
		</div>
		
	</th:block>
	
</body>
</html>