<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" 
	xmlns:th="http://www.thymeleaf.org" 
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout/layout-main}">
<body>
	<th:block layout:fragment="content">
		<style>
				.text-red{
				color: red;
				}
				</style>
		<div class="row page-titles">
			<div class="col-md-12 col-12 align-self-center p-l-0">
				<h3 class="text-themecolor m-b-0 m-t-0 text-uppercase">Danh sách xuất kho kiêm vận chuyển nội bộ</h3>
			</div>
		</div>
		<div class="row">
			<div class="col-12">
				<form id="f-export" name="f-export" method="post" enctype="multipart/form-data" >
					<div class="card">
						<div class="card-body">
							<div class="filter__list--erp">
								<div class="col-erp-5">
									<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<select class="form-control form-control-sm c-f__textbox" id="mau-so-hdon" name="mau-so-hdon" >
													<option value=""></option>
													<th:block th:if="${map_mausokyhieu != null}">
														<option th:each="entry : ${map_mausokyhieu.entrySet()}"
															th:value="${entry.key}" th:utext="${entry.value}" > </option>
													</th:block>
												</select>
												<fieldset aria-hidden="true" class="c-f__set">
													<legend class="c-f__legend"><label>Mẫu hóa đơn</label></legend>
												</fieldset>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox" type="text" id="from-date" name="from-date" th:value="${FromDate}" autocomplete="off"/>
												<fieldset aria-hidden="true" class="c-f__set">
													<legend class="c-f__legend"><label>Từ ngày </label></legend>
												</fieldset>
											</div>
										</div>
									</div>
								</div>
								<div class="col-erp-5">
									<div class="row m-b-16">
										<div class="col-12 custom-field">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox" type="text" id="so-hoa-don" name="so-hoa-don" value="" autocomplete="off" />
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Số hóa đơn</label></legend></fieldset>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox" type="text" id="to-date" name="to-date" th:value="${ToDate}" autocomplete="off" />
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Đến ngày</label></legend></fieldset>
											</div>
										</div>
									</div>
								</div>
								<div class="col-erp-5">
									<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<select class=" form-control form-control-sm c-f__textbox" id="status" name="status" tabindex="-1" aria-hidden="true" >
													<option value=""></option>
													<th:block th:if="${map_status != null}">
														<option th:each="entry : ${map_status.entrySet()}"
																th:value="${entry.key}" th:utext="${entry.value}" > </option>
													</th:block>
												</select>
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Trạng thái phiếu xuất</label></legend></fieldset>
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-12">
											<div class="custom-field m-b-16">
												<div class="c-f__wrapper">
													<select class=" form-control form-control-sm c-f__textbox" id="sign-status" name="sign-status" tabindex="-1" aria-hidden="true" >
														<option value=""></option>
														<th:block th:if="${map_sign_status != null}">
															<option th:each="entry : ${map_sign_status.entrySet()}"
																th:value="${entry.key}" th:utext="${entry.value}" > </option>
														</th:block>
													</select>
													<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Đã ký</label></legend></fieldset>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="col-erp-5">
									<div class="row">
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox "type="text" id="nban-mst" name="nban-mst" value="" autocomplete="off" />
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>MST khách hàng</label></legend></fieldset>
											</div>
										</div>
										<div class="col-12 custom-field m-b-16">
											<div class="c-f__wrapper">
												<input class="form-control form-control-sm c-f__textbox " type="text" id="nban-ten" name="nban-ten" value="" autocomplete="off"/>
												<fieldset aria-hidden="true" class="c-f__set"><legend class="c-f__legend"><label>Khách hàng</label></legend></fieldset>
											</div>
										</div>
									</div>
								</div>
								<div class="col-erp-5 col-erp__cta">
									<div class="row">
										<div class="col-12">
											<button class=" btns btns-search_auto__ses hover-up__ses w-100p" data-action="search" title="Tìm kiếm" type="button" > <i class="mdi mdi-file-find"></i><span class="d-none d-md-inline">Tìm kiếm</span></button>
										</div>
									</div>
								</div>
							</div>
							
							<div class="row"><div class="col-12"><hr style="margin: 0 0 10px 0" /></div></div>
							<div class="col-12">
								<div class="row mT-0">
									                           		
                            		<div class="col-12 col-sm-12 text-right p-r-0 p-l-0">
                            			<div class="button-group text-right">
                            				<button type="button" title="Import danh sách" data-action="export-import" class="m-b-5 btns import_ds btns-import__ses-1 hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-import|')}" >
												<i class="mdi mdi-file-excel"> </i><span class="d-none d-md-inline"> Import danh sách</span>
											</button>   
												<button type="button" title="Xuất XML" data-action="export-xml" class="btns xuat_xml hover-up__ses" disabled="disabled" th:if="${#strings.contains(UserFullPathRight,'|export-xml|')}">
                            					<i class="mdi mdi-xml"> </i><span class="d-none d-md-inline">Xuất XML</span>
                            				</button>
                            				 <button type="button" title="Xuất PDF hàng loạt" data-action="export-pdfAll" class="btns in_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-pdfAll|')}">
                            					<i class="mdi  mdi-file-pdf"> </i><span class="d-none d-md-inline">Xuất PDF hàng loạt</span>
                            				</button>
                            				<button type="button" title="Xuất PDF chuyển đổi" data-action="export-pdfCD" class="btns in_cd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-pdfCD|')}" >
										  	<i class="mdi mdi-folder-move"></i><span class="d-none d-md-inline"
											  >Xuất PDF Chuyển Đổi</span
											  >
										   </button>
                            				<button type="button" title="Thêm mới" data-action="export-cre" class="btns tmoi_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-cre|')}">
                            					<i class="mdi mdi mdi-plus-circle-outline"> </i><span class="d-none d-md-inline">Thêm mới</span>
                            				</button>
                            				<button type="button" title="Chi tiết" data-action="export-detail" class="btns ctiet_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-detail|')}">
                            					<i class="mdi mdi-information-outline"> </i><span class="d-none d-md-inline">Chi tiết</span>
                            				</button>
                            						<button type="button" title="Copy" data-action="export-copy" class="btns coppy_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-copy|')}" >
                            					<i class="mdi mdi-content-copy"> </i><span class="d-none d-md-inline">Copy</span>
                            				</button>
                            				<button type="button" title="Thay đổi" data-action="export-edit" class="btns tdoi_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-edit|')}"  >
                            					<i class="mdi mdi-tooltip-edit"> </i><span class="d-none d-md-inline">Thay đổi</span>
                            				</button>
                            				<button type="button" title="Ký hóa đơn" data-action="export-sign" class="btns ky_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-sign|')}" >
                            					<i class="mdi mdi-account-check-outline"> </i><span class="d-none d-md-inline">Ký hóa đơn</span>
                            				</button>
                            				
                            			<button type="button" title="Thêm mới HĐ Điều chỉnh/Thay thế" data-action="export-cre-dc-tt" class="btns dc_tt_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-cre-dc-tt|')}"
                            					th:disabled="true">
                            					<i class="mdi mdi mdi-plus-circle-outline"> </i><span class="d-none d-md-inline">Thêm mới hđ điều chỉnh/thay thế</span>
                            				</button>
                            					   <button type="button"  title="Xóa hàng loạt" data-action="export-delete" class="btns xoa_hd hover-up__ses" th:if="${#strings.contains(UserFullPathRight,'|export-del|')}">
										   <i class="mdi mdi-delete"> </i
											  ><span class="d-none d-md-inline">Xóa hàng loạt</span>
										   </button>
                            			<th:block th:if="false">
                            				
                            				<button type="button" title="Thay đổi" data-action="edit" class="btns tdoi_hd hover-up__ses" disabled="">
                            					<i class="mdi mdi-tooltip-edit"> </i><span class="d-none d-md-inline">Thay đổi</span>
                            				</button>
                            				<button type="button" title="Chi tiết" data-action="detail" class="btns ky_hd hover-up__ses" disabled="" >
                            					<i class="mdi mdi-check-all"> </i><span class="d-none d-md-inline">Ký hàng loạt</span>
                            				</button>
                            				<button type="button" title="Xóa" data-action="delete" class="btns xoa_hd hover-up__ses" disabled="">
                            					<i class="mdi mdi-close-box"> </i><span class="d-none d-md-inline">Xóa</span>
                            				</button>
                            			</th:block>
                            			
                            			</div>
                            		</div>
                            	
                            	</div>
                            </div>
                            
                            <div class="form-group row m-b-5 m-t-7" >
	           					<div class="col-12 has-min-height-grid">
	           						<div id="grid" ></div>
	           					</div>
	           				</div>
							
						</div>
					</div>
                      
                      
				</form>
				<script type="text/javascript">
				_gridMain = $('#f-export').find('#grid');
				</script>
 <!-- <script th:src="@{/static/function/export/export.js(v=3.18)}"></script> 
  -->
 
<script type="text/javascript">

$(function(){
	dateInputFormat($('#f-export').find('#from-date'));
	dateInputFormat($('#f-export').find('#to-date'));
	
	_gridMain.kendoGrid({
		dataSource: new kendo.data.DataSource({
			transport: {
				read: {
					type: 'POST',
					url: ROOT_PATH + '/main/export/search',
                    dataType: 'json',
                    data: function(){return getDataSearch();},
                    beforeSend: function(req){
                    	initAjaxJsonGridRequest(req);
                	},
				}
			},
			requestEnd: function (e) {
               	if (e.type === "read" && e.response) {
               		if(e.response.errorCode == 0){
               		}else{
               			notificationDLSuccess(createObjectError(e.response).html(), function(){});
               		}
               	}
           	},
            schema: {
				data: "rows",
                total: "total",
                model: {
					fields: {
					}
				}
			},
			pageSize: KENDOUI_PAGESIZE_NO_SCROLL_Y,
			serverPaging: true,
			serverSorting: true,
           	serverFiltering: true,
           	change: function(e) {
            },
		}),
		selectable: true, scrollable: true, 
 		sortable: {mode: "single", allowUnsort: true},
		sortable: true,
// 		filterable: { mode: "row"},
		filterable: false, resizable: true,
		serverSorting: false,
//		height: kendoGridHeight,
		pageable: {
			refresh: true,
			pageSizes: true,
			buttonCount: KENDOUI_BUTTONCOUNT,
			messages: {
				itemsPerPage: kendoGridMessages.itemsPerPage,
				previous: kendoGridMessages.previous,
				next: kendoGridMessages.next,
				refresh: kendoGridMessages.refresh,
				last: kendoGridMessages.last,
				first: kendoGridMessages.first,
				empty: kendoGridMessages.empty,
				display: kendoGridMessages.display
			},
			pageSizes: KENDOUI_PAGESIZES,
			numeric: true
		},
		dataBinding: function () {
            record = (this.dataSource.page() - 1) * this.dataSource.pageSize();
        },
        columns: [
        	{field: 'STT', width: '60px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">STT</a>',
  				attributes: {'class': 'table-cell text-center'}, sortable: false, 
  				headerAttributes: {'class': 'table-header-cell text-center'}, template: "#= ++record #",
  			},
  			{field: 'isCheck', title: '', width: '60px', encoded: false
				, headerTemplate: '<label class="custom-control custom-checkbox p-l-30 m-b-0"><input type="checkbox" class="custom-control-input Check-All" data-check-all ><span class="custom-control-label"></span></label>'
				, attributes: {'class': 'table-cell', style: 'text-align: center;'}, sortable: false
				, headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
				, template: '<label class="custom-control custom-checkbox p-l-30 m-b-3"><input type="checkbox" class="custom-control-input Check-Item" data-check-item ><span class="custom-control-label"></span></label>'
			},
  			{field: 'func', title: '', width: '130px', encoded: false
  				, headerTemplate: '&nbsp;'
				, attributes: {'class': 'table-cell', style: 'text-align: left;'}, sortable: false
				, headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
				, template: '#= window.setTemplateForGridMAIN("func", data) #'
			},
			{field: 'StatusDesc', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Trạng thái</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
				template: '#= window.setTemplateForGridMAIN("StatusDesc", data) #'
			},
			{field: 'SignStatusDesc', width: '140px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Đã ký</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
		
			{field: 'MCCQT', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã CQT</a>',
				attributes: {'class': 'table-cell text-left'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'CQTMTLoi', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Lỗi từ CQT</a>',
				attributes: {'class': 'table-cell text-left'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'MauSoHD', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mẫu số HĐ</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'ExportNumber', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Số hóa đơn</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'NLap', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày phát hành</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'TaxCode', width: '100px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã số thuế</a>',
				attributes: {'class': 'table-cell text-left'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'CompanyName', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tên đơn vị</a>',
				attributes: {'class': 'table-cell text-left'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'TgTTTBSo', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng cộng</a>',
				attributes: {'class': 'table-cell text-right'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'TgTCThue', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Tổng tiền</a>',
				attributes: {'class': 'table-cell text-right'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},	
			{field: 'MTDiep', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã thông điệp</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'MTDTChieu', width: '250px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Mã tham chiếu</a>',
				attributes: {'class': 'table-cell text-center'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'UserCreated', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Người lập</a>',
				attributes: {'class': 'table-cell text-left'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'SendCQT_Date', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày gửi mã hóa đơn</a>',
				attributes: {'class': 'table-cell text-left text-nowrap'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			{field: 'CQT_Date', width: '150px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Ngày cấp mã hóa đơn</a>',
				attributes: {'class': 'table-cell text-left text-nowrap'}, sortable: false, 
				headerAttributes: {'class': 'table-header-cell text-center'},
			},
			
    	],
		dataBound: function(e) {
//			_gridMain.find('div table tbody tr td').each(function(idx, obj){
//				$(obj).attr('title', $(obj).html())
//			});
			
			$("#f-export").find('button[data-action="export-detail"], button[data-action="export-edit"], button[data-action="export-copy"],button[data-action="export-cre-dc-tt"], button[data-action="export-sign"]').prop('disabled', true);
			
			_gridMain.find('tbody[role="rowgroup"]').find('tr').undelegate('i[data-sub-action]', 'click');
			_gridMain.find('tbody[role="rowgroup"]').find('tr').delegate('i[data-sub-action]', 'click', function(e){
				e.preventDefault();/*e.stopPropagation();*/
				
				var $obj = $(this);
				var $tr = $obj.closest('tr');
				var subAction = $obj.attr('data-sub-action');
				
				var indexRow = $tr.index();
				var rowData = null;
				var objData = {};
				var objURL = {};
				
				switch (subAction) {	
				case 'history':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];
					$('#divSubContent').show();$('#divMainContent').hide();
					submitFormRenderArea(ROOT_PATH + '/main/export-history/history', objData, $('#divSubContent'));
					break;
				case 'change':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];
					$('#divSubContent').show();$('#divMainContent').hide();
					submitFormRenderArea(ROOT_PATH + '/main/export-change/change', objData, $('#divSubContent'));
					break;
				case 'send-email':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];
					showPopupWithURLAndData(ROOT_PATH + '/main/export-send-mail/init', objData, false, function(e){
					});
					break;
				case 'print':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					window.open(ROOT_PATH + '/main/common/print-export/' + rowData['_id'],'_blank');
					break;
				case 'delete_':
					
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];	
				
					$.ajax({
						type: "POST",
						datatype: "json",
						url: ROOT_PATH + '/main/export/delete_HD',
						data: objData,
						beforeSend: function(req) {
							initAjaxJsonRequest(req);
				        	showLoading();
						},
						success:function(res) {
							
							hideLoading();
							if(res) {
								if(res.errorCode == 0) {
									_gridMain.data("kendoGrid").dataSource.read();
								}else{
									alertDLSuccess(createObjectError(res).html(), function(){});
								}
							}else{
								alertDLSuccess('unknown error!!!', function(){});
								hideLoading();
							}
						},
						error:function (xhr, ajaxOptions, thrownError){
							alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
				            hideLoading();
				        }
					});	
					break;
				case 'print-convert':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					window.open(ROOT_PATH + '/common/print-export-convert/' + rowData['_id'],'_blank');
					break;
				case 'refresh':
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];
					$.ajax({
						type: "POST",
						datatype: "json",
						url: ROOT_PATH + '/main/export/refresh-status-cqt',
						data: objData,
						beforeSend: function(req) {
							initAjaxJsonRequest(req);
				        	showLoading();
						},
						success:function(res) {
							hideLoading();
							if(res) {
								if(res.errorCode == 0) {
									var objURL1 = {};
									objURL1['check'] = ROOT_PATH + '/main/export-send-emailauto/check-data-send';
									objURL1['exec'] = ROOT_PATH + '/main/export-send-emailauto/send-mail';
								
									$.ajax({
										type: "POST",
										datatype: "json",
										url: objURL1['check'],
										data: objData,
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
											if(res) {
												if(res.errorCode == 0) {
													var responseData = res.responseData;
													tokenTransaction = responseData['TOKEN'];
													
													objData['tokenTransaction'] = tokenTransaction;

															$.ajax({
																type: "POST",
																datatype: "json",
																url: objURL1['exec'],
																data: objData,
																beforeSend: function(req) {
																	initAjaxJsonRequest(req);
														        	showLoading();
																},
																success:function(res) {
																	hideLoading();
																	if(res) {
																		if(res.errorCode == 0) {
																			_gridMain.data("kendoGrid").dataSource.read();
																		}else{
																			alertDLSuccess(createObjectError(res).html(), function(){});
																		}
																	}else{
																		alertDLSuccess('unknown error!!!', function(){});
																		hideLoading();
																	}
																},
																error:function (xhr, ajaxOptions, thrownError){
																	alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
														            hideLoading();
														        }
															});
													
														
												
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});
								}else{
									alertDLSuccess(createObjectError(res).html(), function(){});
								}
							}else{
								alertDLSuccess('unknown error!!!', function(){});
								hideLoading();
							}
						},
						error:function (xhr, ajaxOptions, thrownError){
							alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
				            hideLoading();
				        }
					});					
					break;
				case 'delete':
				case 'send-cqt':					
					if('delete' == subAction){
						objURL['check'] = ROOT_PATH + '/main/export-del/check-data';
						objURL['exec'] = ROOT_PATH + '/main/export-del/exec-data';
					}else{
						objURL['check'] = ROOT_PATH + '/main/export-send-cqt/check-data';
						objURL['exec'] = ROOT_PATH + '/main/export-send-cqt/exec-data';
					}
					
					rowData = _gridMain.data("kendoGrid").dataItem($tr);
					objData['_id'] = rowData['_id'];
					$.ajax({
						type: "POST",
						datatype: "json",
						url: objURL['check'],
						data: objData,
						beforeSend: function(req) {
							initAjaxJsonRequest(req);
				        	showLoading();
						},
						success:function(res) {
							hideLoading();
							if(res) {
								if(res.errorCode == 0) {
									var responseData = res.responseData;
									
									var confirmText = responseData['CONFIRM'];
									tokenTransaction = responseData['TOKEN'];
									
									objData['tokenTransaction'] = tokenTransaction;
									
									alertConfirm(confirmText,
										function(e){
											$.ajax({
												type: "POST",
												datatype: "json",
												url: objURL['exec'],
												data: objData,
												beforeSend: function(req) {
													initAjaxJsonRequest(req);
										        	showLoading();
												},
												success:function(res) {
													hideLoading();
													if(res) {
														if(res.errorCode == 0) {
															_gridMain.data("kendoGrid").dataSource.read();
														}else{
															alertDLSuccess(createObjectError(res).html(), function(){});
														}
													}else{
														alertDLSuccess('unknown error!!!', function(){});
														hideLoading();
													}
												},
												error:function (xhr, ajaxOptions, thrownError){
													alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
										            hideLoading();
										        }
											});
										},
										function(e){}
									);
								}else{
									alertDLSuccess(createObjectError(res).html(), function(){});
								}
							}else{
								alertDLSuccess('unknown error!!!', function(){});
								hideLoading();
							}
						},
						error:function (xhr, ajaxOptions, thrownError){
							alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
				            hideLoading();
				        }
					});
					break;

				default:
					break;
				}
			});
			
		}
	});
	
	
	
	_gridMain.find('table[role="grid"]').find('thead').undelegate('input[type="checkbox"][data-check-all]', 'click');
	_gridMain.find('table[role="grid"]').find('thead').delegate('input[type="checkbox"][data-check-all]', 'click', function(e){
		var _obj = this;
		
		_gridMain.find('table[role="grid"] tbody input[type="checkbox"][data-check-item]').prop('checked', $(_obj).prop('checked'));
		if ($(_obj).prop('checked')) {
			_gridMain.find(' tbody tr').addClass("k-state-selected");
		}else{
			_gridMain.find(' tbody tr').removeClass("k-state-selected");
		}
		
		isDisabledEditDel();
	});
			
	
	_gridMain.find('table[role="grid"]').find('tbody').undelegate('tr', 'click');
	_gridMain.find('table[role="grid"]').find('tbody').delegate('tr', 'click', function(e){
		$("#f-export").find('button[data-action="export-detail"]').prop('disabled', false);	
		$("#f-export").find('button[data-action="export-copy"]').prop('disabled', false);	
		var $tr = $(this).closest("tr");
		var rowData = _gridMain.data("kendoGrid").dataItem($tr);
		$("#f-export").find('button[data-action="export-delete"]').prop('disabled', 'CREATED' == rowData['EInvoiceStatus']? false: true);
		$("#f-export").find('button[data-action="export-sign"]').prop('disabled', 'NOSIGN' == rowData['SignStatusCode']? false: true);
		$("#f-export").find('button[data-action="export-edit"]').prop('disabled', 'NOSIGN' == rowData['SignStatusCode']? false: true);
	
		

		if('Đã phát hành' == rowData['StatusDesc'] || 'Đã thay thế' == rowData['StatusDesc'] || 'Đã điều chỉnh' == rowData['StatusDesc'] || 'Đã xóa bỏ' == rowData['StatusDesc']){
				    /*           $("#f-export").find('button[data-action="export-pdfAll"]').prop('disabled', false); */
				              $("#f-export").find('button[data-action="export-xml"]').prop('disabled', false);
				              $("#f-export").find('button[data-action="export-pdfCD"]').prop('disabled', false);
				              $("#f-export").find('button[data-action="export-pdfAll"]').prop('disabled', false);
				            }else{
				             /*  $("#f-export").find('button[data-action="export-pdfAll"]').prop('disabled', true); */
				              $("#f-export").find('button[data-action="export-xml"]').prop('disabled', false);
				              $("#f-export").find('button[data-action="export-pdfCD"]').prop('disabled', true);
				              $("#f-export").find('button[data-action="export-pdfAll"]').prop('disabled', true);
				              
				            }	
			if('Đã xóa bỏ' == rowData['StatusDesc']){
						    $("#f-export").find('button[data-action="export-pdfAll"]').prop('disabled', true);
				              $("#f-export").find('button[data-action="export-xml"]').prop('disabled', true);
				          	$("#f-export").find('button[data-action="export-edit"]').prop('disabled', true);
				          	$("#f-export").find('button[data-action="export-sign"]').prop('disabled', true);
				          	$("#f-export").find('button[data-action="export-delete"]').prop('disabled', true);
				          	$("#f-export").find('button[data-action="export-delete"]').prop('disabled', true);
				          	 $("#f-export").find('button[data-action="export-pdfCD"]').prop('disabled', true);
						}
		
		if('2' == rowData['HDSS_TCTBao'] || '3' == rowData['HDSS_TCTBao']){
		$("#f-export").find('button[data-action="export-cre-dc-tt"]').prop('disabled', false);
	}else{
		$("#f-export").find('button[data-action="export-cre-dc-tt"]').prop('disabled', true);
	}
	});
	
	
	_gridMain.find('table[role="grid"]').find('thead').undelegate('input[type="checkbox"][data-check-all]', 'click');
	_gridMain.find('table[role="grid"]').find('thead').delegate('input[type="checkbox"][data-check-all]', 'click', function(e){
		var _obj = this;
		
		_gridMain.find('table[role="grid"] tbody input[type="checkbox"][data-check-item]').prop('checked', $(_obj).prop('checked'));
		if ($(_obj).prop('checked')) {
			_gridMain.find(' tbody tr').addClass("k-state-selected");
		}else{
			_gridMain.find(' tbody tr').removeClass("k-state-selected");
		}
		
		disableEnabledAllButton();
	});

	_gridMain.find('table[role="grid"]').find('tbody').undelegate('input[type="checkbox"][data-check-item]', 'click');
	_gridMain.find('table[role="grid"]').find('tbody').delegate('input[type="checkbox"][data-check-item]', 'click', function(e){
		var checked = $(this).prop('checked');
		if(checked){
			$(this).closest("tr").addClass("k-state-selected");
		}else{
			$(this).closest("tr").removeClass("k-state-selected");
		}
		_gridMain.find('table[role="grid"]').find('thead input[type="checkbox"]').prop('checked', _gridMain.find(' tbody tr input[type="checkbox"]:not(:checked)').length == 0);
		disableEnabledAllButton();
	});

	_gridMain.find('table[role="grid"]').find('tbody').undelegate('tr td:not(:eq(1))', 'click');
	_gridMain.find('table[role="grid"]').find('tbody').delegate('tr td:not(:eq(1))', 'click', function(e){
		var _obj = $(this).closest("tr");
		
		var _oldChecked = $(_obj).find('input[type=checkbox][data-check-item]').prop('checked');
		$(_obj).find('input[type=checkbox][data-check-item]').prop('checked', !_oldChecked);
		if(!_oldChecked){
			$(this).closest("tr").addClass("k-state-selected");
		}else{
			$(this).closest("tr").removeClass("k-state-selected");
		}
		_gridMain.find('table[role="grid"]').find('thead input[type="checkbox"]').prop('checked', _gridMain.find(' tbody tr input[type="checkbox"]:not(:checked)').length == 0);
		disableEnabledAllButton();
	});
	
	
	$("#f-export").find('button[data-action]').click(function (event) {
		event.preventDefault();/*event.stopPropagation();*/
		var dataAction = $(this).data('action');
		var objData = {};
		var $obj = $(this);
		
		var rowData = null;
		var actionCheck = '|export-edit|export-sign|export-detail|export-copy|export-xml|export-pdfAll|export-delete|export-pdfCD|';
		var checkRows = _gridMain.find(' tbody tr input[type="checkbox"]:checked');
		
		var ids = null;
		var idx = -1;
		if(actionCheck.indexOf('|' + dataAction + '|') != -1 && 0 == checkRows.length){
			alertDLSuccess('<span class="required">Vui lòng chọn dòng dữ liệu để thực hiện.</span>', function(){});
			return;
		}
		
		var objData = {};
		var objDataSend = {};
		switch (dataAction) {
			case 'export-import':
				showPopupWithURLAndData(ROOT_PATH + '/main/export-import/init', objData, true, function(e){
				});
			break;
			case 'export-sign':
				objDataSend = {};
				idx = $(checkRows[0].closest("tr")).index();
				rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
				objDataSend['_id'] = rowData['_id'];	
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/export-sign/check-data-sign',
					data: objDataSend,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						if(res) {
							if(res.errorCode == 0) {
								var responseData = res.responseData;
								
								tokenTransaction = responseData['TOKEN'];
								objDataSend['tokenTransaction'] = tokenTransaction;
								
							
							
							   $.ajax({
    
      url: "http://localhost:11284/getCert",
      type: 'POST',
      cors: true ,
          secure: true,
      headers: {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Headers': '*',
        'Access-Control-Allow-Private-Network': true
      },
      beforeSend: function(req) {
        initAjaxJsonRequest(req);
            showLoading();
      },
      success:function(res) {
        hideLoading();
        if(res != null) {
        	var cert = res;           	
         		$.ajax({
										type: "POST",
										url: ROOT_PATH + '/main/common/check-cert',
										data: {'cert':cert},
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
											if(res) {
												if(res.errorCode == 0) {
													var responseData = res.responseData;
													var check = responseData['check'];
													
													if(check==="300"){
														alertDLSuccess('Chứng thư số không hợp lệ (Chưa tồn tại CKS).', function(){});
											
													}else{
														serialNumber = responseData['Seri'];
															datetimeString = responseData['DateTime'];
													//LAY NOI DUNG FILE XML
													jQuery.ajax({
														url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
												        cache:false,
												        xhr:function(){// Seems like the only way to get access to the xhr object
												            var xhr = new XMLHttpRequest();
												            xhr.responseType= 'blob'
												            return xhr;
												        },
												        success:function(data, textStatus, xhr) {
//												        	hideLoading();
													    	if(xhr.status == 200){
													    		var blob = new Blob([data], { type: 'octet/stream' });
													    		var postEnc = new FormData();
													    		postEnc.append('DateTime', datetimeString);
													    		postEnc.append('SerialNumber', serialNumber);
													    		postEnc.append('xmlFile', blob);
										    				
													    		var xhrSign = new XMLHttpRequest();
													    		xhrSign.onreadystatechange = function(e) {
													    			if(4 == this.readyState) {
													    				if(this.status == 200){	
													    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
													    					blob = new Blob( [this.response], { type : "octet/stream" } );
													    					showLoading();
													    				
													    					formData = new FormData();
																			formData.append("XMLFileSigned", blob);
																			formData.append('certificate', base64Cert.replace(/\+/g, "@"));
																		
																			
																			xhrSign = new XMLHttpRequest();
																			xhrSign.upload.addEventListener('progress', function(e) {
																				
																			});
																			if(xhrSign.upload) {
																				
																			};
																			xhrSign.onreadystatechange = function(e) {
																				if(4 == this.readyState && this.status == 200) {
																					var res = xhrSign.response;
																					if(res){
																						if(res.errorCode == 0) { 
																							hideLoading();
																						     _gridMain.data("kendoGrid").dataSource.read();
																								  timeoutID = setTimeout(callsend_cqt, 1000);
											
																						}else{
																	            			alertDLSuccess(createObjectError(res).html(), function(){});
																	            			hideLoading();
																	            			$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
																	            		}
																					}else{
																						alertDLSuccess('unknown error!!!', function(){});
																						hideLoading();
																	            	}
																				}
																			}
																			xhrSign.onerror = function() {
																				
																			}
																			xhrSign.ontimeout = function() {
																				
																			}	
																	var urlPost = ROOT_PATH + '/main/export-sign/signFile';
																	xhrSign.open("POST", urlPost, true);
																	xhrSign.responseType = 'json';
																	xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																	xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																	
																	xhrSign.setRequestHeader("Cache-Control", "no-cache");
																	xhrSign.setRequestHeader("X-Requested-With", "XMLHttpRequest");
																	xhrSign.send(formData);
													    				}else{
																			hideLoading();
																			alertDLSuccess('<span class="text-danger">Lỗi trong quá trình ký tập tin.</span>', function(){});
																		}
													    			}
													    		}
													    		xhrSign.open('POST', urlPluginSign + signXML, true);
																xhrSign.timeout = 5 * 60 * 1000;
																xhrSign.responseType = 'blob';	//or arraybuffer
																xhrSign.send(postEnc);
													    	}else{
													    		hideLoading();
													    		alertDLSuccess("Lỗi: Không ký được dữ liệu hóa đơn.", function(){});
															}
													    
												        },
												        error:function(){
												            
												        }
													});
													}
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
											
										
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
											hideLoading();
											$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
											return;
								        }
									});										
        }else{
        	alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
										hideLoading();
										$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
										return;
        }
      },
      error:function (xhr, ajaxOptions, thrownError){
    	  alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
			hideLoading();
			$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
			return;
          }
    });
							
							
							
							
							}else{
								$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
								hideLoading();
								alertDLSuccess(createObjectError(res).html(), function(){});
							}
						}else{
							alertDLSuccess('unknown error!!!', function(){});
							hideLoading();
						}
						function callsend_cqt() {
							var objURL = {};
							  objURL['check'] = ROOT_PATH + '/main/export-send-cqt/check-data';
			                    objURL['exec'] = ROOT_PATH + '/main/export-send-cqt/exec-data';
			               
			                  $.ajax({
			                    type: "POST",
			                    datatype: "json",
			                    url: objURL['check'],
			                    data: objDataSend,
			                    beforeSend: function(req) {
			                      initAjaxJsonRequest(req);
			                          showLoading();
			                    },
			                    success:function(res) {
			                      hideLoading();
			                      if(res) {
			                        if(res.errorCode == 0) {
			                          var responseData = res.responseData;
			                          tokenTransaction = responseData['TOKEN'];
			                          objDataSend['tokenTransaction'] = tokenTransaction;         
			                              $.ajax({
			                                type: "POST",
			                                datatype: "json",
			                                url: objURL['exec'],
			                                data: objDataSend,
			                                beforeSend: function(req) {
			                                  initAjaxJsonRequest(req);
			                                      showLoading();
			                                },
			                                success:function(res) {
			                                  hideLoading();
			                                  if(res) {
			                                    if(res.errorCode == 0) {
			                                     _gridMain.data("kendoGrid").dataSource.read();
																							 	
											 timeoutID2 = setTimeout(callrefesh_cqt, 2000);
												
			                                    }else{
			                                      alertDLSuccess(createObjectError(res).html(), function(){});
			                                    }
			                                  }else{
			                                    alertDLSuccess('unknown error!!!', function(){});
			                                    hideLoading();
			                                  }
			                                },
			                                error:function (xhr, ajaxOptions, thrownError){
			                                  alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
			                                        hideLoading();
			                                    }
			                              });
			                          
			                        }else{
			                          alertDLSuccess(createObjectError(res).html(), function(){});
			                        }
			                      }else{
			                        alertDLSuccess('unknown error!!!', function(){});
			                        hideLoading();
			                      }
			                    },
			                    error:function (xhr, ajaxOptions, thrownError){
			                      alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
			                            hideLoading();
			                        }
			                  });		
							}

						
						
						function callrefesh_cqt() {
						
							$.ajax({
								type: "POST",
								datatype: "json",
								url: ROOT_PATH + '/main/export/refresh-status-cqt',
								data: objDataSend,
								beforeSend: function(req) {
									initAjaxJsonRequest(req);
						        	showLoading();
								},
								success:function(res) {
									hideLoading();
								/*	if(res) {
										if(res.errorCode == 0) {
											_gridMain.data("kendoGrid").dataSource.read();
											hideLoading();
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}*/
									if(res) {
										if(res.errorCode == 0) {
											var objURL1 = {};
											objURL1['check'] = ROOT_PATH + '/main/export-send-emailauto/check-data-send';
											objURL1['exec'] = ROOT_PATH + '/main/export-send-emailauto/send-mail';
										
											$.ajax({
												type: "POST",
												datatype: "json",
												url: objURL1['check'],
												data: objDataSend,
												beforeSend: function(req) {
													initAjaxJsonRequest(req);
										        	showLoading();
												},
												success:function(res) {
													hideLoading();
													if(res) {
														if(res.errorCode == 0) {
															var responseData = res.responseData;
															tokenTransaction = responseData['TOKEN'];
															
															objDataSend['tokenTransaction'] = tokenTransaction;

																	$.ajax({
																		type: "POST",
																		datatype: "json",
																		url: objURL1['exec'],
																		data: objDataSend,
																		beforeSend: function(req) {
																			initAjaxJsonRequest(req);
																        	showLoading();
																		},
																		success:function(res) {
																			hideLoading();
																			if(res) {
																				if(res.errorCode == 0) {
																					_gridMain.data("kendoGrid").dataSource.read();
																				}else{
																					alertDLSuccess(createObjectError(res).html(), function(){});
																				}
																			}else{
																				alertDLSuccess('unknown error!!!', function(){});
																				hideLoading();
																			}
																		},
																		error:function (xhr, ajaxOptions, thrownError){
																			alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
																            hideLoading();
																        }
																	});
															
																
														
														}else{
															alertDLSuccess(createObjectError(res).html(), function(){});
														}
													}else{
														alertDLSuccess('unknown error!!!', function(){});
														hideLoading();
													}
												},
												error:function (xhr, ajaxOptions, thrownError){
													alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
										            hideLoading();
										        }
											});
										}else{
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								},
								error:function (xhr, ajaxOptions, thrownError){
									alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
						            hideLoading();
						        }
							});		
							}	
						
							function clearAlert() {
							  clearTimeout(timeoutID);
							}
							function clearAlert() {
								  clearTimeout(timeoutID2);
								}
	
					},
					error:function (xhr, ajaxOptions, thrownError){
						alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
			            hideLoading();
			        }
					
				});
			
				break;
		case 'export-edit':
		case 'export-copy':
		case 'export-detail':
			objData = {};
			idx = $(checkRows[0].closest("tr")).index();
			rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			objData['_id'] = rowData['_id'];
			$('#divSubContent').show();$('#divMainContent').hide();
			submitFormRenderArea(ROOT_PATH + '/main/' + dataAction + '/init', objData, $('#divSubContent'));
			break;
		case 'export-cre-dc-tt':
			idx = $(checkRows[0].closest("tr")).index();
			rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			objData['_id'] = rowData['_id'];
			$('#divSubContent').show();$('#divMainContent').hide();
			submitFormRenderArea(ROOT_PATH + '/main/export-cre/init-dc-tt', objData, $('#divSubContent'));
			break;
		case 'export-cre':
			$('#divSubContent').show();$('#divMainContent').hide();
			submitFormRenderArea(ROOT_PATH + '/main/' + dataAction + '/init', objData, $('#divSubContent'));
			break;
		case 'search':
			_gridMain.data("kendoGrid").dataSource.page(1);
			break;
		case 'export-sign---':
			ids = [];
			checkRows.each(function(i, v) {
			    idx = $(checkRows[i].closest("tr")).index();
			    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			    ids.push(rowData['_id']);
			});
			
			/*CHECK THONG TIN HD*/
			objData = {_token: encodeObjJsonBase64UTF8(ids)};
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/main/export-sign/check-data-sign',
				data: objData,
				beforeSend: function(req) {
					initAjaxJsonRequest(req);
		        	showLoading();
				},
				success:function(res) {
					hideLoading();
					if(res) {
						if(res.errorCode == 0) {
							var responseData = res.responseData;
							
							var confirmText = responseData['CONFIRM'];
							tokenTransaction = responseData['TOKEN'];
							
							objData['tokenTransaction'] = tokenTransaction;
							
							//GET CERT
							getCert(function(e){
								if(null == e) {
									alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
									hideLoading();
									$("#f-export").find('#grid').find(".k-pager-refresh").trigger('click');
									return;
								}
								serialNumber = '';								
								//KIEM TRA THONG TIN CERT
								$.ajax({
									type: "POST",
									datatype: "json",
									url: ROOT_PATH + '/main/common/check-cert',
									data: {'cert': base64Cert.replace(/\+/g, "@")},
									beforeSend: function(req) {
										initAjaxJsonRequest(req);
							        	showLoading();
									},
									success:function(res) {
										hideLoading();
										if(res) {
											if(res.errorCode == 0) {
												serialNumber = res.responseData;
												//LAY NOI DUNG FILE XML
												jQuery.ajax({
													url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
											        cache:false,
											        xhr:function(){// Seems like the only way to get access to the xhr object
											            var xhr = new XMLHttpRequest();
											            xhr.responseType= 'blob'
											            return xhr;
											        },
											        success:function(data, textStatus, xhr) {
											        	hideLoading();
												    	if(xhr.status == 200){
//												    		var xmlText = null;
//												    		try{
//												    			xmlText = new XMLSerializer().serializeToString(data);
//											    			}catch(error){
//											    				console.log(error);
//											    				alertDLSuccess('Lỗi trong quá trình ký file.', function(){});
//											    				return;
//											    			}												    		
//															blob = new Blob([xmlText], { type: 'octet/stream' });
												    		
												    		var blob = new Blob([data], { type: 'octet/stream' });
												    		var postEnc = new FormData();
												    		postEnc.append('SerialNumber', serialNumber);
												    		postEnc.append('xmlFile', blob);
												    		var xhrSign = new XMLHttpRequest();
												    		xhrSign.onreadystatechange = function(e) {
												    			if(4 == this.readyState) {
												    				if(this.status == 200){	
												    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
												    					blob = new Blob( [this.response], { type : "octet/stream" } );
												    					
												    					formData = new FormData();
																		formData.append("XMLFileSigned", blob);
																		formData.append('certificate', base64Cert.replace(/\+/g, "@"));
												    					
																		xhrSign = new XMLHttpRequest();
																		xhrSign.upload.addEventListener('progress', function(e) {
																			
																		});
																		if(xhrSign.upload) {
																			
																		};
																		xhrSign.onreadystatechange = function(e) {
																			if(4 == this.readyState && this.status == 200) {
																				var res = xhrSign.response;
																				if(res){
																					if(res.errorCode == 0) { 
																						hideLoading();
																						
																						alert('ok')
																					}else{
																            			alertDLSuccess(createObjectError(res).html(), function(){});
																            			hideLoading();
																            		}
																				}else{
																					alertDLSuccess('unknown error!!!', function(){});
																					hideLoading();
																            	}
																			}
																		}
																		xhrSign.onerror = function() {
																			
																		}
																		xhrSign.ontimeout = function() {
																			
																		}
																		
																		var urlPost = ROOT_PATH + '/main/export-sign/signFile';
																		xhrSign.open("POST", urlPost, true);
																		xhrSign.responseType = 'json';
																		xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																		xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																		
																		xhrSign.setRequestHeader("Cache-Control", "no-cache");
																		xhrSign.setRequestHeader("X-Requested-With", "XMLHttpRequest");
																		xhrSign.send(formData);
												    				}else{
																		hideLoading();
																		alertDLSuccess('<span class="text-danger">Lỗi trong quá trình ký tập tin.</span>', function(){});
																	}
												    			}
												    		}
												    		
												    		xhrSign.open('POST', urlPluginSign + signXML, true);
															xhrSign.timeout = 5 * 60 * 1000;
															xhrSign.responseType = 'blob';	//or arraybuffer
															xhrSign.send(postEnc);
												    		
//												    		var formData = new FormData();
//															formData.append("SerialNumber", serialNumber);
//															formData.append("xmlFile", blob);
//															$.ajax({
//															 type: 'POST',
//															    url: urlPluginSign + signXML,
//															    contentType: "multipart/form-data",
//															    data: formData,
//															    processData: false,
//															    contentType: false,
//															    beforeSend: function(req) {
//															    	showLoading();
//															    },
//															    success:function(data, textStatus, xhr) {
//															    	hideLoading();
//															    	
//															    	alert('o');
//															    },
//																error:function (xhr, ajaxOptions, thrownError){
//																	alertDLSuccess("Lỗi: Không ký được dữ liệu hóa đơn.", function(){});
//														            hideLoading();
//														        }
//															});
												    		
												    		
												    	}else{
												    		alertDLSuccess("Lỗi: Không ký được dữ liệu hóa đơn.", function(){});
														}
											        },
											        error:function(){
											            
											        }
											    });
												
												//CALL SIGN XML
												
												
											}else{
												alertDLSuccess(createObjectError(res).html(), function(){});
											}
										}else{
											alertDLSuccess('unknown error!!!', function(){});
											hideLoading();
										}
									},
									error:function (xhr, ajaxOptions, thrownError){
										alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
							            hideLoading();
							        }
								});
								
							});
							
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
						}
					}else{
						alertDLSuccess('unknown error!!!', function(){});
						hideLoading();
					}
				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		            hideLoading();
		        }
			});
			
			break;
		case 'export-delete':
			ids = [];
			checkRows.each(function(i, v) {
			    idx = $(checkRows[i].closest("tr")).index();
			    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			    ids.push(rowData['_id']);
			});
			
			objData = {_token: encodeObjJsonBase64UTF8(ids)};
	
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/main/export-deleteAll/check-data-save',
				data: objData,
				beforeSend: function(req) {
					initAjaxJsonRequest(req);
		        	showLoading();
				},
				success:function(res) {
					hideLoading();
					if(res) {
						if(res.errorCode == 0) {
							objData = {};	
							var responseData = res.responseData;
							
							var confirmText = responseData['CONFIRM'];
							tokenTransaction = responseData['TOKEN'];
							objData = {_token: encodeObjJsonBase64UTF8(ids)};
							objData['tokenTransaction'] = tokenTransaction;
							
							alertConfirm(confirmText,
								function(e){
									$.ajax({
										type: "POST",
										datatype: "json",
										url: ROOT_PATH + '/main/export-deleteAll/save-data',
										data: objData,
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
											if(res) {
												if(res.errorCode == 0) {
													if($('#f-export').find('#grid').length > 0){
														_gridMain.data("kendoGrid").dataSource.read();
													}
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});
								},
								function(e){}
							);
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
						}
					}else{
						alertDLSuccess('unknown error!!!', function(){});
						hideLoading();
					}
				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		            hideLoading();
		        }
			});
			break;
			
		case 'export-pdfCD':
			var objData = null;
			var ids = null;
			ids = [];
			checkRows.each(function(i, v) {
			    idx = $(checkRows[i].closest("tr")).index();
			    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			    ids.push(rowData['_id']);
			});	
			
			
			objData = {'ArrayData' : encodeObjJsonBase64UTF8(ids)};
			
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/common/saveDataBas64',
				data: objData,
				beforeSend: function(req) {
					initAjaxJsonRequest(req);
		        	showLoading();
				},
				success:function(res) {
					hideLoading();
					if(res) {
						if(res.errorCode == 0) {
							  var responseData = res.responseData;
							  var idData = responseData['ID'];										
							  window.open(ROOT_PATH + '/common/print-exportCD/' + idData,'_blank');
							  
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
				            hideLoading();
						}
					}else{
						alertDLSuccess('unknown error!!!', function(){});
						hideLoading();
					}
					
				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess("Không tìm thấy thông tin", function(){});
		            hideLoading();
		        }
			});
			
/* 			objData =  encodeObjJsonBase64UTF8(ids);
			window.open(ROOT_PATH + '/common/print-exportCD/' + objData,'_blank'); */
			break;	
		case 'export-xml':
			var objData = null;
			var ids = null;
			ids = [];
			checkRows.each(function(i, v) {
			    idx = $(checkRows[i].closest("tr")).index();
			    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			    ids.push(rowData['_id']);
			});	
			
			
			objData = {'ArrayData' : encodeObjJsonBase64UTF8(ids)};
			
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/common/saveDataBas64',
				data: objData,
				beforeSend: function(req) {
					initAjaxJsonRequest(req);
		        	showLoading();
				},
				success:function(res) {
					hideLoading();
					if(res) {
						if(res.errorCode == 0) {
							  var responseData = res.responseData;
							  var idData = responseData['ID'];										
							  window.open(ROOT_PATH + '/common/exportXml/' + idData,'_blank');
							  
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
				            hideLoading();
						}
					}else{
						alertDLSuccess('unknown error!!!', function(){});
						hideLoading();
					}
					
				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess("Không tìm thấy thông tin", function(){});
		            hideLoading();
		        }
			});
			
	/* 		objData =  encodeObjJsonBase64UTF8(ids);
			window.open(ROOT_PATH + '/common/exportXml/' + objData,'_blank'); */
		break;
		case 'export-pdfAll':
			var objData = null;
			var ids = null;
			ids = [];
			checkRows.each(function(i, v) {
			    idx = $(checkRows[i].closest("tr")).index();
			    rowData = _gridMain.data("kendoGrid").dataItem(_gridMain.find(' tbody tr').eq(idx));
			    ids.push(rowData['_id']);
			});	
			
			
			objData = {'ArrayData' : encodeObjJsonBase64UTF8(ids)};
			
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/common/saveDataBas64',
				data: objData,
				beforeSend: function(req) {
					initAjaxJsonRequest(req);
		        	showLoading();
				},
				success:function(res) {
					hideLoading();
					if(res) {
						if(res.errorCode == 0) {
							  var responseData = res.responseData;
							  var idData = responseData['ID'];										
							  window.open(ROOT_PATH + '/common/print-exportAll/' + idData,'_blank');
							  
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
				            hideLoading();
						}
					}else{
						alertDLSuccess('unknown error!!!', function(){});
						hideLoading();
					}
					
				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess("Không tìm thấy thông tin", function(){});
		            hideLoading();
		        }
			});
			
/* 			objData =  encodeObjJsonBase64UTF8(ids);
			window.open(ROOT_PATH + '/common/print-exportAll/' + objData,'_blank'); */
			break;
		default:
			break;
		}
	});
	
});

function getDataSearch(){
	var dataPost = {};
	
	dataPost['mau-so-hdon'] = $('#f-export #mau-so-hdon').val() == null? '': $('#f-export #mau-so-hdon').val();
	dataPost['so-hoa-don'] = $('#f-export #so-hoa-don').val() == null? '': $('#f-export #so-hoa-don').val();
	dataPost['from-date'] = $('#f-export #from-date').val() == null? '': $('#f-export #from-date').val();
	dataPost['to-date'] = $('#f-export #to-date').val() == null? '': $('#f-export #to-date').val();
	dataPost['status'] = $('#f-export #status').val() == null? '': $('#f-export #status').val();
	dataPost['sign-status'] = $('#f-export #sign-status').val() == null? '': $('#f-export #sign-status').val();
	dataPost['nban-mst'] = $('#f-export #nban-mst').val() == null? '': $('#f-export #nban-mst').val();
	dataPost['nban-ten'] = $('#f-export #nban-ten').val() == null? '': $('#f-export #nban-ten').val();
	
	return dataPost;
}

function disableEnabledAllButton(){
	var checkRows = _gridMain.find(' tbody tr input[type="checkbox"]:checked');
	$("#f-export").find('button[data-action="export-sign"]').prop('disabled', checkRows.length == 0);
//	$("#f-export").find('button[data-action="delete"]').prop('disabled', checkRows.length == 0);
}

function setTemplateForGridMAIN(key, data){
	var signStatusCode = data['SignStatusCode'];
	var eInvoiceStatus = data['EInvoiceStatus'];
	var MCCQT = data['MCCQT'] == null? '': data['MCCQT'];
	var text = '';
	
	switch (key) {
	case 'func':
		if('CREATED' == eInvoiceStatus || 'NOSIGN' == signStatusCode){
			text += '<i title="Xem hóa đơn pdf" class="mdi mdi-file-pdf fs-25 text-red c-pointer" data-sub-action="print" ></i>';
			text += '<i title="Xóa" class="mdi mdi-close-box fs-25 text-danger c-pointer" data-sub-action="delete" ></i>';
		}else if('PENDING' == eInvoiceStatus && 'SIGNED' == signStatusCode){
			text += '<i title="Xem hóa đơn pdf" class="mdi mdi-file-pdf fs-25 text-red c-pointer" data-sub-action="print" ></i>';
			text += '<i title="Gửi CQT" class="mdi mdi-telegram fs-25 text-info c-pointer" data-sub-action="send-cqt" ></i>';
		}else if('PROCESSING' == eInvoiceStatus && 'SIGNED' == signStatusCode || 'ERROR_CQT' == eInvoiceStatus && 'SIGNED' == signStatusCode){
			text += '<i title="Xem hóa đơn pdf" class="mdi mdi-file-pdf fs-25 text-red c-pointer" data-sub-action="print" ></i>';
			text = '<i title="Lấy kết quả từ CQT" class="mdi mdi-refresh-circle fs-25 text-info c-pointer" data-sub-action="refresh" ></i>';
		text += '<i title="Lịch sử lấy mã CQT" class="mdi mdi-eye fs-25 text-info c-pointer" data-sub-action="history" ></i>';
		//text += '<i title="Đổi mã thông điệp" class="mdi mdi-swap-horizontal-circle fs-25 text-red c-pointer" data-sub-action="change" ></i>';
		
		}
	
		if('' != MCCQT){
			text += '<i title="Xem hóa đơn pdf" class="mdi mdi-file-pdf fs-25 text-red c-pointer" data-sub-action="print" ></i>';
			text += '<i title="In hóa đơn chuyển đổi" class="mdi mdi-file-pdf fs-25 text-info c-pointer" data-sub-action="print-convert" ></i>';
			//text += '<i  title="Tự động gửi email" class="mdi mdi-email-send-outline fs-25 text-info c-pointer" id="send-emailauto" name="send-emailauto" data-sub-action="send-emailauto" ></i>';	
			text += '<i title="Gửi email hóa đơn" class="mdi mdi-email fs-25 text-warning c-pointer" id="send-email" name="send-email" data-sub-action="send-email" ></i>';	
			text += '<i title="Lịch sử lấy mã CQT" class="mdi mdi-eye fs-25 text-info c-pointer" data-sub-action="history" ></i>';
		}		
		break;
	case 'StatusDesc':
		if('DELETED' == data['EInvoiceStatus']){
			text = '<div style="background: red;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		
		else if('XOABO' == data['EInvoiceStatus']){
			text = '<div style="background: red;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('REPLACED' == data['EInvoiceStatus']){
			text = '<div style="background: #FFFF66;border-radius: 10px;color: black;">' + data['StatusDesc'] + '</div>';
		}
		else if('ADJUSTED' == data['EInvoiceStatus']){
			text = '<div style="background: #CC99CC;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('COMPLETE' == data['EInvoiceStatus']){
			text = '<div style="background: #85DE77;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('CREATED' == data['EInvoiceStatus']){
			text = '<div style="background: #669966;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('PROCESSING' == data['EInvoiceStatus']){
			text = '<div style="background: #6666CC;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('PENDING' == data['EInvoiceStatus']){
			text = '<div style="background: #99CCFF;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
		}
		else if('ERROR_CQT' == data['EInvoiceStatus']){
			text += '<div style="background: #DD0000;border-radius: 10px;color: white;">' + data['StatusDesc'] + '</div>';
			text += '<i title="Chi tiết lỗi" class="text-info c-pointer fs-15 font-weight-bold text-decoration-underline" data-sub-action="history" >Chi tiết lỗi</i>';
		}
		
		else{
			text = data['StatusDesc'];
		}
		break;

	default:
		break;
	}
	
	
	return text;
}

	
	
	
		
</script>
		
		
		
			</div>
		</div>
		
	</th:block>
</body>
</html>