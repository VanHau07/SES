<!DOCTYPE html>
<html 
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" >
	
<div class="row page-titles">
	<div class="col-12 align-self-center p-l-0 centerX">
		<h3 class="text-themecolor m-b-0 m-t-0 text-uppercase" th:text="${_header_}" ></h3>
	</div>
</div>
<div class="row">
	<div class="col-12">
		<form id="f-tkhai-crud" name="f-tkhai-crud" method="post" enctype="multipart/form-data">
			<div class="card">
				<div class="card-body" th:if="${messageError != null}">
					<div class="row text-danger m-b-10 fw-500 col-12">
						<div class="col-12 text-danger m-b-10 fw-800 fs-15 text-uppercase text-center" th:utext="${messageError}"></div>
						<div class="col-12 p-0"><hr class="m-t-5 m-b-5"></div>
					</div>
					<div class="form-group row m-b-6">
						<div class="col-6">
							<button type="button" data-action="back" title="Quay lại" 
								class="btn btn-sm btn-outline-secondary"><i class="mdi mdi-chevron-left"></i> <span class="d-none d-md-inline">Quay lại</span></button>
						</div>
						<div class="col-6 text-right">
							
						</div>
					</div>
				</div>
				
				<div class="card-body" th:if="${messageError == null}">
					<div class="form-group row m-b-6">
						<div class="col-12 col-sm-6 col-md-3">
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="ten-nnt" name="ten-nnt" th:value="${tenNnt}" readonly type="text" autocomplete="off"  />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Tên người nộp thuế</label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
									<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" th:value="${MSo}" th:readonly="true" th:if="${!_isedit_}" type="text" autocomplete="off"  />
									<select class="form-control form-control-sm c-f__textbox" id="mau-so" name="mau-so" th:if="${_isedit_}" >
										<option value=""></option>
										<th:block th:if="${map_mstkhai != null}" >
											<option th:each="entry : ${map_mstkhai.entrySet()}"
												th:value="${entry.key}" th:utext="${entry.value}" th:selected="${MSCode == entry.key}" > </option>
										</th:block>
									</select>
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Mẫu số</label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="ten" name="ten" type="text" autocomplete="off" th:value="${ten}"readonly />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Tên tờ khai</label></legend>
									</fieldset>
								</div>
							</div>							
						</div>
						<div class="col-12 col-sm-6 col-md-3">
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="mst" name="mst" type="text" autocomplete="off" th:value="${mst}" readonly />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Mã số thuế</label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" th:value="${TThanhName}" th:readonly="true" th:if="${!_isedit_}" type="text" autocomplete="off"  />
									<select class="form-control form-control-sm c-f__textbox" id="tinh-thanh" name="tinh-thanh" th:if="${_isedit_}" >
										<option value=""></option>
										<th:block th:if="${map_dmtinhthanh != null}" >
											<option th:each="entry : ${map_dmtinhthanh.entrySet()}"
												th:value="${entry.key}" th:utext="${entry.value}" th:selected="${TThanhCode == entry.key}" > </option>
										</th:block>
									</select>
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Tỉnh/Thành phố<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" th:value="${CQThueName}" th:readonly="true" th:if="${!_isedit_}" type="text" autocomplete="off"  />
									<select class="form-control form-control-sm c-f__textbox" id="CQTQLy" name="CQTQLy" th:if="${_isedit_}" >
										<option value=""></option>
										<th:block th:if="${map_cucthue != null}">
											<option th:each="entry : ${map_cucthue.entrySet()}"
												th:value="${entry.key}" th:utext="${entry.value}" th:selected="${CQThueCode == entry.key}" > </option>
										</th:block>
									</select>
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Cơ quan thuế<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
							
						</div>
						<div class="col-12 col-sm-6 col-md-3">
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="NLHe" name="NLHe" th:value="${NLHe}" type="text" autocomplete="off" th:readonly="${!_isedit_}" />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Người liên hệ<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="DCLHe" name="DCLHe" th:value="${DCLHe}" type="text" autocomplete="off" th:readonly="${!_isedit_}" />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Địa chỉ liên hệ<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" id="DCTDTu" name="DCTDTu" th:value="${DCTDTu}" type="text" autocomplete="off" th:readonly="${!_isedit_}" />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Email liên hệ<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
						</div>
						<div class="col-12 col-sm-6 col-md-3">
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" type="text" id="DTLHe" name="DTLHe" th:value="${DTLHe}" autocomplete="off" th:readonly="${!_isedit_}" />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Điện thoại liên hệ<span class="text-danger" style="font-size:15px">(*)</span></label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" type="text" autocomplete="off" id="NLap" name="NLap" th:value="${nLap}" th:readonly="${!_isedit_}" />
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Ngày lập </label></legend>
									</fieldset>
								</div>
							</div>
							<div class="custom-field m-b-16">
								<div class="c-f__wrapper">
									<input class="form-control form-control-sm c-f__textbox" th:value="${HThuc}" th:readonly="true" th:if="${!_isedit_}" type="text" autocomplete="off"  />
									<select class="form-control form-control-sm c-f__textbox" id="HThuc" name="HThuc" th:if="${_isedit_}" >
										<option value=""></option>
										<th:block th:if="${map_httkhai != null}" >
											<option th:each="entry : ${map_httkhai.entrySet()}"
												th:value="${entry.key}" th:utext="${entry.value}" th:selected="${HTCode == entry.key}" > </option>
										</th:block>
									</select>
									<fieldset aria-hidden="true" class="c-f__set">
										<legend class="c-f__legend"><label>Hình thức đăng ký</label></legend>
									</fieldset>
								</div>
                        	</div>
						</div>
						
					</div>
					<div class="row"><div class="col-12"><hr style="margin: 0 0 16px 0" /></div></div>
					<div class="row">
						<div class="col-12 col-sm-6">
							<div class="m-b-10">
								<div class="text__primary--c">1. Hình thức hóa đơn</div>
								<div class="row">
									<div class="col-12 col-sm-6 col-md-6 custom-field m-b-8">
										<label class="custom-control custom-radio d-inline-block m-r-10 m-b-0 ">
											<input name="optHTHDon" type="radio" class="custom-control-input" value="CMa" th:checked="${'CMa' == optHTHDon}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Có mã của cơ quan thuế</span>
										</label>
									</div>
									<div class=" col-12 col-sm-6 col-md-6 custom-field m-b-8 ">
										<label class=" custom-control custom-radio d-inline-block m-r-10 m-b-0 ">
											<input name="optHTHDon" type="radio" class="custom-control-input" value="KCMa" th:checked="${'CMa' != optHTHDon}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Không có mã của cơ quan thuế</span>
										</label>
									</div>
								</div>
								<div class="row">
								
									<div class="col-12 col-sm-6 col-md-5 custom-field m-b-8">
		                            	<label class="custom-control custom-checkbox d-inline-block m-r-10 m-b-0 ">
		                            		<input name="CMMTT" type="checkbox" class="custom-control-input" th:checked="${null != CMMTT && CMMTT}" th:disabled="${!_isedit_}" />
		                            		<span class="custom-control-label p-t-5">Có mã từ máy tính tiền</span>
		                            	</label>
		                            </div>
		                            
		                            
								
								</div>
							</div>
							<div class="m-b-10">
								<div class="text__primary--c">2. Phương thức chuyển dữ liệu hóa đơn điện tử</div>
								<div class="row">
									<div class="col-12 custom-field m-b-8">
										<label class="custom-control custom-radio d-inline-block m-r-10 m-b-0 ">
											<input name="optPThuc" type="radio" class="custom-control-input" value="CDDu" th:checked="${'CDDu' == optPThuc}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Chuyển đầy đủ nội dung từng hóa đơn.</span>
										</label>
									</div>
									<div class="col-12 custom-field m-b-8">
										<label class=" custom-control custom-radio d-inline-block m-r-10 m-b-0 ">
											<input name="optPThuc" type="radio" class="custom-control-input" value="CBTHop" th:checked="${'CDDu' != optPThuc}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Chuyển theo bảng tổng hợp dữ liệu hóa đơn điện tử (điểm a1, khoản 3, Điều 22 của Nghị định).</span>
										</label>
									</div>
								</div>
							</div>
                        
						</div>
						<div class="col-12 col-sm-6">
							<div class="m-b-16">
								<div class="text__primary--c">3. Loại hóa đơn sử dụng</div>
								<div class="row">
									<div class="col-12 col-sm-6 col-md-5 custom-field m-b-8">
		                            	<label class="custom-control custom-checkbox d-inline-block m-r-10 m-b-0 ">
		                            		<input name="LHDSDung_HDGTGT" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_HDGTGT && LHDSDung_HDGTGT}" th:disabled="${!_isedit_}" />
		                            		<span class="custom-control-label p-t-5">Hóa đơn GTGT </span>
		                            	</label>
		                            </div>
		                            <div class="col-12 col-sm-6 col-md-7 custom-field m-b-8 ">
		                            	<label class="custom-control custom-checkbox d-inline-block m-r-10 m-b-0 ">
		                            		<input name="LHDSDung_HDBHang" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_HDBHang && LHDSDung_HDBHang}" th:disabled="${!_isedit_}" />
		                            		<span class="custom-control-label p-t-5">Hóa đơn bán hàng</span>
		                            	</label>
									</div>
								</div>
								<div class="row">
									<div class="col-12 col-sm-6 col-md-5 custom-field m-b-8 ">
										<label class=" custom-control custom-checkbox d-inline-block m-r-10 m-b-0 " >
											<input name="LHDSDung_HDBTSCong" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_HDBTSCong && LHDSDung_HDBTSCong}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Hóa đơn bán tài sản công</span>
										</label>
									</div>
									<div class=" col-12 col-sm-6 col-md-7 custom-field m-b-8 ">
										<label class="custom-control custom-checkbox d-inline-block m-r-10 m-b-0 ">
											<input name="LHDSDung_HDBHDTQGia" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_HDBHDTQGia && LHDSDung_HDBHDTQGia}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Hóa đơn bán hàng dự trữ quốc gia</span>
										</label>
									</div>
								</div>
								<div class="row">
									<div class="col-12 custom-field m-b-8">
										<label class="custom-control custom-checkbox d-inline-block m-r-10 m-b-0">
											<input name="LHDSDung_HDKhac" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_HDKhac && LHDSDung_HDKhac}" th:disabled="${!_isedit_}" />
											<span class="custom-control-label p-t-5">Các loại hóa đơn khác</span>
										</label>
									</div>
									<div class="col-12 custom-field m-b-8">
										<label class=" custom-control custom-checkbox d-inline-block m-r-10 m-b-0 ">
											<input name="LHDSDung_CTu" type="checkbox" class="custom-control-input" th:checked="${null != LHDSDung_CTu && LHDSDung_CTu}" th:disabled="${!_isedit_}" >
											<span class="custom-control-label p-t-5">Các chứng từ được in, phát hành, sử dụng và quản lý như hóa đơn.</span>
										</label>
									</div>
								</div>
							</div>
						</div>
					</div>
					
					<div class="row mT-0 mB-5">
						<div class="col-9 col-sm-6 p-t-8">
							<span class="text-warning text-middle fw-800 text-uppercase text-decoration-underline ">Danh sách chứng thư số sử dụng</span>
						</div>
						<div class="col-3 col-sm-6 text-right">
							<button type="button" data-action="add-certtc" class="btn-sm btn-primary btn-ses" title="Thêm chứng thư số thủ công" th:if="${_isedit_}" ><i class="mdi mdi-pen fs-15"></i></button>
							<button type="button" data-action="add-cert" class="btn-sm btn-primary btn-ses" title="Thêm chứng thư số" th:if="${_isedit_}" ><i class="mdi mdi-plus fs-15"></i></button>
						</div>
					</div>
					<div class="col-12 p-0 has-min-height-grid-prd">
						<div id="grid_cert"></div>
					</div>
					
				<th:block th:if="false">
					<div class="row"><div class="col-12"><hr style="margin: 0 0 5px 0" /></div></div>
					<div class="row mT-0 mB-5">
						<div class="col-9 col-sm-6 p-t-8">
							<span class="text-warning text-middle fw-800 text-uppercase text-decoration-underline ">Đăng ký ủy nhiệm lập hóa đơn</span>
						</div>
						<div class="col-3 col-sm-6 text-right">
							<button type="button" data-action="add-dsdkunhiem" class="btn-sm btn-primary btn-ses" title="Đăng ký ủy nhiệm" ><i class="mdi mdi-plus fs-15"></i></button>
						</div>
					</div>
                    <div class="col-12 p-0 has-min-height-grid-prd">
                    	<div id="grid_cert"></div>
                    </div>
				</th:block>
                    
					<div class="row"><div class="col-12"><hr style="margin: 0 0 10px 0" /></div></div>
					<div class="form-group row m-b-6">
						<div class="col-6">
							<button type="button" data-action="back" title="Quay lại" 
								class="btn btn-sm btn-outline-secondary"><i class="mdi mdi-chevron-left"></i> <span class="d-none d-md-inline">Quay lại</span></button>
						</div>
						<div class="col-6 text-right">
							<button type="button" data-action="accept" class="btnadd btns btns-blue__ses" title="Chấp nhận" th:if="${null == messageError && ('CREATE' == _action_) ||  ('EDIT' == _action_)}" >
								<i class="mdi mdi-check-all"></i> <span class="d-none d-md-inline">Chấp nhận</span>
							</button>
							<button type="button" data-action="sign" class="btnadd btns btns-blue__ses" title="Ký tờ khai" th:if="${null == messageError && 'SIGN' == _action_}" >
								<i class="mdi mdi-check-all"></i>
								<span class="d-none d-md-inline">Ký tờ khai</span>
							</button>
						</div>
					</div>
				</div>
			</div>
			<input type="hidden" name="_id" th:value="${_id}" >
		</form>
		<script type="text/javascript">
		
		var vIsEdit = [[${_isedit_}]];
		transactionMain = '[[${transaction}]]';
		var rowsCert = [];
		_gridSub01 = $('#f-tkhai-crud').find('#grid_cert');
		</script>
		<script type="text/javascript" th:if="${_action_ == 'DETAIL' || _action_ == 'EDIT' || _action_ =='SIGN'}">
		var strJson = '[[${DSCTSSDung}]]';
		rowsTMP = [];
		try{
			var parser = new DOMParser;
			var dom = parser.parseFromString('<!doctype html><body>' + strJson, 'text/html');
			var decodedString = dom.body.textContent;
			
			rowsCert = JSON.parse(decodedString);
		}catch(err){}
		</script>
<!-- 		<script th:src="@{/static/function/dm/tkhai-crud.js(v=1.13) }"></script> -->
	<script type="text/javascript">
	$(function(){
	if(vIsEdit){
			
		dateInputFormat($('#f-tkhai-crud').find('#NLap'));
		
			if($('#f-tkhai-crud').find('#tinh-thanh').length > 0)
				initComboSearchLocal('#f-tkhai-crud', '#tinh-thanh');
			if($('#f-tkhai-crud').find('#CQTQLy').length > 0)
				initComboSearchLocal('#f-tkhai-crud', '#CQTQLy');
		}

		_gridSub01.kendoGrid({
			dataSource: {
				data: rowsCert,
				pageSize: 999999,
				serverPaging: false,
				serverSorting: false,
	           	serverFiltering: false
			},
			selectable: true, scrollable: true, 
			sortable: false,
			filterable: false, resizable: true,
			serverSorting: false,
			pageable: {
				refresh: false,
				pageSizes: false,
				numeric: false,
				previousNext: false
			},
			dataBinding: function () {
	            record = (this.dataSource.page() - 1) * this.dataSource.pageSize();
	        },
			columns: [
				{field: 'STT', title: 'STT', width: '50px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">STT</a>',
	  				attributes: {'class': 'table-cell', style: 'text-align: right;'}, sortable: false, 
	  				headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
	  				, template: '#: ++record #',
	  			},
	  			{field: 'func', title: '', width: '60px', encoded: false, hidden: !vIsEdit
	  				, headerTemplate: '&nbsp;'
					, attributes: {'class': 'table-cell', style: 'text-align: center;'}, sortable: false
					, headerAttributes: {'class': 'table-header-cell', style: 'text-align: center;',}
					, template: '<i class="mdi mdi-close-box fs-25 text-danger c-pointer" data-sub-action="remove" ></i>'
				},
	  			{field: 'TTChuc', title: '', width: '200px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Nhà cung cấp</a>',
					attributes: {'class': 'table-cell text-left text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
					template: '#= window.setTemplateForGrid("TTChuc", data) #'
				},
				{field: 'Seri', title: '', width: '200px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Seri</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
					template: '#= window.setTemplateForGrid("Seri", data) #'
				},
				{field: 'TNgay', title: '', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Từ ngày</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
					template: '#= window.setTemplateForGrid("TNgay", data) #'
				},
				{field: 'DNgay', title: '', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Đến ngày</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
					template: '#= window.setTemplateForGrid("DNgay", data) #'
				},
				{field: 'HThuc', title: '', width: '120px', encoded: false, headerTemplate: '<a class="k-link" href="javascript:void(0);">Hình thức</a>',
					attributes: {'class': 'table-cell text-center text-nowrap'}, headerAttributes: {'class': 'table-header-cell text-center'},
					template: '#= window.setTemplateForGrid("HThuc", data) #'
				},
			],
			dataBound: function(e) {
				_gridSub01.find('tbody[role="rowgroup"]').find('tr').undelegate('i[data-sub-action]', 'click');
				_gridSub01.find('tbody[role="rowgroup"]').find('tr').delegate('i[data-sub-action]', 'click', function(e){
					e.preventDefault();/*e.stopPropagation();*/
					var $obj = $(this);
					var $tr = $obj.closest('tr');
					var subAction = $obj.attr('data-sub-action');
					
					var indexRow = $tr.index();
					
					switch (subAction) {
					case 'remove':
						alertConfirm('Bạn có chắc chắn muốn xóa không?',
							function(e){
								var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
								if(indexRow < objDataJson.length && indexRow > -1){
									objDataJson.splice(indexRow, 1);
									_gridSub01.data("kendoGrid").dataSource.data(objDataJson);	
								}
									
							},
							function(e){}
						)
						break;

					default:
						break;
					}
					
				});
				_gridSub01.find('tbody[role="rowgroup"]').undelegate('input[name="TTChuc"], input[name="Seri"], input[name="TNgay"], input[name="DNgay"]', 'change');
				_gridSub01.find('tbody[role="rowgroup"]').delegate('input[name="TTChuc"], input[name="Seri"], input[name="TNgay"],input[name="DNgay"]', 'change', function(e){
					calcAmountInGrid($(this));
				});	
				
			}
		});
		
		/*LAY THONG TIN CKS*/
		$("#f-tkhai-crud").find('button[data-action]').click(function (event) {
			event.preventDefault();/*event.stopPropagation();*/
			var dataAction = $(this).data('action');

			var $obj = $(this);
			var objDataSend = null;
			
			switch (dataAction) {
			case 'add-certtc':
				var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();	
				objDataJson.push({});
				_gridSub01.data("kendoGrid").dataSource.data(objDataJson);
				break;
			case 'add-cert':
				
				   $.ajax({

url: "http://localhost:11284/getCert",
type: 'POST',
cors: true ,
secure: true,
headers: {
'Access-Control-Allow-Origin': '*',
'Access-Control-Allow-Headers': '*',
'Access-Control-Allow-Private-Network': true
},
beforeSend: function(req) {
initAjaxJsonRequest(req);
showLoading();
},
success:function(res) {
hideLoading();
if(res != null) {
var cert = res;           	
$.ajax({
type: "POST",
datatype: "json",
url: ROOT_PATH + '/main/common/check-cert-full',
data: {'cert':cert},
beforeSend: function(req) {
	initAjaxJsonRequest(req);
	showLoading();
},
success:function(res) {
	hideLoading();
	if(res) {
		if(res.errorCode == 0) {
			var res = res.responseData;
			var seri = res['Seri'];
			var check = false;
			var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
			for(var i = 0; i < objDataJson.length; i++){
				if(seri == objDataJson[i]['Seri']){
					check = true;
					break;
				}
			}
			
			if(!check){
				objDataJson.push(res);
				_gridSub01.data("kendoGrid").dataSource.data(objDataJson);	
			}
			
		}else{
			alertDLSuccess(createObjectError(res).html(), function(){});
		}
	}else{
		alertDLSuccess('unknown error!!!', function(){});
		hideLoading();
	}
},
error:function (xhr, ajaxOptions, thrownError){
	alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
 hideLoading();
}
});


}else{
alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
							hideLoading();
							$("#f-einvoices").find('#grid').find(".k-pager-refresh").trigger('click');
							return;
}
},
error:function (xhr, ajaxOptions, thrownError){
alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
hideLoading();
}
});
				
				
				
				
				break;
			case 'back':
				$('#divMainContent').show();
				$('#divSubContent').hide(function(){$(this).empty();});
				try{
					if($('#f-tkhai').find('#grid').length > 0)
						$('#f-tkhai').find('#grid').data("kendoGrid").dataSource.read();
				}catch(err){}
				break;
			case 'sign':
				objDataSend = {};
				objDataSend['_id'] = $('#f-tkhai-crud').find('input[name="_id"]').val();				
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/tkhai-sign/check-data-sign',
					data: objDataSend,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						if(res) {
							if(res.errorCode == 0) {
								var responseData = res.responseData;
								
								tokenTransaction = responseData['TOKEN'];
								objDataSend['tokenTransaction'] = tokenTransaction;
								
										   $.ajax({
		        
		          url: "http://localhost:11284/getCert",
		          type: 'POST',
		          cors: true ,
			          secure: true,
		          headers: {
		            'Access-Control-Allow-Origin': '*',
		            'Access-Control-Allow-Headers': '*',
		            'Access-Control-Allow-Private-Network': true
		          },
		          beforeSend: function(req) {
		            initAjaxJsonRequest(req);
		                showLoading();
		          },
		          success:function(res) {
		            hideLoading();
		            if(res != null) {
		            	var cert = res;           	
		            			$.ajax({
										type: "POST",
										datatype: "json",
										url: ROOT_PATH + '/main/common/check-cert',
										data: {'cert': cert},
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											if(res) {
												if(res.errorCode == 0) {
													var responseData = res.responseData;											
									
												serialNumber = responseData['Seri'];
											
													//LAY NOI DUNG FILE XML
													jQuery.ajax({
														url: ROOT_PATH + '/main/common/get-file-to-sign/' + tokenTransaction,
												        cache:false,
												        xhr:function(){// Seems like the only way to get access to the xhr object
												            var xhr = new XMLHttpRequest();
												            xhr.responseType= 'blob'
												            return xhr;
												        },
												        success:function(data, textStatus, xhr) {
												        	if(xhr.status == 200){
												        		var blob = new Blob([data], { type: 'octet/stream' });
													    		var postEnc = new FormData();
													    		postEnc.append('SerialNumber', serialNumber);
													    		postEnc.append('xmlFile', blob);
													    		
													    		var xhrSign = new XMLHttpRequest();
													    		xhrSign.onreadystatechange = function(e) {
													    			if(4 == this.readyState) {
													    				if(this.status == 200){
													    					/*NOI DUNG XML DA KY - SEND TO SERVER*/
													    					blob = new Blob( [this.response], { type : "octet/stream" } );
													    					showLoading();
													    					
													    					formData = new FormData();
																			formData.append("XMLFileSigned", blob);
																			formData.append('certificate', base64Cert.replace(/\+/g, "@"));
																			formData.append('_id', $('#f-tkhai-crud').find('input[name="_id"]').val())
													    					
																			xhrSign = new XMLHttpRequest();
																			xhrSign.upload.addEventListener('progress', function(e) {
																				
																			});
																			if(xhrSign.upload) {
																				
																			};
																			xhrSign.onreadystatechange = function(e) {
																				if(4 == this.readyState && this.status == 200) {
																					var res = xhrSign.response;
																					if(res){
																						if(res.errorCode == 0) { 
																							hideLoading();
																							
																							$("#f-tkhai-crud").find('button[data-action="back"]').trigger('click');
																						}else{
																	            			alertDLSuccess(createObjectError(res).html(), function(){});
																	            			hideLoading();
																	            		}
																					}else{
																						alertDLSuccess('unknown error!!!', function(){});
																						hideLoading();
																	            	}
																				}
																			}
																			xhrSign.onerror = function() {
																				
																			}
																			xhrSign.ontimeout = function() {
																				
																			}
																			
																			var urlPost = ROOT_PATH + '/main/tkhai-sign/signFile';
																			xhrSign.open("POST", urlPost, true);
																			xhrSign.responseType = 'json';
																			xhrSign.setRequestHeader('X-CSRF-TOKEN', _csrf_value)
																			xhrSign.setRequestHeader(HEADER_RESULT_TYPE_NAME, HEADER_RESULT_TYPE_JSON);
																			
																			xhrSign.setRequestHeader("Cache-Control", "no-cache");
																			xhrSign.setRequestHeader("X-Requested-With", "XMLHttpRequest");
																			xhrSign.send(formData);
													    				}else{
																			hideLoading();
																			alertDLSuccess('<span class="text-danger">Lỗi trong quá trình ký tập tin.</span>', function(){});
																		}
													    			}
													    		}
													    		xhrSign.open('POST', urlPluginSign + signDLTK, true);
																xhrSign.timeout = 5 * 60 * 1000;
																xhrSign.responseType = 'blob';	//or arraybuffer
																xhrSign.send(postEnc);
												        	}else{
													    		hideLoading();
													    		alertDLSuccess("Lỗi: Lấy dữ liệu tờ khai không thành công.", function(){});
															}
												        },
												        error:function(){
												            
												        }
													});
													
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
													hideLoading();
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});
						
				   }else{
		            	alertDLSuccess('Lấy chữ ký số không thành công.', function(){});
													hideLoading();
													$("#f-einvoices").find('#grid').find(".k-pager-refresh").trigger('click');
													return;
		            }
		          },
		          error:function (xhr, ajaxOptions, thrownError){
		            alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		                  hideLoading();
		              }
		        });
										
										
										
										
										}else{
											hideLoading();
											alertDLSuccess(createObjectError(res).html(), function(){});
										}
									}else{
										alertDLSuccess('unknown error!!!', function(){});
										hideLoading();
									}
								function callsend_cqt() {
						var objURL = {};
						objURL['check'] = ROOT_PATH + '/main/tbhdssot-send-cqt/check-data';
						objURL['exec'] = ROOT_PATH + '/main/tbhdssot-send-cqt/exec-data';
		                  $.ajax({
		                    type: "POST",
		                    datatype: "json",
		                    url: objURL['check'],
		                    data: objDataSend,
		                    beforeSend: function(req) {
		                      initAjaxJsonRequest(req);
		                          showLoading();
		                    },
		                    success:function(res) {
		                      hideLoading();
		                      if(res) {
		                        if(res.errorCode == 0) {
		                          var responseData = res.responseData;
		                          tokenTransaction = responseData['TOKEN'];
		                          objDataSend['tokenTransaction'] = tokenTransaction;         
		                              $.ajax({
		                                type: "POST",
		                                datatype: "json",
		                                url: objURL['exec'],
		                                data: objDataSend,
		                                beforeSend: function(req) {
		                                  initAjaxJsonRequest(req);
		                                      showLoading();
		                                },
		                                success:function(res) {
		                                  hideLoading();
		                                  if(res) {
		                                    if(res.errorCode == 0) {
		                                     _gridMain.data("kendoGrid").dataSource.read();
																						 	
										 timeoutID2 = setTimeout(callrefesh_cqt, 1000);
											
		                                    }else{
		                                      alertDLSuccess(createObjectError(res).html(), function(){});
		                                    }
		                                  }else{
		                                    alertDLSuccess('unknown error!!!', function(){});
		                                    hideLoading();
		                                  }
		                                },
		                                error:function (xhr, ajaxOptions, thrownError){
		                                  alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		                                        hideLoading();
		                                    }
		                              });
		                          
		                        }else{
		                          alertDLSuccess(createObjectError(res).html(), function(){});
		                        }
		                      }else{
		                        alertDLSuccess('unknown error!!!', function(){});
		                        hideLoading();
		                      }
		                    },
		                    error:function (xhr, ajaxOptions, thrownError){
		                      alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		                            hideLoading();
		                        }
		                  });		
						}

					
					
					function callrefesh_cqt() {
					
						$.ajax({
							type: "POST",
							datatype: "json",
							url: ROOT_PATH + '/main/tbhdssot/refresh-status-cqt',
							data: objDataSend,
							beforeSend: function(req) {
								initAjaxJsonRequest(req);
					        	showLoading();
							},
							success:function(res) {
								hideLoading();
								if(res) {
									if(res.errorCode == 0) {
										_gridMain.data("kendoGrid").dataSource.read();
										hideLoading();
									}else{
										alertDLSuccess(createObjectError(res).html(), function(){});
									}
								}else{
									alertDLSuccess('unknown error!!!', function(){});
									hideLoading();
								}
							},
							error:function (xhr, ajaxOptions, thrownError){
								alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
					            hideLoading();
					        }
						});		
						}	
					
						function clearAlert() {
						  clearTimeout(timeoutID);
						}
						function clearAlert() {
							  clearTimeout(timeoutID2);
							}

				},
				error:function (xhr, ajaxOptions, thrownError){
					alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
		            hideLoading();
		        }
				
			});
		
			break;
			case 'accept':
				objDataSend = getDataToSave();
				$.ajax({
					type: "POST",
					datatype: "json",
					url: ROOT_PATH + '/main/' + transactionMain + '/check-data-save',
					data: objDataSend,
					beforeSend: function(req) {
						initAjaxJsonRequest(req);
			        	showLoading();
					},
					success:function(res) {
						hideLoading();
						if(res.errorCode == 0) {
							var responseData = res.responseData;
							
							var confirmText = responseData['CONFIRM'];
							tokenTransaction = responseData['TOKEN'];
							
							objDataSend['tokenTransaction'] = tokenTransaction;
							
							alertConfirm(confirmText,
								function(e){
									$.ajax({
										type: "POST",
										datatype: "json",
										url: ROOT_PATH + '/main/' + transactionMain + '/save-data',
										data: objDataSend,
										beforeSend: function(req) {
											initAjaxJsonRequest(req);
								        	showLoading();
										},
										success:function(res) {
											hideLoading();
											if(res) {
												if(res.errorCode == 0) {
													$("#f-tkhai-crud").find('button[data-action="back"]').trigger('click');
												}else{
													alertDLSuccess(createObjectError(res).html(), function(){});
												}
											}else{
												alertDLSuccess('unknown error!!!', function(){});
												hideLoading();
											}
										},
										error:function (xhr, ajaxOptions, thrownError){
											alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
								            hideLoading();
								        }
									});
								},
								function(e){}
							);
						}else{
							alertDLSuccess(createObjectError(res).html(), function(){});
						}
					},
					error:function (xhr, ajaxOptions, thrownError){
						alertDLSuccess(xhr.status + " - " + xhr.responseText, function(){});
			            hideLoading();
			        }
				});
				break;

			default:
				break;
			}
			
		});
		
		$('#f-tkhai-crud #tinh-thanh').change(function (event) {
			event.preventDefault();/*event.stopPropagation();*/
			var _val = $(this).val();
			
			$('#f-tkhai-crud').find('#CQTQLy').empty();
			$('#f-tkhai-crud').find('#CQTQLy').append($("<option></option>").text('').val(''));
			
			if('' == _val || _val == undefined) return;
			$.ajax({
				type: "POST",
				datatype: "json",
				url: ROOT_PATH + '/common/get-chi-cuc-thue',
				data: {"tinhthanh_ma": _val},
				beforeSend: function(req) {
					initAjaxJsonArrayRequest(req);
				},
				success:function(res) {
					if(res && $.isArray(res)) {
						$.each(res, function(index, item) {
							$('#f-tkhai-crud').find('#CQTQLy').append(
								$("<option></option>").text(item['name']).val(item['code'])
							);
						});
					}
				},
				error:function (xhr, ajaxOptions, thrownError){
		        }
			});
		});
		
	});
	
	function setTemplateForGrid(key, data){
		if(!vIsEdit)
			return data[key] == null? '': data[key];

		var text = '';
		text = '<div class="form-row m-l-1 m-r-1">';
		switch (key) {	
		case 'HThuc':
			text += '<select class="input-grid form-control form-control-sm input-grid-feature"  name="' + key + '" style="height: 100%;" >';
			text += '<option value="1">Thêm mới</option>';
			text += '<option value="2">Gia hạn</option>';
			text += '<option value="3">Ngừng sử dụng</option>';
			text += '</select>';
			break;
		case 'TTChuc':
		case 'Seri':
		case 'TNgay':
		case 'DNgay':
			text = '<input type="text" name="' + key + '" value="' + (null == data[key]? '': data[key]) + '" class="input-grid k-input form-control form-control-sm text-right input-grid-number" >';
			 break;
		default:
			break;
		}
		text += '</div>';
		return text;
		
	
	}

	function calcAmountInGrid($obj){	
		/*LAY THONG TIN UPDATE LAI DATASOURCE*/
		var $tr = $obj.closest('tr');
		var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
		try{
			var indexRow = $tr.index();
			var rowData = objDataJson[indexRow];
			rowData['TTChuc'] = $tr.find('input[name="TTChuc"]').val();
			rowData['Seri'] = $tr.find('input[name="Seri"]').val();
			rowData['TNgay'] = $tr.find('input[name="TNgay"]').val();
			rowData['DNgay'] = $tr.find('input[name="DNgay"]').val();
			_gridSub01.data("kendoGrid").dataSource.data()[indexRow] = rowData;
		}catch(err){
			console.log(err);
		}
		
		
		
	}
	
	function getDataToSave(){
		var dataPost = {};
		
		dataPost['_id'] = $('#f-tkhai-crud').find('input[name="_id"]').val();
		dataPost['ten-nnt'] = $('#f-tkhai-crud').find('#ten-nnt').val();
		dataPost['mau-so'] = $('#f-tkhai-crud').find('#mau-so').val();
		dataPost['ten'] = $('#f-tkhai-crud').find('#ten').val();	
		dataPost['mst'] = $('#f-tkhai-crud').find('#mst').val();
		dataPost['tinh-thanh'] = $('#f-tkhai-crud').find('#tinh-thanh').val();
		dataPost['CQTQLy'] = $('#f-tkhai-crud').find('#CQTQLy').val();
		dataPost['NLHe'] = $('#f-tkhai-crud').find('#NLHe').val();
		dataPost['DCLHe'] = $('#f-tkhai-crud').find('#DCLHe').val();
		dataPost['DCTDTu'] = $('#f-tkhai-crud').find('#DCTDTu').val();
		dataPost['DTLHe'] = $('#f-tkhai-crud').find('#DTLHe').val();
		dataPost['NLap'] = $('#f-tkhai-crud').find('#NLap').val();
		dataPost['HThuc'] = $('#f-tkhai-crud').find('#HThuc').val();
		
		/*HINH THUC HOA DON*/
		dataPost['HTHDon'] = $('#f-tkhai-crud').find('input[name="optHTHDon"]:checked').val();
		/*PHƯƠNG THỨC CHUYỂN DỮ LIỆU HÓA ĐƠN ĐIỆN TỬ*/
		dataPost['PThuc'] = $('#f-tkhai-crud').find('input[name="optPThuc"]:checked').val();
		/*LOẠI HÓA ĐƠN SỬ DỤNG*/
		dataPost['CMMTT'] = $('#f-tkhai-crud').find('input[name="CMMTT"]:checked').val();
		dataPost['LHDSDung_HDGTGT'] = $('#f-tkhai-crud').find('input[name="LHDSDung_HDGTGT"]:checked').val();
		dataPost['LHDSDung_HDBHang'] = $('#f-tkhai-crud').find('input[name="LHDSDung_HDBHang"]:checked').val();
		dataPost['LHDSDung_HDBTSCong'] = $('#f-tkhai-crud').find('input[name="LHDSDung_HDBTSCong"]:checked').val();
		dataPost['LHDSDung_HDBHDTQGia'] = $('#f-tkhai-crud').find('input[name="LHDSDung_HDBHDTQGia"]:checked').val();
		dataPost['LHDSDung_HDKhac'] = $('#f-tkhai-crud').find('input[name="LHDSDung_HDKhac"]:checked').val();
		dataPost['LHDSDung_CTu'] = $('#f-tkhai-crud').find('input[name="LHDSDung_CTu"]:checked').val();
		
		var arrRows = [];
		var objDataJson = _gridSub01.data("kendoGrid").dataSource.data();
		jQuery.each(objDataJson, function(index, item) {
			item['HThuc'] = $('#f-tkhai-crud').find('#grid_cert').find('tbody[role="rowgroup"]').find('tr:eq(' + index + ')').find('select[name="HThuc"]').val();
			arrRows.push(item);
		});
		dataPost['DSCTSSDung'] = encodeObjJsonBase64UTF8(arrRows);
		console.log(arrRows)
		return dataPost;
	}
	</script>
	</div>
</div>
</html>